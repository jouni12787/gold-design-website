<!doctype html>
<html lang="en">
<head>
<script>
  // Apply saved theme ASAP (before CSS loads to avoid a flash)
  (function () {
    try {
      var KEY = 'hcj-theme';
      var saved = localStorage.getItem(KEY) || 'light';
      document.documentElement.setAttribute('data-theme', saved);
      window.__HCJ_THEME_KEY = KEY;
    } catch (e) {}
  })();
</script>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>shakaron jewelry — Store</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#17120a">
<link rel="icon" href="icon/icon-1024.png" type="image/png">
<link rel="apple-touch-icon" href="icon/icon-512.png">
<meta name="description" content="Handcrafted gold jewelry from Maison Shakaroun."/>
<meta name="application-name" content="shakaron jewelry">
<meta name="apple-mobile-web-app-title" content="shakaron jewelry">
<meta property="og:title" content="shakaron jewelry — Store">
<meta property="og:description" content="Handcrafted gold jewelry.">
<meta property="og:type" content="website">
<meta property="og:image" content="icon/icon-1024.png">
<meta property="og:site_name" content="shakaron jewelry">
<meta name="twitter:title" content="shakaron jewelry — Store">
<style>
  :root{--radius:14px;--shadow:0 18px 36px rgba(0,0,0,.45);--bar-font:clamp(.98rem,.9rem + .35vw,1.15rem);--bar-pad-y:14px;--bar-pad-x:18px;--bar-gap:12px;--bar-icon:56px;--bar-close:32px;--bar-btn-py:8px;--bar-btn-px:16px}

  html[data-theme="dark"]{
    --bg:#17120a;--bg2:#0f0b06;--card:#211a0e;--card-overlay:rgba(48,37,19,.86);
    --ink:#fff7e6;--muted:#e8d9b3;--gold:#d4af37;--gold2:#b88a1a;
    --border-soft:rgba(212,175,55,.18);--border-strong:rgba(212,175,55,.35);
    --control-border:rgba(212,175,55,.22);--control-bg:rgba(23,18,10,.75);
    --control-focus-bg:rgba(33,26,14,.85);--control-focus-shadow:rgba(212,175,55,.18);
    --head-bg:rgba(15,11,6,.45);
    --button-top:rgba(212,175,55,.16);--button-bottom:rgba(184,138,26,.16);
  }
  html:not([data-theme]), html[data-theme="light"]{
    --bg:#f6f2ea;--bg2:#e4e9f3;--card:#ffffff;--card-overlay:rgba(255,255,255,.9);
    --ink:#2b261c;--muted:#706b60;--gold:#c8892c;--gold2:#a56a18;
    --border-soft:rgba(200,137,44,.28);--border-strong:rgba(200,137,44,.45);
    --control-border:rgba(200,137,44,.34);--control-bg:rgba(250,244,234,.92);
    --control-focus-bg:rgba(255,250,243,.97);--control-focus-shadow:rgba(200,137,44,.3);
    --head-bg:rgba(242,234,220,.76);
    --button-top:rgba(200,137,44,.22);--button-bottom:rgba(165,106,24,.18);
  }
  html[data-theme="plum"]{
    --bg:#160b19;--bg2:#341844;--card:#2b1433;--card-overlay:rgba(73,35,94,.72);
    --ink:#f8ecff;--muted:#d5c0ec;--gold:#d794ff;--gold2:#b162e4;
    --border-soft:rgba(215,148,255,.32);--border-strong:rgba(215,148,255,.48);
    --control-border:rgba(215,148,255,.36);--control-bg:rgba(41,20,51,.78);
    --control-focus-bg:rgba(55,28,68,.86);--control-focus-shadow:rgba(215,148,255,.26);
    --head-bg:rgba(39,18,50,.65);
    --button-top:rgba(215,148,255,.2);--button-bottom:rgba(177,98,228,.18);
  }

  /* A2HS */
  #a2hsBanner{position:fixed;top:0;left:0;right:0;z-index:9999;transform:translateY(-110%);transition:transform .45s ease;background:color-mix(in oklab,var(--bg) 88%,transparent);color:var(--ink);border-bottom:1px solid var(--border-soft);box-shadow:0 10px 30px rgba(0,0,0,.35);font-size:var(--bar-font)}
  #a2hsBanner.show{transform:translateY(0);position:sticky;top:0}
  #a2hsBanner .wrap{display:flex;align-items:center;gap:var(--bar-gap);padding:var(--bar-pad-y) var(--bar-pad-x)}
  #a2hsBanner img.icon{width:var(--bar-icon);height:var(--bar-icon);border-radius:6px;flex:0 0 var(--bar-icon)}
  #a2hsBanner .txt{flex:1;display:flex;flex-direction:column}
  #a2hsBanner .txt .brand-title{font-weight:800;font-size:1.05em}
  #a2hsBanner .txt .brand-byline{font-weight:600;font-size:.88em;opacity:.8}
  #a2hsBanner .txt .banner-copy{font-size:.9em;opacity:.9;margin-top:2px}
  #a2hsBanner .cta{background:linear-gradient(135deg,var(--gold),var(--gold2));color:#2b1f10;border:0;border-radius:999px;padding:var(--bar-btn-py) var(--bar-btn-px);font-weight:800;cursor:pointer;font-size:1em}
  #a2hsBanner .close{background:transparent;color:var(--ink);border:0;width:var(--bar-close);height:var(--bar-close);font-size:calc(var(--bar-close)*0.56);line-height:var(--bar-close);cursor:pointer;flex:0 0 var(--bar-close)}

  #a2hsModal{position:fixed;inset:0;z-index:10001;display:none;align-items:center;justify-content:center;padding:24px 12px}
  #a2hsModal.open{display:flex}
  #a2hsModal::before{content:"";position:absolute;inset:0;background:rgba(0,0,0,.6)}
  #a2hsModal .sheet{position:relative;width:min(560px,92vw);max-height:calc(100vh - 48px);overflow:auto;background:color-mix(in oklab,var(--bg) 86%,transparent);color:var(--ink);border:1px solid var(--border-soft);border-radius:16px;padding:16px;box-shadow:0 20px 50px rgba(0,0,0,.65)}
  #a2hsModal .steps{margin-top:6px;font-size:14px;line-height:1.7}
  #a2hsModal .steps .row{display:flex;gap:10px;margin:6px 0;flex-direction:column}
  #a2hsModal .stepimg{display:block;width:100%;height:auto;margin-top:8px;border-radius:10px;border:1px solid var(--border-soft)}
  #a2hsModal .x{position:absolute;top:8px;left:10px;background:transparent;border:0;color:var(--ink);font-size:20px;cursor:pointer}

  *{box-sizing:border-box}
  body{margin:0;color:var(--ink);background:linear-gradient(160deg, var(--bg) 0%, var(--bg2) 100%);font:15.5px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial}

  .topbar{position:sticky;top:0;z-index:80;background:var(--head-bg);backdrop-filter:saturate(1.25) blur(10px);border-bottom:1px solid var(--border-soft)}
  .topbar .wrap{max-width:1240px;margin:0 auto;padding:12px 18px;display:flex;align-items:center;gap:14px}
  .topbar .brand{display:flex;align-items:center;gap:12px;text-decoration:none;color:var(--ink)}
  .topbar .brand img{width:40px;height:40px;border-radius:10px;box-shadow:0 8px 18px rgba(0,0,0,.35)}
  .topbar .brand .brand-stack{display:flex;flex-direction:column;line-height:1.05}
  .topbar .brand .brand-title{font-weight:800;letter-spacing:.42px;font-size:17px}
  .topbar .brand .brand-byline{font-weight:600;font-size:11px;opacity:.75;text-transform:uppercase;letter-spacing:.6px}
  .topbar .nav{margin-left:auto;display:flex;gap:12px;align-items:center;flex-wrap:nowrap;overflow-x:auto;padding-bottom:4px;scrollbar-width:none;-webkit-overflow-scrolling:touch}
  .topbar .nav::-webkit-scrollbar{display:none}
  .topbar .nav a{color:var(--ink);text-decoration:none;border:1px solid var(--border-soft);padding:9px 14px;border-radius:999px;font-size:13px;font-weight:600;letter-spacing:.04em;transition:border .2s,color .2s,background .2s;flex:0 0 auto;white-space:nowrap}
  .topbar .nav a:hover{border-color:var(--gold);color:var(--ink);background:color-mix(in oklab,var(--gold) 16%,transparent)}
  .topbar .nav a[aria-current="page"]{border-color:var(--gold);color:var(--gold);background:color-mix(in oklab,var(--gold) 18%,transparent)}
  .topbar .nav select{border:1px solid var(--border-soft);background:var(--control-bg);color:var(--ink);padding:8px 12px;border-radius:999px;font-size:13px;font-weight:600}

  .store-wrap{max-width:1100px;margin:0 auto;padding:32px 18px 64px;display:grid;gap:24px}
  .card{background:linear-gradient(160deg,var(--card-overlay),var(--card));border:1px solid var(--border-soft);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden}
  .head{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:18px 20px;border-bottom:1px solid var(--border-soft);background:color-mix(in oklab,var(--bg) 8%, transparent)}
  .head h1{margin:0;font-size:22px}
  .badge{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;border:1px solid var(--border-soft);font-size:12px;color:var(--muted);background:var(--control-bg)}
  .panel{padding:20px}

  #storeList{display:grid;gap:20px;min-height:120px}
  .store-item{display:grid;grid-template-columns:minmax(0,200px) minmax(0,1fr);gap:20px;align-items:start;padding:20px}
  .store-item__thumb{position:relative;border-radius:18px;border:1px solid var(--border-soft);overflow:hidden;background:var(--bg2);aspect-ratio:1/1;display:flex;align-items:center;justify-content:center}
  .store-item__thumb img{width:100%;height:100%;object-fit:cover;transition:transform .35s ease}
  /* -------------------------
   SIMPLE HOVER + TOUCH ZOOM
   ------------------------- */

/* For product thumbnails */
.store-item__thumb {
  overflow: hidden;
  position: relative;
}

.store-item__thumb img {
  transition: transform 0.35s ease;
  transform-origin: center center;
  will-change: transform;
}

.store-item__thumb:hover img,
.store-item__thumb:active img {
  transform: scale(1.2);
}

/* For Quick View image */
.hcj-zoom img {
  transition: transform 0.35s ease;
  transform-origin: center center;
  will-change: transform;
}

.hcj-zoom:hover img,
.hcj-zoom:active img {
  transform: scale(3);
}

/* Optional: nicer cursors when panning */
.hcj-zoom { cursor: zoom-in; }
.hcj-zoom.is-zoomed { cursor: move; }

  .store-item__placeholder{width:100%;height:100%;background:linear-gradient(135deg,color-mix(in oklab,var(--bg2) 80%, transparent),color-mix(in oklab,var(--bg) 70%, transparent))}
  .store-item__body{display:grid;gap:14px}
  .store-item__header{display:flex;align-items:flex-start;justify-content:space-between;gap:12px}
  .store-item__title{margin:0;font-size:1.2rem;font-weight:700;line-height:1.3;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
  .store-item__price{font-size:1.15rem;font-weight:800;color:var(--gold);white-space:nowrap}
  .store-item__currency{font-size:.8em;color:var(--muted);font-weight:600;margin-left:4px}
  .store-item__description{margin:0;color:color-mix(in oklab,var(--ink) 84%, transparent);font-size:.98rem}
  .store-item__meta{display:flex;gap:12px;flex-wrap:wrap;align-items:center;font-size:12px;color:var(--muted)}
  .store-item__badge{display:inline-flex;align-items:center;justify-content:center;padding:4px 10px;border-radius:999px;border:1px solid var(--border-soft);background:var(--control-bg);font-weight:600;line-height:1}
  .store-item__badge--stock{color:var(--gold)}
  .store-item__actions{display:flex;flex-wrap:wrap;gap:10px;align-items:center}

  @media (max-width:840px){
    .store-item{grid-template-columns:minmax(0,160px) minmax(0,1fr)}
  }
  @media (max-width:720px){
    .store-item{grid-template-columns:1fr}
    .store-item__thumb{aspect-ratio:4/3}
    .store-item__header{flex-direction:column;align-items:flex-start}
  }
  @media (max-width:520px){
    .topbar .nav a{padding:8px 12px;font-size:12px}
    .panel{padding:18px}
    .store-item{padding:18px}
  }
  @media (max-width:420px){
    .store-wrap{padding:28px 16px 48px}
  }
  @media (max-width:380px){
    .topbar .nav a{padding:8px 10px;font-size:11.5px}
  }

  /* ===== Category chips, live pricing & mini-cart ===== */
  .cat{display:inline-flex;align-items:center;gap:10px;padding:12px;border-radius:12px;border:1px solid var(--border-soft);
    background:var(--card);cursor:pointer;transition:border .2s,box-shadow .2s,transform .2s;font-weight:700}
  .cat:hover{transform:translateY(-1px);border-color:var(--gold)}
  .cat.active{border-color:var(--gold);box-shadow:0 4px 12px rgba(0,0,0,.12)}
  .cat img{width:40px;height:40px;border-radius:8px;object-fit:cover}
  #catBar{display:flex;flex-wrap:wrap;gap:12px}
  #catBar.open{display:flex}
  .cat-toggle{display:none;margin-bottom:12px;border:1px solid var(--border-soft);background:var(--control-bg);
    color:var(--ink);border-radius:999px;padding:10px 16px;font-weight:700;cursor:pointer}
  .live-badges{display:flex;gap:10px;padding:10px 0;flex-wrap:wrap}
  .pill{padding:6px 10px;border-radius:999px;background:var(--control-bg);border:1px solid var(--border-soft);font-weight:700}
  /* make live price pills behave like buttons and show selected state */
  #liveBadges button.pill{ cursor:pointer }
  #liveBadges .pill.active{
    border-color: var(--gold);
    color: var(--gold);
    box-shadow: 0 2px 12px rgba(0,0,0,.15);
  }

  /* large zoom box shown when Magnifier is on (desktop/tablet) */
  .hcj-zoombox{
    border:1px solid var(--border-soft);
    border-radius:14px;
    background:#000;
    background-repeat:no-repeat;
    background-position:center;
    background-size:220%;
    display:none;
    min-height:280px;
  }
  @media (max-width:900px){ .hcj-zoombox{ display:none !important; } }
  .cat-meta{margin-top:8px;font-size:.95rem;color:var(--muted)}
  .product-card{position:relative}
  .product-card .mini-cart{position:absolute;left:12px;bottom:12px;width:42px;height:42px;border-radius:999px;
    display:grid;place-items:center;border:0;background:var(--card);box-shadow:0 6px 16px rgba(0,0,0,.18);cursor:pointer;
    transition:background .2s}
  .product-card .mini-cart:hover{background:color-mix(in oklab,var(--gold) 18%, var(--card))}
  .mag-lens{position:absolute;left:0;top:0;pointer-events:none;border-radius:50%;border:2px solid rgba(255,255,255,.85);
    box-shadow:0 6px 18px rgba(0,0,0,.35);display:none;will-change:transform, background-position}
  .lightbox{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.6);z-index:1200}
  .lightbox.open{display:flex}
  .lightbox .frame{max-width:min(92vw,900px);max-height:min(92vh,720px);width:100%;height:auto;aspect-ratio:4/3;background:#000;
    border-radius:12px;overflow:hidden;display:flex;align-items:center;justify-content:center;padding:0}
  .lightbox img{max-width:100%;max-height:100%;object-fit:contain}
  @media (max-width:740px){
    #catBar{display:none}
    .cat-toggle{display:inline-flex;align-items:center;gap:8px}
  }

  .hcj-qv{position:fixed;inset:0;z-index:1000;display:none;align-items:center;justify-content:center}
  .hcj-qv[aria-hidden="false"]{display:flex}
  .hcj-qv::before{content:"";position:absolute;inset:0;background:rgba(0,0,0,.6)}
  .hcj-qv__sheet{position:relative;width:min(1000px,94vw);background:var(--card);border:1px solid var(--border-soft);
    border-radius:18px;box-shadow:var(--shadow);padding:14px}
  .hcj-qv__close{position:absolute;top:10px;left:12px;background:transparent;border:0;color:var(--ink);font-size:22px;cursor:pointer}
  .hcj-qv__grid{display:grid;gap:16px;grid-template-columns:1.1fr 1fr}
  @media (max-width:900px){.hcj-qv__grid{grid-template-columns:1fr}}
  .hcj-qv__media{display:grid;gap:10px}
  .hcj-qv__thumbs{display:flex;gap:8px;flex-wrap:wrap}
  .hcj-qv__thumbs img{width:56px;height:56px;object-fit:cover;border-radius:10px;border:1px solid var(--border-soft);cursor:pointer}
  .hcj-qv__thumbs img.is-active{outline:2px solid var(--gold)}
  .hcj-qv__meta{display:grid;gap:12px}
  .hcj-qv__price{font-size:1.5rem;font-weight:900;color:var(--gold)}
  .hcj-qv__specs{display:flex;gap:10px;flex-wrap:wrap;color:var(--muted);font-size:.95rem}
  .hcj-btn{border:1px solid var(--border-strong);background:linear-gradient(120deg,var(--button-top),var(--button-bottom));
    color:var(--ink);padding:10px 14px;border-radius:12px;font-weight:800;cursor:pointer}
  .hcj-btn.ghost{background:transparent}
  .hcj-btn.block{width:100%}

  .hcj-zoom{position:relative;border:1px solid var(--border-soft);border-radius:14px;overflow:hidden;background:var(--bg2)}
  .hcj-zoom img{display:block;width:100%;height:auto}
  .hcj-lens{position:absolute;width:130px;height:130px;border:1px solid var(--border-strong);border-radius:999px;
    background-repeat:no-repeat;background-position:center;background-size:200%;display:none;box-shadow:0 8px 22px rgba(0,0,0,.35)}

  /* ==== VIEW MODES ==== */
  .view-list #storeList{ grid-template-columns: 1fr; }
  .view-tiles #storeList{
    grid-template-columns: repeat(2,minmax(0,1fr));
    gap: 14px;
  }

  /* make each card act like a small tile in tiles mode */
  .view-tiles .store-item{
    display: block;
    padding: 12px;
  }
  .view-tiles .store-item__thumb{ aspect-ratio: 1/1; }
  .view-tiles .store-item__body{ display: grid; gap: 8px; }
  .view-tiles .store-item__title{ font-size: 1rem; -webkit-line-clamp: 1; }
  .view-tiles .store-item__price{ font-size: 1rem; }
  .view-tiles .store-item__description{ display:none; }
  .view-tiles .store-item__meta{ font-size:.8rem; gap:8px }
  .view-tiles .product-card .mini-cart{top:12px;right:12px;left:auto;bottom:auto;z-index:2}

  #viewToggleWrap button[aria-pressed="true"]{
    border-color: var(--gold);
    color: var(--gold);
    background: color-mix(in oklab,var(--gold) 15%, transparent);
  }

  /* phone-first safety: never overflow the viewport */
  img, video { max-width: 100%; height: auto; }

  /* ==== Quick View: keep inside phone frame ==== */
  .hcj-qv__sheet{ width:min(680px,96vw); max-height:92vh; overflow:auto; }
  @media (max-width: 720px){
    .hcj-qv__grid{ grid-template-columns: 1fr; }
    .hcj-zoom{ max-height: 52vh; }
  }

  /* ensure the big image in Quick View never exceeds frame */
  .hcj-zoom{ max-height: 60vh; overflow:hidden; }
  .hcj-zoom img{ width:100%; height:auto; object-fit:contain; }

  @media (max-width:720px){
    .store-item{ padding:14px }
    .store-item__thumb{ border-radius:14px }
  }

  .hcj-cart{position:fixed;right:0;top:0;bottom:0;width:min(380px,92vw);transform:translateX(110%);transition:transform .35s ease;
    background:var(--card);border-left:1px solid var(--border-soft);box-shadow:-8px 0 30px rgba(0,0,0,.35);z-index:1001;display:flex;flex-direction:column}
  .hcj-cart[aria-hidden="false"]{transform:none}
  .hcj-cart__head{display:flex;justify-content:space-between;align-items:center;padding:14px 16px;border-bottom:1px solid var(--border-soft)}
  .hcj-cart__close{background:transparent;border:0;color:var(--ink);font-size:20px;cursor:pointer}
  .hcj-cart__body{padding:12px 14px;display:grid;gap:10px;overflow:auto}
  .hcj-item{display:grid;grid-template-columns:58px 1fr auto;gap:10px;align-items:center;border:1px solid var(--border-soft);border-radius:12px;padding:8px}
  .hcj-item img{width:58px;height:58px;object-fit:cover;border-radius:10px}
  .hcj-item .t{font-weight:700}
  .hcj-item .s{font-size:.85rem;color:var(--muted)}
  .hcj-item .p{font-weight:800;color:var(--gold)}
  .hcj-cart__foot{margin-top:auto;border-top:1px solid var(--border-soft);padding:12px 14px;display:grid;gap:10px}
  .hcj-cart__row{display:flex;justify-content:space-between;align-items:center}

  /* === Try-On modal === */
  #tryon-modal[hidden]{display:none}
  .tryon-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.6);display:grid;place-items:center;z-index:9999;padding:16px}
  .tryon-panel{width:min(960px,96vw);background:#111;color:#fff;border-radius:16px;overflow:hidden;box-shadow:0 10px 40px rgba(0,0,0,.5);display:flex;flex-direction:column}
  .tryon-head{display:flex;justify-content:space-between;align-items:center;padding:10px 14px;background:#1c1c1c}
  .tryon-head button{font-size:22px;line-height:1;background:none;color:#fff;border:0;cursor:pointer;padding:4px}
  .tryon-stage{position:relative;width:100%;aspect-ratio:9/16;background:#000;overflow:hidden}
  #tryon-video,.uploaded-photo{position:absolute;inset:0;width:100%;height:100%;object-fit:cover}
  .ring-overlay{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%) scale(1) rotate(0deg);touch-action:none;cursor:grab;user-select:none}
  .ring-overlay:active{cursor:grabbing}
  .ring-overlay img{display:block;width:280px;height:auto;pointer-events:none}
  .tryon-controls{display:grid;grid-template-columns:1fr 1fr auto auto;gap:12px;padding:12px;background:#1a1a1a;align-items:center}
  .tryon-controls label{display:flex;gap:10px;align-items:center;font-weight:600;font-size:.95rem}
  .tryon-controls input[type="range"]{flex:1}
  .upload-fallback span{display:inline-block;padding:8px 12px;background:#333;border-radius:8px;cursor:pointer;font-weight:600}
  .btn.try-on-btn{padding:6px 10px;border-radius:8px;border:1px solid var(--border-soft);background:var(--control-bg);color:var(--ink);font-weight:700;cursor:pointer;transition:background .2s,border .2s,transform .2s}
  .btn.try-on-btn:hover{border-color:var(--gold);background:color-mix(in oklab,var(--gold) 18%, transparent);transform:translateY(-1px)}
</style>
</head>
<body>
<!-- A2HS Banner -->
<div id="a2hsBanner" aria-hidden="true">
  <div class="wrap" style="max-width:1100px;margin:0 auto;padding:0 16px;">
    <button class="close" type="button" aria-label="Close" data-i18n-attr="aria-label:common.close">×</button>
   <img class="icon" src="icon/icon-512.png" alt="shakaron jewelry icon" data-i18n-attr="alt:brand.logoAlt">
    <div class="txt">
      <div class="brand-title" data-i18n="brand.title">shakaron jewelry</div>
      <div class="brand-byline" data-i18n="brand.byline">shakaron jewelry</div>
      <div class="banner-copy" data-i18n="a2hs.banner">Add it to your Home Screen.</div>
    </div>
    <button class="cta" type="button" id="a2hsGet" data-i18n="a2hs.install">Install</button>
  </div>
</div>

<!-- iOS Guide -->
<div id="a2hsModal" aria-hidden="true">
  <div class="sheet" role="dialog" aria-modal="true" aria-labelledby="a2hsTitle">
    <button class="x" type="button" aria-label="Close" data-i18n-attr="aria-label:common.close">×</button>
    <h3 id="a2hsTitle" data-i18n="a2hs.title">Add “shakaron jewelry” to Home Screen</h3>
    <div class="steps">
      <div class="row">
        <div><strong>1.</strong> <span data-i18n="a2hs.step1">Tap <em>Share</em> in Safari.</span></div>
        <img class="stepimg" src="./icon/share.jpg" alt="iPhone Share button screenshot">
      </div>
      <div class="row">
        <div><strong>2.</strong> <span data-i18n="a2hs.step2">Choose <em>Add to Home Screen</em>, then <em>Add</em>.</span></div>
        <img class="stepimg" src="./icon/save%20to%20home%20screen.jpeg" alt="Add to Home Screen screenshot">
      </div>
    </div>
  </div>
</div>

<header class="topbar">
  <div class="wrap">
  <a class="brand" href="index.html" aria-label="shakaron jewelry" data-i18n-attr="aria-label:brand.aria">
      <img src="icon/icon-512.png" alt="shakaron jewelry logo" data-i18n-attr="alt:brand.logoAlt">
      <span class="brand-stack">
        <span class="brand-title" data-i18n="brand.title">shakaron jewelry</span>
        <small class="brand-byline" data-i18n="brand.byline">shakaron jewelry</small>
      </span>
    </a>
    <nav class="nav">
      <a href="index.html" data-i18n="nav.builder">Builder</a>
      <a href="store.html" aria-current="page" data-i18n="nav.store">Store</a>
      <a href="about.html" data-i18n="nav.about">About</a>
      <select id="themeSelectTop" aria-label="Select theme" data-i18n-attr="aria-label:common.theme.select">
        <option value="dark" data-i18n="theme.dark">Dark</option>
        <option value="light" data-i18n="theme.light">Light</option>
        <option value="plum" data-i18n="theme.plum">Plum</option>
        <option value="custom" data-i18n="theme.custom">Custom</option>
      </select>
      <select id="langSelectTop" aria-label="Select language">
        <option value="en">English</option>
        <option value="ar">العربية</option>
        <option value="fr">Français</option>
        <option value="it">Italiano</option>
      </select>
    </nav>
  </div>
</header>

<main class="store-wrap">
  <!-- Categories & Gold board -->
  <section class="card" id="hcjCatsCard" aria-label="Categories">
    <div class="head">
      <h1 style="margin:0;font-size:20px">Categories · الفئات</h1>
      <span class="badge" id="hcjCatsCount">11</span>
    </div>
    <div class="panel">
      <button id="catToggle" class="cat-toggle" type="button">Categories · الفئات</button>
      <div id="catBar" class="cat-bar" role="listbox" aria-label="Jewelry categories"></div>
      <div id="liveBadges" class="live-badges" aria-live="polite"></div>
      <div id="catMeta" class="cat-meta" aria-live="polite"></div>
    </div>
  </section>

  <section class="card">
    <div class="head">
      <h1 data-i18n="store.title">Store</h1>
      <span class="badge" data-i18n="store.badge">Atelier selections</span>
    </div>
    <div class="panel" style="padding-top:10px;padding-bottom:0">
      <div id="viewToggleWrap" style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
        <span class="badge">Display</span>
        <button id="viewListBtn"  class="hcj-btn ghost" type="button">List</button>
        <button id="viewTilesBtn" class="hcj-btn ghost" type="button">Tiles</button>
      </div>
    </div>
    <div class="panel" id="storeList" data-i18n="store.loading" aria-live="polite">Loading…</div>
  </section>
</main>

<!-- Quick View (with magnifier) -->
<div class="hcj-qv" id="hcjQV" aria-hidden="true">
  <div class="hcj-qv__sheet" role="dialog" aria-modal="true" aria-labelledby="hcjQVTitle">
    <button class="hcj-qv__close" type="button" aria-label="Close">×</button>
    <div class="hcj-qv__grid">
      <div class="hcj-qv__media">
        <div class="hcj-zoom" id="hcjZoom">
          <img id="hcjZoomImg" alt="">
          <div class="hcj-lens" id="hcjLens" aria-hidden="true"></div>
        </div>
        <div class="hcj-qv__thumbs" id="hcjQVThumbs"></div>
      </div>
      <div class="hcj-qv__meta">
        <h3 id="hcjQVTitle"></h3>
        <div class="hcj-qv__price"><span id="hcjQVPrice"></span> <small>USD</small></div>
        <div class="hcj-qv__specs" id="hcjQVSpecs"></div>
        <p id="hcjQVDesc" class="store-item__description" style="margin-top:4px;"></p>
        <div class="hcj-qv__actions">
          <button id="hcjAddCartQV" class="hcj-btn">Add to cart</button>
          <a id="hcjWA" class="hcj-btn ghost" target="_blank" rel="noopener">WhatsApp Cart</a>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Slide-in Cart Drawer -->
<aside class="hcj-cart" id="hcjCart" aria-hidden="true">
  <div class="hcj-cart__head">
    <strong>Shopping cart</strong>
    <button class="hcj-cart__close" type="button" aria-label="Close">×</button>
  </div>
  <div class="hcj-cart__body" id="hcjCartBody"></div>
  <div class="hcj-cart__foot">
    <div class="hcj-cart__row">
      <span>Subtotal</span><strong id="hcjSub">$0</strong>
    </div>
    <button id="hcjCheckout" class="hcj-btn block">Checkout</button>
  </div>
</aside>

<!-- Try-On Modal -->
<div id="tryon-modal" hidden class="tryon-backdrop">
  <div class="tryon-panel">
    <header class="tryon-head">
      <strong>Virtual Try-On</strong>
      <button id="tryon-close" aria-label="Close">&times;</button>
    </header>

    <div class="tryon-stage">
      <!-- Background photo (user-taken or uploaded) -->
      <img id="bg-photo" class="uploaded-photo" alt="">
      <div id="ring-overlay" class="ring-overlay" draggable="false">
        <img id="ring-image" alt="Ring overlay" />
      </div>
    </div>

    <div class="tryon-controls">
      <label>Size
        <input id="sizeRange" type="range" min="0.2" max="3" step="0.01" value="1">
      </label>
      <label>Rotate
        <input id="rotateRange" type="range" min="-90" max="90" step="1" value="0">
      </label>

      <!-- Take a new photo (opens camera on mobile) -->
      <label class="upload-fallback">
        <input id="photoCapture" type="file" accept="image/*" capture="environment" hidden>
        <span>Take photo</span>
      </label>

      <!-- Or upload from gallery/files -->
      <label class="upload-fallback">
        <input id="photoUpload" type="file" accept="image/*" hidden>
        <span>Upload photo</span>
      </label>
    </div>
  </div>
</div>

<script src="scripts/a2hs.js"></script>
<script src="scripts/translations.js"></script>
<script>
(function () {
  const SHEET_ID = "1zHRWiXCF_SldNShxN_KEEcdhry86JZu61gC3gN6slTk";
  const SHEET_NAME = "Form Responses 1";
  const TQ = encodeURIComponent("select A,B,C,D,E,F,G,H,I,J");
  const URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=${encodeURIComponent(SHEET_NAME)}&tqx=out:json&tq=${TQ}`;

  const out = document.getElementById("storeList");
  const TRY_ON_COL_HEADER = 'jpg FILE FOR online trying';

  function driveShareToDirect(url){
    if(!url) return '';
    try {
      const u = new URL(String(url).trim());
      const matchPath = u.pathname.match(/\/d\/([a-zA-Z0-9_-]+)/);
      const matchQuery = u.search.match(/[?&]id=([a-zA-Z0-9_-]+)/);
      const id = (matchPath && matchPath[1]) || (matchQuery && matchQuery[1]);
      return id ? `https://drive.google.com/uc?export=view&id=${id}` : url;
    } catch (err) {
      return url;
    }
  }
  window.driveShareToDirect = driveShareToDirect;

  const CATS = {
    all:      { en:"All",         ar:"الكل",           icon:"icon/all.jpg" },
    anklet:   { en:"Anklet",      ar:"خلخال",          icon:"icon/anklet.jpg" },
    bangle:   { en:"Bangle",      ar:"سوار دائري",     icon:"icon/bangle.jpg" },
    brooch:   { en:"Brooch",      ar:"بروش",           icon:"icon/brooch.jpg" },
    chain:    { en:"Chain",       ar:"سلسلة",          icon:"icon/chain.jpg" },
    earrings: { en:"Earrings",    ar:"قرط",            icon:"icon/earrings.jpg" },
    set:      { en:"Jewelry set", ar:"طقم مجوهرات",    icon:"icon/jewelry set.jpg" },
    kids:     { en:"Kids",        ar:"ولادي",          icon:"icon/kids.jpg" },
    necklace: { en:"Necklace",    ar:"قلادة",          icon:"icon/necklace.jpg" },
    pendant:  { en:"Pendant",     ar:"تعليقة",         icon:"icon/pendant.jpg" },
    ring:     { en:"Ring",        ar:"خاتم",           icon:"icon/ring.jpg" },
    special:  { en:"Special",     ar:"مميز",           icon:"icon/special.jpg" }
  };

  window.HCJ = window.HCJ || {};
  window.HCJ.CATS = CATS;

  function catIdFromName(raw){
    if(!raw) return "special";
    const s = String(raw).toLowerCase();
    if(s.includes("earring") || s.includes("قرط")) return "earrings";
    if(s.includes("ring") || s.includes("خاتم")) return "ring";
    if(s.includes("necklace") || s.includes("قلادة")) return "necklace";
    if(s.includes("pendant") || s.includes("تعليقة")) return "pendant";
    if(s.includes("bangle") || s.includes("سوار")) return "bangle";
    if(s.includes("ankle") || s.includes("خلخال")) return "anklet";
    if(s.includes("chain") || s.includes("سلسلة")) return "chain";
    if(s.includes("brooch") || s.includes("بروش")) return "brooch";
    if(s.includes("jewelry set") || s.includes("طقم")) return "set";
    if(s.includes("ولادي") || s.includes("kids")) return "kids";
    if(s.includes("special") || s.includes("مميز")) return "special";
    return "special";
  }

  window.HCJ.catIdFromName = catIdFromName;

  let __t = (key, vars) => {
    const lang = document.documentElement.lang || 'en';
    const dict = window.__TRANSLATIONS?.[lang] || {};
    const fallback = window.__TRANSLATIONS?.en || {};
    let value = dict[key];
    if(value == null) value = fallback[key];
    if(value == null) value = key;
    if(typeof value === 'string' && vars && typeof vars === 'object'){
      value = value.replace(/\{\{(\w+)\}\}/g, (_, name) => (vars[name] ?? ''));
    }
    return value;
  };

  function syncTranslator(){
    const lang = document.documentElement.lang || 'en';
    __t = (key, vars)=>{
      const dict = window.__TRANSLATIONS?.[lang] || {};
      const fallback = window.__TRANSLATIONS?.en || {};
      let value = dict[key];
      if(value == null) value = fallback[key];
      if(value == null) value = key;
      if(typeof value === 'string' && vars && typeof vars === 'object'){
        value = value.replace(/\{\{(\w+)\}\}/g, (_, name) => (vars[name] ?? ''));
      }
      return value;
    };
  }
  let lastProducts = [];
  let lastStatus = 'loading';

  syncTranslator();

  window.addEventListener('DOMContentLoaded', syncTranslator);
  window.addEventListener('hcj:lang', ()=>{
    syncTranslator();
    if(!out) return;
    if(lastStatus === 'products'){
      render(lastProducts);
    }else if(lastStatus === 'empty'){
      out.removeAttribute('data-i18n');
      out.innerHTML = `<span class="badge">${__t('store.empty')}</span>`;
    }else if(lastStatus === 'error'){
      out.removeAttribute('data-i18n');
      out.innerHTML = `<span class="badge">${__t('store.loadFail')}</span>`;
    }else{
      out.setAttribute('data-i18n', 'store.loading');
      out.textContent = __t('store.loading') || out.textContent;
    }
  });

  /* ================== Live gold pricing (every 10s) ================== */
  // Endpoints (free) – we’ll race them for speed:
  const GOLDAPI_FREE = [
    "https://api.gold-api.com/price/XAU",
    "https://api.gold-api.com/price/XAU/USD",
    "https://www.gold-api.com/price/XAU",
    "https://www.gold-api.com/price/XAU/USD"
  ];

  // Pull the ounce price from whatever shape the API returns
  function pickOuncePrice(d){
    const c = [d?.price, d?.usd, d?.usd_ounce, d?.price_ounce, d?.ounce, d?.oz,
               d?.result?.price, d?.XAU?.USD].map(Number).filter(v => isFinite(v) && v > 0);
    if (c.length) return c[0];
    // If only gram(24k) is given, convert to ounce (≈31.1)
    const g24 = Number(d?.gram_24k || d?.price_gram_24k || d?.g24 || d?.per_gram);
    return (isFinite(g24) && g24 > 0) ? g24 * 31.1 : NaN;
  }
  function timeoutFetch(u,ms){
    const c = new AbortController(); const id = setTimeout(() => c.abort(), ms);
    return fetch(u,{signal:c.signal,cache:"no-store"}).finally(() => clearTimeout(id));
  }
  async function getSpotFast(){
    const tries = GOLDAPI_FREE.map(u =>
      timeoutFetch(u,3500)
        .then(r => r.ok ? r.json() : Promise.reject(r.status))
        .then(pickOuncePrice)
        .then(v => (isFinite(v) && v > 0) ? v : Promise.reject("bad"))
    );
    return Promise.any(tries);
  }

  // 18k: ((oz + 30)*32*750/995) + fee
  // 21k: ((oz + 30)*32*875/995) + fee
  // 22k: ((oz + 30)*32*916/995) + fee
  // 24k: ((oz + 30)/31.1)       + fee
  function perGramForKirat(oz, kiratStr, fee){
    const k   = String(kiratStr || "").toLowerCase();
    const add = Number.isFinite(fee) ? fee : 10; // fallback to 10 if the sheet cell is empty
    if (/\b18\b/.test(k)) return (((oz + 30) * 32 * 750 / 995)/1000) + add;
    if (/\b21\b/.test(k)) return (((oz + 30) * 32 * 875 / 995)/1000) + add;
    if (/\b22\b/.test(k)) return (((oz + 30) * 32 * 916 / 995)/1000) + add;
    if (/\b24\b/.test(k)) return ((oz + 30) / 31.1) + add;
    return NaN;
  }

  window.HCJ.getSpotOz = getSpotFast;
  window.HCJ.perGramForKirat = perGramForKirat;

  function computeItemPriceUSD(oz, product){
    const w   = toNum(product.weight);
    if (!Number.isFinite(w) || w <= 0) return NaN;
    const fee = toNum(product.fee);      // ← “أجور + ربح ex.2.5” (per gram) from column H
    const ppg = perGramForKirat(oz, product.kirat, fee);
    return Number.isFinite(ppg) ? (ppg * w) : NaN;
  }

  // Start a 10s refresh loop to update prices in-place
  const REFRESH_MS = 10_000;
  let _priceTimer = null;
  function startSpotRefresh(products){
    async function tick(){
      try{
        const oz = await getSpotFast();

        // --- NEW: keep a single global snapshot with ounce, grams & timestamp
        window.__HCJ_SPOT = {
          oz,
          g18: Math.round(perGramForKirat(oz,'18',10)),
          g21: Math.round(perGramForKirat(oz,'21',10)),
          g22: Math.round(perGramForKirat(oz,'22',10)),
          g24: Math.round(perGramForKirat(oz,'24',10)),
          updatedAt: Date.now()
        };
        window.dispatchEvent(new CustomEvent('hcj:spot-update', { detail: window.__HCJ_SPOT }));

        // Recompute each product price from kirat/weight/fee
        products.forEach(p => {
          const calc = computeItemPriceUSD(oz, p);
          if (isFinite(calc)) p.price = Math.round(calc);
        });

        // Render/update
        if(!document.querySelector('.product-card')){
          render(products);
        }else if(typeof updatePricesInPlace === 'function'){
          updatePricesInPlace(products);
          document.dispatchEvent(new CustomEvent('hcj:prices-updated', { detail: { products } }));
        }
      }catch(_){
        /* keep current UI if a fetch fails */
      }
    }
    // run now + schedule
    tick();
    if (_priceTimer) clearInterval(_priceTimer);
    _priceTimer = setInterval(tick, REFRESH_MS);
  }

  const ESCAPE = {"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"};
  function escapeHtml(value){
    return String(value == null ? "" : value).replace(/[&<>"']/g, function(ch){ return ESCAPE[ch] || ch; });
  }
  function sentenceCase(str){
    const trimmed = String(str == null ? "" : str).trim();
    if(!trimmed){ return ""; }
    if(trimmed === trimmed.toUpperCase()){
      const lower = trimmed.toLowerCase();
      return lower.charAt(0).toUpperCase() + lower.slice(1);
    }
    if(trimmed === trimmed.toLowerCase()){
      return trimmed.charAt(0).toUpperCase() + trimmed.slice(1);
    }
    return trimmed.charAt(0).toUpperCase() + trimmed.slice(1);
  }
  // Split a cell that may contain multiple links (comma, semicolon, or newline)
  function splitLinks(value){
    if (!value) return [];
    // If GViz gave an <a href> chip, pull its href and return as a single-item array
    const str = String(value).trim();
    const hrefMatch = str.match(/href="([^"]+)"/i);
    if (hrefMatch) return [hrefMatch[1]];

    // Otherwise, split on commas/semicolons/newlines and trim
    return str.split(/[\n,;]+/).map(s => s.trim()).filter(Boolean);
  }

  // Convert Drive links (open?id=... or /file/d/ID/...) -> direct image URLs
  function driveImages(value){
    const links = Array.isArray(value) ? value : splitLinks(value);
    return links.map(link => {
      // accept both /file/d/ID and ...?id=ID
      const m = link.match(/\/d\/([a-zA-Z0-9_-]+)/) || link.match(/[?&]id=([^&]+)/);
      const id = m ? m[1] : null;
      if (!id) return link; // if it's not Drive, use as-is
      // fast thumbnail endpoint that works in <img>
      return `https://lh3.googleusercontent.com/d/${id}=w1200`;
    });
  }
  function money(n) {
    const v = Number(n);
    return Number.isFinite(v) ? v.toLocaleString(undefined, {minimumFractionDigits:0}) : "";
  }

  // Parses "2.5" or "2,5" into a Number. Returns NaN if not numeric.
  function toNum(v){
    const s = String(v ?? "").trim()
      // Arabic decimal comma -> dot
      .replace(",", ".")
      // strip everything except digits, minus, and dot
      .replace(/[^\d.-]/g, "");
    const n = parseFloat(s);
    return Number.isFinite(n) ? n : NaN;
  }

  function render(products) {
    if(!out) return;
    window.PRODUCTS = products;
    out.removeAttribute('data-i18n');
    if (!products.length) {
      lastProducts = products;
      lastStatus = 'empty';
      out.innerHTML = `<span class="badge">${__t('store.empty')}</span>`;
      return;
    }
    lastProducts = products;
    lastStatus = 'products';
    const cards = products.map((p, i) => {
      const title = sentenceCase(p.name || "");
      const safeTitle = escapeHtml(title);
      const photos = Array.isArray(p.images) && p.images.length ? p.images : driveImages(p.photo);
      const main   = p.thumb || photos[0] || "";
      const price = money(p.price);
      const priceNum = Number(p.price) || 0;
      const description = escapeHtml(p.description || "");
      const kirat = p.kirat ? `<span>${__t('store.karat')} ${escapeHtml(p.kirat)}</span>` : "";
      const sku = p.sku ? `<span>${__t('store.sku')} ${escapeHtml(p.sku)}</span>` : "";
      const weight = p.weight ? `<span>${__t('store.weight')} ${escapeHtml(p.weight)} g</span>` : "";
      const badgeClass = (p.in_stock && Number(p.in_stock) > 0) ? "store-item__badge store-item__badge--stock" : "store-item__badge";
      const badgeLabel = (p.in_stock && Number(p.in_stock) > 0) ? __t('store.inStock') : __t('store.outOfStock');
      const metaBits = [kirat, weight, sku, `<span class="${badgeClass}">${badgeLabel}</span>`]
        .filter(Boolean)
        .join("\n");
      const catId = p.categoryId || catIdFromName(p.name);
      const safeCat = escapeHtml(catId);
      const safeSkuAttr = escapeHtml(p.sku || "");
      const stockVal = Number.isFinite(p.stock) ? Math.max(0, Math.floor(p.stock)) : '';
      const stockAttr = stockVal === '' ? '' : String(stockVal);
      const kNum = (p.kirat || '').toString().match(/\d{2}/)?.[0] || '';
      const kAttr = kNum ? ` data-k="${kNum}"` : '';
      return `
        <article class="store-item card product-card" data-idx="${i}" data-cat="${safeCat}" data-sku="${safeSkuAttr}" data-price="${priceNum}"${stockAttr!==''?` data-stock="${stockAttr}"`:''}${kAttr}>
          <figure class="store-item__thumb">
            ${main ? `<img class="js-main" src="${escapeHtml(main)}" alt="${safeTitle || 'Bracelet photo'}" loading="lazy">`
                   : `<div class="store-item__placeholder" aria-hidden="true"></div>`}
            ${photos.length > 1 ? `
              <div class="count-badge">${photos.length}</div>
              <div class="store-item__thumbs">
                ${photos.map((u,i)=>`
                  <img class="js-thumb ${i===0?'is-active':''}" src="${escapeHtml(u)}" alt="thumb ${i+1}" loading="lazy" />
                `).join('')}
              </div>
            ` : ``}
          </figure>
          <div class="store-item__body">
            <div class="store-item__header">
              <h3 class="store-item__title">${safeTitle}</h3>
              ${price ? `<div class="store-item__price">${price}<span class="store-item__currency">USD</span></div>` : ""}
            </div>
            ${description ? `<p class="store-item__description">${description}</p>` : ""}
            <div class="store-item__meta">${metaBits}</div>
            <div class="store-item__actions">
              <button class="btn try-on-btn" type="button" data-tryon="" hidden>Try on (beta)</button>
            </div>
          </div>
          <button class="mini-cart" type="button" aria-label="Add to cart">🛒</button>
        </article>
      `;
    }).join("\n");
    out.innerHTML = cards;

    // Wire gallery clicks (event delegation)
    out.querySelectorAll('.store-item').forEach(card => {
      const mainImg = card.querySelector('.store-item__thumb .js-main');
      const thumbs = card.querySelectorAll('.store-item__thumbs .js-thumb');
      if (!mainImg || !thumbs.length) return;
      thumbs.forEach(t => {
        t.addEventListener('click', () => {
          thumbs.forEach(x => x.classList.remove('is-active'));
          t.classList.add('is-active');
          const next = t.getAttribute('src');
          if (next) mainImg.setAttribute('src', next);
        });
      });
    });
    document.dispatchEvent(new CustomEvent('hcj:products-rendered', { detail: { products } }));
  }

  // Update only the DOM price labels & data-price, keep everything else intact
  function updatePricesInPlace(products){
    const list = Array.isArray(products) ? products : (window.PRODUCTS || []);
    const moneyFmt = money;
    list.forEach((p, i) => {
      const card = document.querySelector(`.product-card[data-idx="${i}"]`);
      if(!card) return;
      const priceEl = card.querySelector('.store-item__price');
      if(priceEl){
        const num = Number(p.price) || 0;
        if(priceEl.childNodes && priceEl.childNodes.length){
          // first text node holds the number
          priceEl.childNodes[0].nodeValue = moneyFmt(num);
        }else{
          priceEl.textContent = moneyFmt(num);
          const cur = document.createElement('span'); cur.className = 'store-item__currency'; cur.textContent = 'USD'; priceEl.appendChild(cur);
        }
      }
      card.dataset.price = Number(p.price) || 0;
    });
  }

  fetch(URL)
    .then(r => r.text())
    .then(txt => {
      const json = JSON.parse(txt.substring(47, txt.length - 2));
      const table = json.table || {};
      const rows = (table.rows || []);
      const cols = Array.isArray(table.cols) ? table.cols : [];
      const colIndex = {};
      cols.forEach((col, idx) => {
        const label = (col?.label || '').trim();
        if(label) colIndex[label] = idx;
      });
      const tryOnIndex = colIndex[TRY_ON_COL_HEADER];
      const products = rows.map((r, i) => {
        // Keep both the raw value (v) and the formatted value (f)
        const cells = (r.c || []).map(c => c ? (c.f || c.v || "") : "");

        // Columns: A Timestamp, B name, C weight, D kirat, E description, F sku, G photo, H fee ("أجور + ربح ex.2.5"), I stock
        const name        = cells[1];
        const weight      = cells[2];
        const kirat       = cells[3];
        const description = cells[4];
        const sku         = cells[5];
        const photo       = cells[6];
        const fee         = cells[7];
        const stockRaw    = cells[8];
        const tryOnRaw    = (Number.isInteger(tryOnIndex) && tryOnIndex >= 0) ? cells[tryOnIndex] : '';

        const price = "";
        const stockNum = toNum(stockRaw);
        const stock = Number.isFinite(stockNum) ? Math.max(0, Math.floor(stockNum)) : 99;
        const in_stock = stock;
        const categoryId = catIdFromName(name);
        const images = driveImages(photo);
        const thumb = images[0] || '';
        let tryOnUrl = '';
        if(tryOnRaw){
          const link = splitLinks(tryOnRaw)[0] || tryOnRaw;
          tryOnUrl = driveShareToDirect(link);
        }

        return { id:i, name, price, kirat, photo, images, thumb, description, sku, in_stock, weight, fee, stock, categoryId, tryOnUrl };
      });
      window.PRODUCTS = products;
      startSpotRefresh(products);
    })
    .catch(err => {
      console.error(err);
      if(out){
        out.removeAttribute('data-i18n');
        out.innerHTML = `<span class="badge">${__t('store.loadFail')}</span>`;
      }
      lastProducts = [];
      lastStatus = 'error';
    });
})();
</script>
<script>
(function(){
  const KEY = window.__HCJ_THEME_KEY || 'hcj-theme';
  const THEMES = ['light','dark','plum','custom'];
  const top = document.getElementById('themeSelectTop');
  const inner = document.getElementById('themeSelect');
  function applySharedTheme(t){
    const next = THEMES.includes(t) ? t : 'light';
    if(typeof window.applyTheme === 'function'){
      window.applyTheme(next);
    }else{
      document.documentElement.dataset.theme = next;
    }
    try{ localStorage.setItem(KEY,next);}catch(_){ }
    if(inner && inner !== top) inner.value = next;
    return next;
  }
  let saved = 'light';
  try{ saved = localStorage.getItem(KEY) || document.documentElement.dataset.theme || 'light'; }catch(_){ }
  applySharedTheme(saved);
  if(top){
    top.value = saved;
    top.addEventListener('change', e => applySharedTheme(e.target.value));
  }
})();
</script>
<script>
  if('serviceWorker' in navigator){
    window.addEventListener('load', function(){
      navigator.serviceWorker.register('sw.js').catch(function(){});
    });
  }
</script>
<script>
/* ===== Minimal i18n engine (shared) ===== */
(function () {
  const LANG_KEY = 'hcj-lang';
  const langSelect = document.getElementById('langSelectTop');

  function translate(key, vars){
    const lang = document.documentElement.lang || 'en';
    const dict = window.__TRANSLATIONS?.[lang] || {};
    const fallback = window.__TRANSLATIONS?.en || {};
    let value = dict[key];
    if(value == null) value = fallback[key];
    if(value == null) value = '';
    if(typeof value === 'string' && vars && typeof vars === 'object'){
      value = value.replace(/\{\{(\w+)\}\}/g, (_, name) => (vars[name] ?? ''));
    }
    return value;
  }

  function t(key, vars){
    return translate(key, vars);
  }

  function applyDir(lang){
    document.documentElement.lang = lang;
    document.documentElement.dir = (lang === 'ar') ? 'rtl' : 'ltr';
  }

  function translateDOM(){
    document.querySelectorAll('[data-i18n]').forEach(el => {
      const key = el.getAttribute('data-i18n');
      const txt = t(key);
      if (txt) el.textContent = txt;
    });
    document.querySelectorAll('[data-i18n-attr]').forEach(el => {
      const map = el.getAttribute('data-i18n-attr').split(';').map(s=>s.trim()).filter(Boolean);
      map.forEach(pair=>{
        const [attr, key] = pair.split(':').map(s=>s.trim());
        const val = t(key);
        if(attr && val) el.setAttribute(attr, val);
      });
    });
  }

  function setLang(lang){
    applyDir(lang);
    try { localStorage.setItem(LANG_KEY, lang); } catch(e) {}
    translateDOM();
    window.dispatchEvent(new CustomEvent('hcj:lang', { detail: { lang } }));
  }

  let saved = 'en';
  try { saved = localStorage.getItem(LANG_KEY) || 'en'; } catch(e) {}
  applyDir(saved);

  if(langSelect){
    langSelect.value = saved;
    langSelect.addEventListener('change', e => setLang(e.target.value));
  }
  window.addEventListener('DOMContentLoaded', translateDOM);
})();
</script>
<script>
/* ===== Category, Magnifier & Mini-Cart Enhancer (non-destructive) ===== */
(function(){
  const out = document.getElementById('storeList');
  if(!out) return;

  const HCJ = window.HCJ || {};
  const CATS = HCJ.CATS || {};
  const catBar = document.getElementById('catBar');
  const catToggle = document.getElementById('catToggle');
  const liveBadges = document.getElementById('liveBadges');
  const catMeta = document.getElementById('catMeta');
  const catCount = document.getElementById('hcjCatsCount');
  const cartDrawer = document.getElementById('hcjCart');
  const cartBody = document.getElementById('hcjCartBody');
  const cartSub = document.getElementById('hcjSub');
  const checkoutBtn = document.getElementById('hcjCheckout');
  const closeCartBtn = cartDrawer?.querySelector('.hcj-cart__close');

  const ESC = {"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"};
  const escape = value => String(value ?? '').replace(/[&<>"']/g, ch => ESC[ch] || ch);

  let activeCat = 'all';
  let activeKarat = null;            // null = all
  let LIVE_TICKET = 0;               // prevents duplicate renders

  function setActiveKarat(k){
    activeKarat = (k==null ? null : Number(k));
    // visual state on the buttons
    liveBadges?.querySelectorAll('button[data-k]').forEach(b=>{
      const on = Number(b.dataset.k) === activeKarat;
      b.classList.toggle('active', on);
      b.setAttribute('aria-pressed', on ? 'true' : 'false');
    });
    const resetBtn = liveBadges?.querySelector('button[data-reset]');
    if(resetBtn){
      const on = activeKarat == null;
      resetBtn.classList.toggle('active', on);
      resetBtn.setAttribute('aria-pressed', on ? 'true' : 'false');
    }
    // re-apply all filters (category + price + karat)
    if(typeof window.HCJ_APPLY_FILTERS === 'function') window.HCJ_APPLY_FILTERS();
  }

  function pad(n){ return String(n).padStart(2,'0'); }

  const CART = window.HCJ_CART instanceof Map ? window.HCJ_CART : new Map();
  // Use a stable per-piece key independent of SKU
  function keyForProduct(p){
    const id = Number.isFinite(p?.id) ? p.id : Math.floor(Math.random()*1e9);
    return 'id#' + id;
  }
  window.HCJ_SKU_KEY = keyForProduct; // expose for QV
  window.HCJ_CART = CART;

  function buildCatBar(){
    if(!catBar) return;
    catBar.innerHTML = '';
    Object.entries(CATS).forEach(([id, meta]) => {
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'cat' + (id === activeCat ? ' active' : '');
      btn.dataset.id = id;
      btn.innerHTML = `
        <img loading="lazy" src="${meta.icon}" alt="${meta.en} · ${meta.ar}">
        <span>${meta.en} · ${meta.ar}</span>
      `;
      btn.addEventListener('click', () => setActiveCategory(id));
      catBar.appendChild(btn);
    });
    if(catCount){
      const count = Math.max(0, Object.keys(CATS).length - (CATS.all ? 1 : 0));
      catCount.textContent = String(count);
    }
  }

  function filterByCategory(catId){
    const want = (catId === 'all') ? null : catId;
    document.querySelectorAll('.product-card').forEach(card => {
      const ok = !want || card.dataset.cat === want;
      card.style.display = ok ? '' : 'none';
    });
    updateCatMeta();
  }

  function setActiveCategory(id){
    activeCat = CATS[id] ? id : 'all';
    document.querySelectorAll('#catBar .cat').forEach(btn => {
      btn.classList.toggle('active', btn.dataset.id === activeCat);
    });
    // Apply combined filters (category + price)
    if(typeof window.HCJ_APPLY_FILTERS === 'function') window.HCJ_APPLY_FILTERS(); else filterByCategory(activeCat);
    showLivePricesFor();
  }



  // === Price filters & sorting (with toggle) ===
  const filterToggle = document.createElement('button');
  filterToggle.id = 'priceFilterToggle';
  filterToggle.className = 'badge';
  filterToggle.type = 'button';
  filterToggle.textContent = 'Price filter ▾';
  catMeta?.after(filterToggle);

  const filterWrap = document.createElement('div');
  filterWrap.style = 'display:none;flex-wrap:wrap;gap:10px;align-items:center;margin-top:10px;';
  filterWrap.innerHTML = `
    <label class="badge" style="display:inline-flex;gap:6px;align-items:center;">
      Min <input id="priceMin" type="number" inputmode="decimal" min="0" step="1"
                 placeholder="Min (USD)" aria-label="Minimum price"
                 style="width:110px;background:transparent;border:0;outline:0;color:inherit">
    </label>
    <label class="badge" style="display:inline-flex;gap:6px;align-items:center;">
      Max <input id="priceMax" type="number" inputmode="decimal" min="0" step="1"
                 placeholder="Max (USD)" aria-label="Maximum price"
                 style="width:110px;background:transparent;border:0;outline:0;color:inherit">
    </label>
    <label class="badge" style="display:inline-flex;gap:6px;align-items:center;">
      Sort
      <select id="sortPrice" style="background:transparent;border:0;outline:0;color:inherit">
        <option value="">—</option>
        <option value="asc">Price ↑</option>
        <option value="desc">Price ↓</option>
      </select>
    </label>
    <button id="clearFilters" class="hcj-btn ghost" type="button">Reset</button>
  `;
  filterToggle?.after(filterWrap);

  const priceMin = filterWrap.querySelector('#priceMin');
  const priceMax = filterWrap.querySelector('#priceMax');
  const sortPrice = filterWrap.querySelector('#sortPrice');
  const clearFilters = filterWrap.querySelector('#clearFilters');

  filterToggle?.addEventListener('click', ()=>{
    filterWrap.style.display = (filterWrap.style.display === 'none') ? 'flex' : 'none';
  });

  function parseNum(v){
    if(v === '' || v == null) return null;
    let n = parseFloat((v||'').toString().replace(/,/g,'.'));
    if(!Number.isFinite(n)) return null;
    if(n < 0) n = 0;
    return n;
  }

  function applyFiltersAndSorting(){
    const min = parseNum(priceMin.value); const max = parseNum(priceMax.value);
    const cards = Array.from(out.querySelectorAll('.product-card'));
    cards.forEach(card => {
      const price = parseFloat(card.dataset.price || '0');
      const inCat = (activeCat === 'all') || (card.dataset.cat === activeCat);
      const inPrice = (min==null || price >= min) && (max==null || price <= max);
      const inKarat = (activeKarat==null) || (Number(card.dataset.k || 0) === activeKarat);
      const show = inCat && inPrice && inKarat;
      card.style.display = show ? '' : 'none';
    });
    // sort visible ones if needed
    if(sortPrice.value){
      const dir = sortPrice.value === 'desc' ? -1 : 1;
      const visible = cards.filter(c => c.style.display !== 'none');
      visible.sort((a,b) => (parseFloat(a.dataset.price||'0') - parseFloat(b.dataset.price||'0')) * dir);
      visible.forEach(card => out.appendChild(card));
    }
    updateCatMeta();
  }
  window.HCJ_APPLY_FILTERS = applyFiltersAndSorting;

  function clampNonNegative(e){ if(e.target.value !== '' && Number(e.target.value) < 0){ e.target.value = 0; } applyFiltersAndSorting(); }
  priceMin?.addEventListener('input', clampNonNegative);
  priceMax?.addEventListener('input', clampNonNegative);
  sortPrice?.addEventListener('change', applyFiltersAndSorting);
  clearFilters?.addEventListener('click', () => { priceMin.value=''; priceMax.value=''; sortPrice.value=''; applyFiltersAndSorting(); });


  function updateCatMeta(){
    if(!catMeta) return;
    const meta = CATS[activeCat] || CATS.all || { en:'All', ar:'الكل' };
    const label = `${meta.en} · ${meta.ar}`;
    const cards = [...document.querySelectorAll('.product-card')].filter(card => card.style.display !== 'none');
    const weights = cards.map(card => {
      const weightChip = [...card.querySelectorAll('.store-item__meta span')].find(span => /g\b/i.test(span.textContent || ''));
      const value = parseFloat((weightChip?.textContent || '').replace(/[^\d.]/g,''));
      return Number.isFinite(value) ? value : NaN;
    }).filter(Number.isFinite);
    const count = cards.length;
    const totalWeight = weights.reduce((sum, value) => sum + value, 0);
    const avg = weights.length ? (totalWeight / weights.length).toFixed(2) : null;
    const piecesText = count === 1 ? '1 piece' : `${count} pieces`;
    const weightText = avg ? ` • avg ${avg} g` : '';
    catMeta.textContent = count ? `${label} • ${piecesText}${weightText}` : `${label} • No items`;
  }

  async function showLivePricesFor(){
    if(!liveBadges) return;
    const ticket = ++LIVE_TICKET;     // cancel older in-flight calls
    liveBadges.textContent = '';

    // Caption (what these numbers mean)
    const caption = document.createElement('div');
    caption.className = 'cat-meta';
    caption.textContent = 'Price per gram (includes a small making fee). Tap a karat to filter.';
    liveBadges.appendChild(caption);

    // Prefer the latest global snapshot prepared by startSpotRefresh()
    let spot = window.__HCJ_SPOT;
    if(!spot || !Number.isFinite(spot.oz)){
      const getSpot = window.HCJ?.getSpotOz;
      const perGram = window.HCJ?.perGramForKirat;
      if(!getSpot || !perGram) return;
      try{
        const oz = await getSpot();
        if(ticket !== LIVE_TICKET) return; // a newer call already won
        spot = {
          oz,
          g18: Math.round(perGram(oz,'18',10)),
          g21: Math.round(perGram(oz,'21',10)),
          g22: Math.round(perGram(oz,'22',10)),
          g24: Math.round(perGram(oz,'24',10)),
          updatedAt: Date.now()
        };
        window.__HCJ_SPOT = spot;
      }catch(_){ return; }
    }

    // XAU/oz and last update
    const ozPill = document.createElement('span');
    ozPill.className='pill';
    ozPill.textContent = `XAU/oz $${Math.round(spot.oz).toLocaleString()}`;
    const ts = new Date(spot.updatedAt || Date.now());
    const tsPill = document.createElement('span');
    tsPill.className='pill';
    tsPill.textContent = `Last update: ${pad(ts.getDate())}/${pad(ts.getMonth()+1)}/${ts.getFullYear()}, ${pad(ts.getHours())}:${pad(ts.getMinutes())}:${pad(ts.getSeconds())}`;
    liveBadges.append(ozPill, tsPill);

    // Clickable karat buttons
    [['18',spot.g18], ['21',spot.g21], ['22',spot.g22], ['24',spot.g24]].forEach(([k,price])=>{
      if(Number.isFinite(price)){
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'pill';
        btn.dataset.k = k;
        btn.textContent = `${k}K ${Number(price).toLocaleString()}`;
        btn.setAttribute('aria-pressed','false');
        btn.addEventListener('click', ()=> setActiveKarat(Number(k)));
        liveBadges.appendChild(btn);
      }
    });

    // Reset button
    const reset = document.createElement('button');
    reset.type = 'button';
    reset.className = 'pill';
    reset.textContent = 'All karats';
    reset.dataset.reset = '1';
    reset.setAttribute('aria-pressed','false');
    reset.addEventListener('click', ()=> setActiveKarat(null));
    liveBadges.appendChild(reset);

    // Ensure current selection is reflected on buttons
    setActiveKarat(activeKarat);
  }

  function openCart(){ cartDrawer?.setAttribute('aria-hidden','false'); }
  function closeCart(){ cartDrawer?.setAttribute('aria-hidden','true'); }
  closeCartBtn?.addEventListener('click', closeCart);

  if(checkoutBtn){
    checkoutBtn.addEventListener('click', () => {
      if(CART.size === 0) return;
      const payload = [];
      CART.forEach((entry, sku) => {
        payload.push({
          sku,
          name: entry?.product?.name || 'Item',
          price: Number(entry?.product?.price || 0),
          qty: Number(entry?.qty || 1),
          kirat: entry?.product?.kirat || '',
          weight: entry?.product?.weight || '',
          img: entry?.img || ''
        });
      });
      try {
        localStorage.setItem('hcj-cart', JSON.stringify(payload));
      } catch (e) {}
      window.location.href = 'checkout.html';
    });
  }

  function changeQty(sku, delta){
    const entry = CART.get(sku);
    if(!entry) return;
    const next = Math.max(0, Math.min(1, entry.qty + delta)); // cap at 1
    if(next === 0){
      CART.delete(sku);
    }else{
      entry.qty = next;
    }
    renderCartDrawer();
  }

  function renderCartDrawer(){
    if(!cartBody || !cartSub) return;
    if(CART.size === 0){
      cartBody.innerHTML = '<p class="cat-meta">Your cart is empty.</p>';
      cartSub.textContent = '$0';
      return;
    }
    let subtotal = 0;
    const html = [];
    CART.forEach((entry, sku) => {
      const product = entry.product || {};
      const qty = entry.qty || 0;
      const unitPrice = Number(product.price) || 0;
      subtotal += unitPrice * qty;
      const imgSrc = entry.img || (Array.isArray(product.images) ? product.images[0] : null) || product.photo || 'icon/icon-512.png';
      html.push(`
        <div class="hcj-item" data-sku="${escape(sku)}">
          <img src="${escape(imgSrc)}" alt="">
          <div>
            <div class="t">${escape(product.name || 'Item')}</div>
            <div class="s">${escape(product.sku || sku)}</div>
            <div class="p">$${unitPrice.toLocaleString()}</div>
          </div>
          <div class="hcj-qty">
            <button type="button" data-action="dec" aria-label="Decrease quantity">−</button>
            <span>${qty}</span>
            <button type="button" data-action="inc" aria-label="Increase quantity" ${qty >= 1 ? 'disabled' : ''}>+</button>
          </div>
        </div>`);
    });
    cartBody.innerHTML = html.join('');
    cartSub.textContent = '$' + subtotal.toLocaleString();
  }

  window.renderCartDrawer = renderCartDrawer;
  window.HCJ_OPEN_CART = openCart;

  document.addEventListener('hcj:prices-updated', () => {
    if(typeof window.HCJ_APPLY_FILTERS === 'function') window.HCJ_APPLY_FILTERS();
  });

  cartBody?.addEventListener('click', event => {
    const button = event.target.closest('button[data-action]');
    if(!button) return;
    const sku = button.closest('.hcj-item')?.dataset.sku;
    if(!sku) return;
    changeQty(sku, button.dataset.action === 'inc' ? 1 : -1);
  });

  function getProductForCard(card){
    const idx = Number(card.dataset.idx);
    const list = Array.isArray(window.PRODUCTS) ? window.PRODUCTS : [];
    let product = Number.isFinite(idx) ? list[idx] : null;
    if(!product){
      const sku = card.dataset.sku || '';
      product = list.find(p => (p.sku || '') === sku);
    }
    if(!product){
      const title = (card.querySelector('.store-item__title')?.textContent || '').trim().toLowerCase();
      product = list.find(p => String(p.name || '').trim().toLowerCase() === title);
    }
    if(product){
      if(!Number.isFinite(product.stock)){
        const ds = Number(card.dataset.stock);
        if(Number.isFinite(ds)) product.stock = ds;
      }
      return product;
    }
    const fallbackPrice = Number((card.querySelector('.store-item__price')?.textContent || '').replace(/[^\d.]/g,'')) || 0;
    return {
      name: (card.querySelector('.store-item__title')?.textContent || 'Item').trim(),
      sku: (card.querySelector('.store-item__title')?.textContent || 'item').trim(),
      price: fallbackPrice,
      stock: Number(card.dataset.stock) || 99
    };
  }

  function addToCart(product, imgUrl){
    if(!product) return;
    const key = keyForProduct(product);
    // Always cap to 1 per unique piece
    const entry = CART.get(key) || { product, qty: 0, img: imgUrl };
    entry.product = product;
    entry.qty = 1;
    if(imgUrl) entry.img = imgUrl;
    CART.set(key, entry);
    renderCartDrawer();
    openCart();
  }

  function attachMagnifier(img, {zoom=2.6, lens=140}={}){
    if(!img || img.dataset.magAttached) return;
    function init(){
      if(img.dataset.magAttached) return;
      const lensEl = document.createElement('div');
      lensEl.className = 'mag-lens';
      lensEl.style.width = lens + 'px';
      lensEl.style.height = lens + 'px';
      const parent = img.parentElement;
      if(parent && getComputedStyle(parent).position === 'static'){
        parent.style.position = 'relative';
      }
      parent?.appendChild(lensEl);
      let raf = 0, mx = 0, my = 0;
      function updateBackground(){
        lensEl.style.backgroundImage = `url(${img.src})`;
        lensEl.style.backgroundSize = `${img.naturalWidth * zoom}px ${img.naturalHeight * zoom}px`;
      }
      function render(){
        raf = 0;
        const rect = img.getBoundingClientRect();
        const x = Math.max(0, Math.min(mx - rect.left, rect.width));
        const y = Math.max(0, Math.min(my - rect.top, rect.height));
        const bx = -((x * zoom) - lens / 2);
        const by = -((y * zoom) - lens / 2);
        lensEl.style.transform = `translate(${x - lens / 2}px, ${y - lens / 2}px)`;
        lensEl.style.backgroundPosition = `${bx}px ${by}px`;
      }
      function onMove(evt){
        const touch = evt.touches?.[0];
        mx = touch ? touch.clientX : evt.clientX;
        my = touch ? touch.clientY : evt.clientY;
        if(!raf) raf = requestAnimationFrame(render);
      }
      function show(){ lensEl.style.display = 'block'; }
      function hide(){ lensEl.style.display = 'none'; }
      img.addEventListener('mousemove', onMove, {passive:true});
      img.addEventListener('touchmove', onMove, {passive:true});
      img.addEventListener('mouseenter', show);
      img.addEventListener('mouseleave', hide);
      img.addEventListener('touchend', hide);
      img.addEventListener('load', updateBackground);
      updateBackground();
      img.dataset.magAttached = '1';
    }
    if(img.complete && img.naturalWidth){
      init();
    }else{
      img.addEventListener('load', init, {once:true});
    }
  }

  function decorateCards(){
    out.querySelectorAll('.product-card').forEach(card => {
      if(card.dataset.enhanced) return;
      card.dataset.enhanced = '1';
      const img = card.querySelector('.store-item__thumb .js-main');
      // Removed: no magnifier on listing
      // if(img) attachMagnifier(img, {zoom:3.0, lens:160});
    });
    filterByCategory(activeCat);
  }

  const observer = new MutationObserver(() => {
    decorateCards();
    updateCatMeta();
  });
  observer.observe(out, {childList:true});

  document.addEventListener('click', event => {
    const btn = event.target.closest('.mini-cart');
    if(!btn) return;
    const card = btn.closest('.product-card');
    if(!card) return;
    const product = getProductForCard(card);
    const img = card.querySelector('.store-item__thumb .js-main')?.src || '';
    addToCart(product, img);
  });

  catToggle?.addEventListener('click', () => {
    catBar?.classList.toggle('open');
  });

  document.addEventListener('hcj:products-rendered', () => {
    decorateCards();
    renderCartDrawer();
    setActiveCategory(activeCat);
    if(typeof window.HCJ_APPLY_FILTERS === 'function') window.HCJ_APPLY_FILTERS();
  });

  buildCatBar();
  setActiveCategory(activeCat);
  decorateCards();
  renderCartDrawer();
  showLivePricesFor();
  window.addEventListener('hcj:spot-update', () => showLivePricesFor());
  if(typeof window.HCJ_APPLY_FILTERS === 'function') window.HCJ_APPLY_FILTERS();
})();
</script>
<script>
(function(){
  // ===== Quick View wiring =====
  const out = document.getElementById('storeList');
  const qv = document.getElementById('hcjQV');
  const qvClose = qv?.querySelector('.hcj-qv__close');
  const qvTitle = document.getElementById('hcjQVTitle');
  const qvPrice = document.getElementById('hcjQVPrice');
  const qvSpecs = document.getElementById('hcjQVSpecs');
  const qvThumbs = document.getElementById('hcjQVThumbs');
  const zoomWrap = document.getElementById('hcjZoom');
  const qvImg = document.getElementById('hcjZoomImg');
  const qvLens = document.getElementById('hcjLens');
  // A big zoom viewport (like your sample site)
  const qvZoomBox = document.createElement('div');
  qvZoomBox.id = 'hcjZoomBox';
  qvZoomBox.className = 'hcj-zoombox';
  zoomWrap?.after(qvZoomBox);
  const addBtn = document.getElementById('hcjAddCartQV');
  const waBtn = document.getElementById('hcjWA');

  let current = null;
  let magOn = false;
  let magZoom = 2.6;
  /* ===== Hover/Tap PAN for the zoomed image (no lens needed) ===== */
(function addHoverPan(){
  if (!zoomWrap || !qvImg) return;

  let isZoomed = false;
  let z = magZoom || 3;   // default zoom factor
  const minZ = 1.5, maxZ = 4;

  function setZoom(val){
    z = Math.max(minZ, Math.min(maxZ, val));
    magZoom = z; // keep in sync with your existing slider
  }

  // Mouse / touch move adjusts the transform-origin so the image pans under the cursor
  function panAt(clientX, clientY){
    if (!isZoomed) return;
    const rect = zoomWrap.getBoundingClientRect();
    let x = (clientX - rect.left) / rect.width;
    let y = (clientY - rect.top)  / rect.height;
    x = Math.max(0, Math.min(1, x));
    y = Math.max(0, Math.min(1, y));
    qvImg.style.transformOrigin = `${(x*100).toFixed(2)}% ${(y*100).toFixed(2)}%`;
    qvImg.style.transform = `scale(${z})`;
  }

  // Desktop: enter to zoom, move to pan, leave to reset
  zoomWrap.addEventListener('mouseenter', () => {
    isZoomed = true;
    zoomWrap.classList.add('is-zoomed');
    qvImg.style.willChange = 'transform';
    qvImg.style.transform = `scale(${z})`;
  });

  zoomWrap.addEventListener('mousemove', (e) => panAt(e.clientX, e.clientY));

  zoomWrap.addEventListener('mouseleave', () => {
    isZoomed = false;
    zoomWrap.classList.remove('is-zoomed');
    qvImg.style.transform = 'none';
    qvImg.style.transformOrigin = 'center center';
    qvImg.style.willChange = '';
  });

  // Touch: tap/hold to zoom, drag finger to pan, lift to reset
  zoomWrap.addEventListener('touchstart', (e) => {
    const t = e.touches[0];
    if (!t) return;
    isZoomed = true;
    zoomWrap.classList.add('is-zoomed');
    qvImg.style.willChange = 'transform';
    panAt(t.clientX, t.clientY);
  }, {passive:true});

  zoomWrap.addEventListener('touchmove', (e) => {
    const t = e.touches[0];
    if (!t) return;
    panAt(t.clientX, t.clientY);
  }, {passive:true});

  zoomWrap.addEventListener('touchend', () => {
    isZoomed = false;
    zoomWrap.classList.remove('is-zoomed');
    qvImg.style.transform = 'none';
    qvImg.style.transformOrigin = 'center center';
    qvImg.style.willChange = '';
  });

  // Optional: mouse wheel to change zoom level
  zoomWrap.addEventListener('wheel', (e) => {
    e.preventDefault();
    const next = z + (e.deltaY < 0 ? 0.2 : -0.2);
    setZoom(next);
    if (isZoomed) qvImg.style.transform = `scale(${z})`;
    // keep the slider (if present) in sync
    const slider = document.getElementById('hcjMagZoom');
    if (slider) slider.value = String(z);
  }, {passive:false});

  // Keep in sync when your existing slider changes
  document.getElementById('hcjMagZoom')?.addEventListener('input', (e)=>{
    setZoom(parseFloat(e.target.value)||z);
    if (isZoomed) qvImg.style.transform = `scale(${z})`;
  });
})();


  function money(n){
    return Number(n || 0).toLocaleString();
  }

  function updateLensBackground(){
    if(!qvImg) return;
    const w = qvImg.naturalWidth, h = qvImg.naturalHeight;
    if(w && h){
      const size = `${w * magZoom}px ${h * magZoom}px`;
      if(qvLens){
        qvLens.style.backgroundImage = `url(${qvImg.src})`;
        qvLens.style.backgroundSize = size;
      }
      if(qvZoomBox){
        qvZoomBox.style.backgroundImage = `url(${qvImg.src})`;
        qvZoomBox.style.backgroundSize = size;
      }
    }
  }

  function enableQVZoom(){
    if(!zoomWrap || !qvImg) return;
    disableQVZoom();
    if(qvLens) qvLens.style.display = 'none';
    if(qvZoomBox) qvZoomBox.style.display = 'none';
    const onMove = (e) => {
      if(!magOn) return;
      const point = e.touches?.[0] ?? e;
      const rect = zoomWrap.getBoundingClientRect();
      const x = Math.max(0, Math.min(point.clientX - rect.left, rect.width));
      const y = Math.max(0, Math.min(point.clientY - rect.top, rect.height));
      const bx = -((x * magZoom) - (qvLens?.offsetWidth || 0) / 2);
      const by = -((y * magZoom) - (qvLens?.offsetHeight || 0) / 2);
      if(qvLens){
        qvLens.style.transform = `translate(${x - qvLens.offsetWidth / 2}px, ${y - qvLens.offsetHeight / 2}px)`;
        qvLens.style.backgroundPosition = `${bx}px ${by}px`;
      }
      // big viewport positions around the sampled point
      if(qvZoomBox){
        const bx2 = -((x * magZoom) - (qvZoomBox.clientWidth / 2));
        const by2 = -((y * magZoom) - (qvZoomBox.clientHeight / 2));
        qvZoomBox.style.backgroundPosition = `${bx2}px ${by2}px`;
      }
    };
    const onEnter = () => {
      if(magOn){
        if(qvLens) qvLens.style.display = 'block';
        if(qvZoomBox) qvZoomBox.style.display = 'block';
      }
    };
    const onLeave = () => {
      if(qvLens) qvLens.style.display = 'none';
      if(qvZoomBox) qvZoomBox.style.display = 'none';
    };
    zoomWrap.addEventListener('mousemove', onMove, { passive: true });
    zoomWrap.addEventListener('touchmove', onMove, { passive: true });
    zoomWrap.addEventListener('mouseenter', onEnter);
    zoomWrap.addEventListener('mouseleave', onLeave);
    zoomWrap.addEventListener('touchstart', onEnter, { passive: true });
    zoomWrap.addEventListener('touchend', onLeave);
    zoomWrap.__zoomHandlers = { onMove, onEnter, onLeave };
  }

  function disableQVZoom(){
    if(!zoomWrap || !zoomWrap.__zoomHandlers) return;
    const h = zoomWrap.__zoomHandlers;
    zoomWrap.removeEventListener('mousemove', h.onMove);
    zoomWrap.removeEventListener('touchmove', h.onMove);
    zoomWrap.removeEventListener('mouseenter', h.onEnter);
    zoomWrap.removeEventListener('mouseleave', h.onLeave);
    zoomWrap.removeEventListener('touchstart', h.onEnter);
    zoomWrap.removeEventListener('touchend', h.onLeave);
    if(qvLens) qvLens.style.display = 'none';
    if(qvZoomBox) qvZoomBox.style.display = 'none';
    zoomWrap.__zoomHandlers = null;
  }

  if(qvImg){
    qvImg.addEventListener('load', updateLensBackground);
  }

  function setQVPhoto(src, alt){
    if(!qvImg) return;
    qvImg.src = src;
    if(typeof alt === 'string') qvImg.alt = alt;
    updateLensBackground();
  }

  function renderThumbs(images, name){
    if(!qvThumbs) return;
    qvThumbs.innerHTML = '';
    images.forEach((src, index) => {
      const thumb = new Image();
      thumb.src = src;
      thumb.alt = `thumb ${index + 1}`;
      if(index === 0) thumb.classList.add('is-active');
      thumb.addEventListener('click', () => {
        qvThumbs.querySelectorAll('img').forEach(x => x.classList.remove('is-active'));
        thumb.classList.add('is-active');
        setQVPhoto(src, name);
      });
      qvThumbs.appendChild(thumb);
    });
  }

  function openQV(product){
    current = product;
    const baseImages = Array.isArray(product?.images) ? product.images.filter(Boolean) : [];
    const imgs = baseImages.length ? [...baseImages] : [];
    if(!imgs.length){
      const fallback = String(product?.photo || product?.thumb || '')
        .split(/[|,]/)
        .map(s => s.trim())
        .filter(Boolean);
      fallback.forEach(src => {
        if(src && !imgs.includes(src)) imgs.push(src);
      });
    }
    const first = imgs[0] || product?.thumb || product?.photo || 'icon/icon-512.png';
    if(first && !imgs.includes(first)) imgs.unshift(first);
    const name = product?.name || 'Item';
    qvTitle.textContent = name;
    qvPrice.textContent = money(product?.price);
    qvSpecs.innerHTML = [
      product?.kirat ? `<span>Karat: ${product.kirat}</span>` : '',
      product?.weight ? `<span>Weight: ${product.weight} g</span>` : '',
      product?.sku ? `<span>SKU: ${product.sku}</span>` : ''
    ].filter(Boolean).join('');
    const qvDesc = document.getElementById('hcjQVDesc');
    if(qvDesc){ qvDesc.textContent = (product?.description || '').toString(); }

    if(imgs.length){
      renderThumbs(imgs, name);
    }else if(qvThumbs){
      qvThumbs.innerHTML = '';
    }
    setQVPhoto(first || 'icon/icon-512.png', name);

    addBtn.onclick = () => {
      const imgUrl = first || '';
      if(window.HCJ_CART && typeof window.HCJ_CART.set === 'function'){
        const keyFn = window.HCJ_SKU_KEY || ((p)=>'id#'+(Number.isFinite(p?.id)?p.id:Math.floor(Math.random()*1e9)));
        const sku = keyFn(product);
        // Always cap to 1 per unique item
        window.HCJ_CART.set(sku, { product, qty: 1, img: imgUrl });
        document.dispatchEvent(new CustomEvent('hcj:cart-updated'));
      }
    };

    if(waBtn){
      const imgSrc = (product?.images && product.images[0]) || product?.thumb || product?.photo || '';
      const direct = (typeof window.driveShareToDirect === 'function' ? window.driveShareToDirect(imgSrc) : imgSrc) || '';
      const message = [
        'Hi, I like this piece and would like more information.',
        `Name: ${name}`,
        product?.kirat ? `Karat: ${product.kirat}` : null,
        product?.weight ? `Weight: ${product.weight} g` : null,
        product?.sku ? `SKU: ${product.sku}` : null,
        `Price: $${money(product?.price)} USD`,
        direct ? `Photo: ${direct}` : null,
        'Thank you.'
      ].filter(Boolean).join('\n');
      waBtn.href = `https://wa.me/393481651384?text=${encodeURIComponent(message)}`;
    }

    magOn = false;
    if(qvLens){
      qvLens.style.display = 'none';
    }
    if(qvZoomBox){
      qvZoomBox.style.display = 'none';
    }
    if(toggle){
      toggle.checked = false;
    }

    qv.setAttribute('aria-hidden', 'false');
    enableQVZoom();
  }

  function closeQV(){
    qv.setAttribute('aria-hidden', 'true');
    current = null;
    magOn = false;
    if(toggle){
      toggle.checked = false;
    }
    if(qvLens){
      qvLens.style.display = 'none';
    }
    if(qvZoomBox){
      qvZoomBox.style.display = 'none';
    }
    disableQVZoom();
  }

  qvClose?.addEventListener('click', closeQV);
  qv?.addEventListener('click', e => { if(e.target === qv) closeQV(); });
  document.addEventListener('keydown', e => { if(e.key === 'Escape') closeQV(); });

  const controls = document.createElement('div');
  controls.style = 'display:flex; gap:10px; align-items:center; margin-top:8px;';
  controls.innerHTML = `
    
  `;
  if(zoomWrap?.parentNode){
    zoomWrap.after(controls);
  }else{
    qv?.appendChild(controls);
  }
  const toggle = controls.querySelector('#hcjMagToggle');
  const zoom = controls.querySelector('#hcjMagZoom');
  toggle?.addEventListener('change', () => {
    magOn = toggle.checked;
    if(magOn){
      if(qvLens) qvLens.style.display = 'block';
      if(qvZoomBox) qvZoomBox.style.display = 'block';
      updateLensBackground();
      const rect = zoomWrap?.getBoundingClientRect();
      const lensW = qvLens?.offsetWidth || 0;
      const lensH = qvLens?.offsetHeight || 0;
      const cx = rect ? rect.width / 2 : lensW / 2;
      const cy = rect ? rect.height / 2 : lensH / 2;
      const bx = -((cx * magZoom) - lensW / 2);
      const by = -((cy * magZoom) - lensH / 2);
      if(qvLens){
        qvLens.style.transform = `translate(${cx - lensW / 2}px, ${cy - lensH / 2}px)`;
        qvLens.style.backgroundPosition = `${bx}px ${by}px`;
      }
      if(qvZoomBox){
        const bx2 = -((cx * magZoom) - (qvZoomBox.clientWidth / 2));
        const by2 = -((cy * magZoom) - (qvZoomBox.clientHeight / 2));
        qvZoomBox.style.backgroundPosition = `${bx2}px ${by2}px`;
      }
    }else{
      if(qvLens) qvLens.style.display = 'none';
      if(qvZoomBox) qvZoomBox.style.display = 'none';
    }
  });
  zoom?.addEventListener('input', () => {
    magZoom = Number(zoom.value);
    updateLensBackground();
  });

  out?.addEventListener('click', (e) => {
    const btn = e.target.closest('.mini-cart');
    if(btn) return;
    const card = e.target.closest('.product-card');
    if(!card) return;
    const list = window.PRODUCTS || [];
    const idx = Number(card.dataset.idx);
    const sku = card.dataset.sku || '';
    const title = (card.querySelector('.store-item__title')?.textContent || '').trim().toLowerCase();
    const product = (Number.isFinite(idx) ? list[idx] : null) || list.find(p => (p.sku || '') === sku) || list.find(p => String(p.name || '').trim().toLowerCase() === title);
    if(product){
      openQV(product);
    }
  }, true);

  document.addEventListener('hcj:cart-updated', () => {
    if(typeof window.renderCartDrawer === 'function') window.renderCartDrawer();
    if(typeof window.HCJ_OPEN_CART === 'function') window.HCJ_OPEN_CART();
  });
})();
</script>
<script>
(function(){
  // default to tiles on small screens
  const isPhone = matchMedia('(max-width:720px)').matches;
  document.body.classList.add(isPhone ? 'view-tiles' : 'view-list');

  const listBtn  = document.getElementById('viewListBtn');
  const tilesBtn = document.getElementById('viewTilesBtn');
  function apply(mode){
    document.body.classList.toggle('view-list',  mode === 'list');
    document.body.classList.toggle('view-tiles', mode === 'tiles');
    try{ localStorage.setItem('hcj-view', mode); }catch(_){ }
    if(listBtn){ listBtn.setAttribute('aria-pressed', mode === 'list' ? 'true' : 'false'); }
    if(tilesBtn){ tilesBtn.setAttribute('aria-pressed', mode === 'tiles' ? 'true' : 'false'); }
  }
  let saved = 'list';
  try{ saved = localStorage.getItem('hcj-view') || (isPhone?'tiles':'list'); }catch(_){ }
  apply(saved);

  listBtn?.addEventListener('click',  ()=>apply('list'));
  tilesBtn?.addEventListener('click', ()=>apply('tiles'));
})();
</script>
<script>
(function(){
  const modal = document.getElementById('tryon-modal');
  if(!modal) return;

  const closeBtn     = document.getElementById('tryon-close');
  const bgPhoto      = document.getElementById('bg-photo');
  const ringOverlay  = document.getElementById('ring-overlay');
  const ringImage    = document.getElementById('ring-image');
  const sizeRange    = document.getElementById('sizeRange');
  const rotateRange  = document.getElementById('rotateRange');
  const photoUpload  = document.getElementById('photoUpload');
  const photoCapture = document.getElementById('photoCapture');

  let uploadedUrl = null;
  const base = { x:0, y:0, scale:1, rot:0 };
  const drag = { on:false, sx:0, sy:0, tx:0, ty:0, id:null };

  /* -------- Drive link -> safe image URL (lh3 endpoint) -------- */
  function driveToImg(url){
    if(!url) return '';
    try{
      const u = new URL(String(url).trim());
      const m1 = u.pathname.match(/\/d\/([a-zA-Z0-9_-]+)/);
      const m2 = u.search.match(/[?&]id=([a-zA-Z0-9_-]+)/);
      const id = (m1 && m1[1]) || (m2 && m2[1]);
      return id ? `https://lh3.googleusercontent.com/d/${id}=w1600` : url;
    }catch{ return url; }
  }

  /* -------- Open / Close -------- */
  function resetTransform(){
    base.x = 0; base.y = 0; base.scale = 1; base.rot = 0;
    sizeRange && (sizeRange.value = '1');
    rotateRange && (rotateRange.value = '0');
    applyTransform();
  }
  function applyTransform(){
    ringOverlay.style.transform =
      `translate(calc(-50% + ${base.x}px), calc(-50% + ${base.y}px)) scale(${base.scale}) rotate(${base.rot}deg)`;
  }
  function clearBg(){
    if(uploadedUrl){ URL.revokeObjectURL(uploadedUrl); uploadedUrl = null; }
    if(bgPhoto){ bgPhoto.removeAttribute('src'); }
  }
  function openTryOn(ringUrl){
    resetTransform();
    ringImage.crossOrigin = 'anonymous';
    ringImage.src = driveToImg(ringUrl || '');
    modal.hidden = false;
    document.body.style.overflow = 'hidden';
  }
  function closeTryOn(){
    modal.hidden = true;
    document.body.style.overflow = '';
    clearBg();
  }

  /* -------- Drag / wheel controls -------- */
  ringOverlay.addEventListener('pointerdown', (e)=>{
    drag.on = true; drag.id = e.pointerId;
    drag.sx = e.clientX; drag.sy = e.clientY;
    drag.tx = base.x; drag.ty = base.y;
    ringOverlay.setPointerCapture?.(e.pointerId);
  });
  ringOverlay.addEventListener('pointermove', (e)=>{
    if(!drag.on) return;
    base.x = drag.tx + (e.clientX - drag.sx);
    base.y = drag.ty + (e.clientY - drag.sy);
    applyTransform();
  });
  function endDrag(){ drag.on = false; drag.id = null; }
  ringOverlay.addEventListener('pointerup', endDrag);
  ringOverlay.addEventListener('pointercancel', endDrag);
  ringOverlay.addEventListener('wheel', (e)=>{
    e.preventDefault();
    const f = e.deltaY < 0 ? 1.05 : 0.95;
    base.scale = Math.min(3, Math.max(0.2, base.scale * f));
    sizeRange.value = String(base.scale);
    applyTransform();
  }, {passive:false});

  sizeRange.addEventListener('input', e=>{
    base.scale = Math.min(3, Math.max(0.2, parseFloat(e.target.value)||1));
    applyTransform();
  });
  rotateRange.addEventListener('input', e=>{
    base.rot = Math.max(-180, Math.min(180, parseFloat(e.target.value)||0));
    applyTransform();
  });

  /* -------- Capture / Upload -------- */
  function setBgFromFile(file){
    if(!file) return;
    clearBg();
    uploadedUrl = URL.createObjectURL(file);
    bgPhoto.src = uploadedUrl;
  }
  photoCapture?.addEventListener('change', ()=> setBgFromFile(photoCapture.files?.[0]));
  photoUpload?.addEventListener('change', ()=> setBgFromFile(photoUpload.files?.[0]));

  async function requestUserPhoto(){
    return new Promise((resolve)=>{
      function done(){
        // if user picked something, bg will be set by setBgFromFile()
        resolve();
      }
      // prefer camera if available; otherwise fall back to upload
      const cam = document.getElementById('photoCapture');
      const up  = document.getElementById('photoUpload');
      const once = { once:true };
      cam?.addEventListener('change', done, once);
      up?.addEventListener('change', done, once);
      try{
        if (cam) cam.click();
        else if (up) up.click();
        else resolve();
      }catch(_){
        if (up) up.click(); else resolve();
      }
    });
  }

  /* -------- Buttons on cards -------- */
  function attachTryOnButton(card, product){
    const btn = card.querySelector('.try-on-btn');
    if(!btn) return;
    const url = product?.tryOnUrl ? driveToImg(product.tryOnUrl) : '';
    if(url){ btn.dataset.tryon = url; btn.hidden = false; }
    else   { btn.dataset.tryon = '';  btn.hidden = true;  }
  }
  function syncButtons(products){
    (products || window.PRODUCTS || []).forEach((p,i)=>{
      const card = document.querySelector(`.product-card[data-idx="${i}"]`);
      if(card) attachTryOnButton(card, p);
    });
  }
  function wireButtons(root=document){
    root.querySelectorAll('.try-on-btn').forEach(btn=>{
      if(btn.dataset.wired === '1') return;
      btn.dataset.wired = '1';
      btn.addEventListener('click', async ()=>{
        const url = btn.dataset.tryon;
        if(!url) return;
        await requestUserPhoto();
        openTryOn(url);
      });
    });
  }

  closeBtn?.addEventListener('click', closeTryOn);
  modal.addEventListener('click', e=>{ if(e.target === modal) closeTryOn(); });
  document.addEventListener('keydown', e=>{ if(e.key === 'Escape' && !modal.hidden) closeTryOn(); });

  document.addEventListener('hcj:products-rendered', e=>{
    syncButtons(e.detail?.products);
    wireButtons();
  });
  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', ()=>{ syncButtons(window.PRODUCTS); wireButtons(); });
  }else{ syncButtons(window.PRODUCTS); wireButtons(); }
})();
</script>
</body>
</html>
