<!doctype html>
<html lang="en">
<head>
<script>
  // Apply saved theme ASAP (before CSS loads to avoid a flash)
  (function () {
    try {
      var KEY = 'hcj-theme';
      var saved = localStorage.getItem(KEY) || 'light';
      document.documentElement.setAttribute('data-theme', saved);
      window.__HCJ_THEME_KEY = KEY;
    } catch (e) {}
  })();
</script>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Chakaroun Jewelry — Store</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#17120a">
<link rel="icon" href="icon/icon-1024.png" type="image/png">
<link rel="apple-touch-icon" href="icon/icon-512.png">
<meta name="description" content="Handcrafted gold jewelry from Maison Chakaroun."/>
<meta name="application-name" content="Chakaroun Jewelry">
<meta name="apple-mobile-web-app-title" content="Chakaroun Jewelry">
<meta property="og:title" content="Chakaroun Jewelry — Store">
<meta property="og:description" content="Handcrafted gold jewelry.">
<meta property="og:type" content="website">
<meta property="og:image" content="icon/icon-1024.png">
<meta property="og:site_name" content="Chakaroun Jewelry">
<meta name="twitter:title" content="Chakaroun Jewelry — Store">
<style>
  :root{--radius:14px;--shadow:0 18px 36px rgba(0,0,0,.45);--bar-font:clamp(.98rem,.9rem + .35vw,1.15rem);--bar-pad-y:14px;--bar-pad-x:18px;--bar-gap:12px;--bar-icon:56px;--bar-close:32px;--bar-btn-py:8px;--bar-btn-px:16px}

  html[data-theme="dark"]{
    --bg:#17120a;--bg2:#0f0b06;--card:#211a0e;--card-overlay:rgba(48,37,19,.86);
    --ink:#fff7e6;--muted:#e8d9b3;--gold:#d4af37;--gold2:#b88a1a;
    --border-soft:rgba(212,175,55,.18);--border-strong:rgba(212,175,55,.35);
    --control-border:rgba(212,175,55,.22);--control-bg:rgba(23,18,10,.75);
    --control-focus-bg:rgba(33,26,14,.85);--control-focus-shadow:rgba(212,175,55,.18);
    --head-bg:rgba(15,11,6,.45);
  }
  html:not([data-theme]), html[data-theme="light"]{
    --bg:#f6f2ea;--bg2:#e4e9f3;--card:#ffffff;--card-overlay:rgba(255,255,255,.9);
    --ink:#2b261c;--muted:#706b60;--gold:#c8892c;--gold2:#a56a18;
    --border-soft:rgba(200,137,44,.28);--border-strong:rgba(200,137,44,.45);
    --control-border:rgba(200,137,44,.34);--control-bg:rgba(250,244,234,.92);
    --control-focus-bg:rgba(255,250,243,.97);--control-focus-shadow:rgba(200,137,44,.3);
    --head-bg:rgba(242,234,220,.76);
  }
  html[data-theme="plum"]{
    --bg:#160b19;--bg2:#341844;--card:#2b1433;--card-overlay:rgba(73,35,94,.72);
    --ink:#f8ecff;--muted:#d5c0ec;--gold:#d794ff;--gold2:#b162e4;
    --border-soft:rgba(215,148,255,.32);--border-strong:rgba(215,148,255,.48);
    --control-border:rgba(215,148,255,.36);--control-bg:rgba(41,20,51,.78);
    --control-focus-bg:rgba(55,28,68,.86);--control-focus-shadow:rgba(215,148,255,.26);
    --head-bg:rgba(39,18,50,.65);
  }

  /* A2HS */
  #a2hsBanner{position:fixed;top:0;left:0;right:0;z-index:9999;transform:translateY(-110%);transition:transform .45s ease;background:color-mix(in oklab,var(--bg) 88%,transparent);color:var(--ink);border-bottom:1px solid var(--border-soft);box-shadow:0 10px 30px rgba(0,0,0,.35);font-size:var(--bar-font)}
  #a2hsBanner.show{transform:translateY(0);position:sticky;top:0}
  #a2hsBanner .wrap{display:flex;align-items:center;gap:var(--bar-gap);padding:var(--bar-pad-y) var(--bar-pad-x)}
  #a2hsBanner img.icon{width:var(--bar-icon);height:var(--bar-icon);border-radius:6px;flex:0 0 var(--bar-icon)}
  #a2hsBanner .txt{flex:1;display:flex;flex-direction:column}
  #a2hsBanner .txt .brand-title{font-weight:800;font-size:1.05em}
  #a2hsBanner .txt .brand-byline{font-weight:600;font-size:.88em;opacity:.8}
  #a2hsBanner .txt .banner-copy{font-size:.9em;opacity:.9;margin-top:2px}
  #a2hsBanner .cta{background:linear-gradient(135deg,var(--gold),var(--gold2));color:#2b1f10;border:0;border-radius:999px;padding:var(--bar-btn-py) var(--bar-btn-px);font-weight:800;cursor:pointer;font-size:1em}
  #a2hsBanner .close{background:transparent;color:var(--ink);border:0;width:var(--bar-close);height:var(--bar-close);font-size:calc(var(--bar-close)*0.56);line-height:var(--bar-close);cursor:pointer;flex:0 0 var(--bar-close)}

  #a2hsModal{position:fixed;inset:0;z-index:10001;display:none;align-items:center;justify-content:center;padding:24px 12px}
  #a2hsModal.open{display:flex}
  #a2hsModal::before{content:"";position:absolute;inset:0;background:rgba(0,0,0,.6)}
  #a2hsModal .sheet{position:relative;width:min(560px,92vw);max-height:calc(100vh - 48px);overflow:auto;background:color-mix(in oklab,var(--bg) 86%,transparent);color:var(--ink);border:1px solid var(--border-soft);border-radius:16px;padding:16px;box-shadow:0 20px 50px rgba(0,0,0,.65)}
  #a2hsModal .steps{margin-top:6px;font-size:14px;line-height:1.7}
  #a2hsModal .steps .row{display:flex;gap:10px;margin:6px 0;flex-direction:column}
  #a2hsModal .stepimg{display:block;width:100%;height:auto;margin-top:8px;border-radius:10px;border:1px solid var(--border-soft)}
  #a2hsModal .x{position:absolute;top:8px;left:10px;background:transparent;border:0;color:var(--ink);font-size:20px;cursor:pointer}

  *{box-sizing:border-box}
  body{margin:0;color:var(--ink);background:linear-gradient(160deg, var(--bg) 0%, var(--bg2) 100%);font:15.5px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial}

  .topbar{position:sticky;top:0;z-index:80;background:var(--head-bg);backdrop-filter:saturate(1.25) blur(10px);border-bottom:1px solid var(--border-soft)}
  .topbar .wrap{max-width:1240px;margin:0 auto;padding:12px 18px;display:flex;align-items:center;gap:14px}
  .topbar .brand{display:flex;align-items:center;gap:12px;text-decoration:none;color:var(--ink)}
  .topbar .brand img{width:40px;height:40px;border-radius:10px;box-shadow:0 8px 18px rgba(0,0,0,.35)}
  .topbar .brand .brand-stack{display:flex;flex-direction:column;line-height:1.05}
  .topbar .brand .brand-title{font-weight:800;letter-spacing:.42px;font-size:17px}
  .topbar .brand .brand-byline{font-weight:600;font-size:11px;opacity:.75;text-transform:uppercase;letter-spacing:.6px}
  .topbar .nav{margin-left:auto;display:flex;gap:12px;align-items:center;flex-wrap:nowrap;overflow-x:auto;padding-bottom:4px;scrollbar-width:none;-webkit-overflow-scrolling:touch}
  .topbar .nav::-webkit-scrollbar{display:none}
  .topbar .nav a{color:var(--ink);text-decoration:none;border:1px solid var(--border-soft);padding:9px 14px;border-radius:999px;font-size:13px;font-weight:600;letter-spacing:.04em;transition:border .2s,color .2s,background .2s;flex:0 0 auto;white-space:nowrap}
  .topbar .nav a:hover{border-color:var(--gold);color:var(--ink);background:color-mix(in oklab,var(--gold) 16%,transparent)}
  .topbar .nav a[aria-current="page"]{border-color:var(--gold);color:var(--gold);background:color-mix(in oklab,var(--gold) 18%,transparent)}
  .topbar .nav select{border:1px solid var(--border-soft);background:var(--control-bg);color:var(--ink);padding:8px 12px;border-radius:999px;font-size:13px;font-weight:600}

  .store-wrap{max-width:1100px;margin:0 auto;padding:32px 18px 64px;display:grid;gap:24px}
  .card{background:linear-gradient(160deg,var(--card-overlay),var(--card));border:1px solid var(--border-soft);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden}
  .head{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:18px 20px;border-bottom:1px solid var(--border-soft);background:color-mix(in oklab,var(--bg) 8%, transparent)}
  .head h1{margin:0;font-size:22px}
  .badge{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;border:1px solid var(--border-soft);font-size:12px;color:var(--muted);background:var(--control-bg)}
  .panel{padding:20px}

  #storeList{display:grid;gap:20px;min-height:120px}
  .store-item{display:grid;grid-template-columns:minmax(0,200px) minmax(0,1fr);gap:20px;align-items:start;padding:20px}
  .store-item__thumb{position:relative;border-radius:18px;border:1px solid var(--border-soft);overflow:hidden;background:var(--bg2);aspect-ratio:1/1;display:flex;align-items:center;justify-content:center}
  .store-item__thumb img{width:100%;height:100%;object-fit:cover;transition:transform .35s ease}
  /* small thumbnail strip inside each card */
  .store-item__thumbs{position:absolute;left:8px;right:8px;bottom:8px;display:flex;gap:6px;justify-content:center;pointer-events:auto}
  .store-item__thumbs img{width:36px;height:36px;object-fit:cover;border-radius:8px;border:1px solid var(--border-soft);cursor:pointer;opacity:.9;background:var(--bg2)}
  .store-item__thumbs img.is-active{outline:2px solid var(--gold);opacity:1}
  .store-item__thumb .count-badge{position:absolute;top:8px;right:8px;font-size:12px;background:color-mix(in oklab,var(--card) 76%,transparent);border:1px solid var(--border-soft);border-radius:999px;padding:3px 8px;color:var(--muted);backdrop-filter:blur(6px)}
  .store-item__thumb:hover img{transform:scale(1.02)}
  .store-item__placeholder{width:100%;height:100%;background:linear-gradient(135deg,color-mix(in oklab,var(--bg2) 80%, transparent),color-mix(in oklab,var(--bg) 70%, transparent))}
  .store-item__body{display:grid;gap:14px}
  .store-item__header{display:flex;align-items:flex-start;justify-content:space-between;gap:12px}
  .store-item__title{margin:0;font-size:1.2rem;font-weight:700;line-height:1.3;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
  .store-item__price{font-size:1.15rem;font-weight:800;color:var(--gold);white-space:nowrap}
  .store-item__currency{font-size:.8em;color:var(--muted);font-weight:600;margin-left:4px}
  .store-item__description{margin:0;color:color-mix(in oklab,var(--ink) 84%, transparent);font-size:.98rem}
  .store-item__meta{display:flex;gap:12px;flex-wrap:wrap;align-items:center;font-size:12px;color:var(--muted)}
  .store-item__badge{display:inline-flex;align-items:center;justify-content:center;padding:4px 10px;border-radius:999px;border:1px solid var(--border-soft);background:var(--control-bg);font-weight:600;line-height:1}
  .store-item__badge--stock{color:var(--gold)}

  @media (max-width:840px){
    .store-item{grid-template-columns:minmax(0,160px) minmax(0,1fr)}
  }
  @media (max-width:720px){
    .store-item{grid-template-columns:1fr}
    .store-item__thumb{aspect-ratio:4/3}
    .store-item__header{flex-direction:column;align-items:flex-start}
  }
  @media (max-width:520px){
    .topbar .nav a{padding:8px 12px;font-size:12px}
    .panel{padding:18px}
    .store-item{padding:18px}
  }
  @media (max-width:420px){
    .store-wrap{padding:28px 16px 48px}
  }
  @media (max-width:380px){
    .topbar .nav a{padding:8px 10px;font-size:11.5px}
  }
</style>
</head>
<body>
<!-- A2HS Banner -->
<div id="a2hsBanner" aria-hidden="true">
  <div class="wrap" style="max-width:1100px;margin:0 auto;padding:0 16px;">
    <button class="close" type="button" aria-label="Close" data-i18n-attr="aria-label:common.close">×</button>
   <img class="icon" src="icon/icon-512.png" alt="Chakaroun Jewelry icon" data-i18n-attr="alt:brand.logoAlt">
    <div class="txt">
      <div class="brand-title" data-i18n="brand.title">Chakaroun Jewelry</div>
      <div class="brand-byline" data-i18n="brand.byline">by Hassan Chakaroun &amp; Ali Jouni</div>
      <div class="banner-copy" data-i18n="a2hs.banner">Add it to your Home Screen.</div>
    </div>
    <button class="cta" type="button" id="a2hsGet" data-i18n="a2hs.install">Install</button>
  </div>
</div>

<!-- iOS Guide -->
<div id="a2hsModal" aria-hidden="true">
  <div class="sheet" role="dialog" aria-modal="true" aria-labelledby="a2hsTitle">
    <button class="x" type="button" aria-label="Close" data-i18n-attr="aria-label:common.close">×</button>
    <h3 id="a2hsTitle" data-i18n="a2hs.title">Add “Chakaroun Jewelry” to Home Screen</h3>
    <div class="steps">
      <div class="row">
        <div><strong>1.</strong> <span data-i18n="a2hs.step1">Tap <em>Share</em> in Safari.</span></div>
        <img class="stepimg" src="./icon/share.jpg" alt="iPhone Share button screenshot">
      </div>
      <div class="row">
        <div><strong>2.</strong> <span data-i18n="a2hs.step2">Choose <em>Add to Home Screen</em>, then <em>Add</em>.</span></div>
        <img class="stepimg" src="./icon/save%20to%20home%20screen.jpeg" alt="Add to Home Screen screenshot">
      </div>
    </div>
  </div>
</div>

<header class="topbar">
  <div class="wrap">
    <a class="brand" href="index.html" aria-label="Chakaroun Jewelry — by Hassan Chakaroun &amp; Ali Jouni" data-i18n-attr="aria-label:brand.aria">
      <img src="icon/icon-512.png" alt="Chakaroun Jewelry logo" data-i18n-attr="alt:brand.logoAlt">
      <span class="brand-stack">
        <span class="brand-title" data-i18n="brand.title">Chakaroun Jewelry</span>
        <small class="brand-byline" data-i18n="brand.byline">by Hassan Chakaroun &amp; Ali Jouni</small>
      </span>
    </a>
    <nav class="nav">
      <a href="index.html" data-i18n="nav.builder">Builder</a>
      <a href="store.html" aria-current="page" data-i18n="nav.store">Store</a>
      <a href="about.html" data-i18n="nav.about">About</a>
      <select id="themeSelectTop" aria-label="Select theme" data-i18n-attr="aria-label:common.theme.select">
        <option value="dark" data-i18n="theme.dark">Dark</option>
        <option value="light" data-i18n="theme.light">Light</option>
        <option value="plum" data-i18n="theme.plum">Plum</option>
        <option value="custom" data-i18n="theme.custom">Custom</option>
      </select>
      <select id="langSelectTop" aria-label="Select language">
        <option value="en">English</option>
        <option value="ar">العربية</option>
        <option value="fr">Français</option>
        <option value="it">Italiano</option>
      </select>
    </nav>
  </div>
</header>

<main class="store-wrap">
  <section class="card">
    <div class="head">
      <h1 data-i18n="store.title">Store</h1>
      <span class="badge" data-i18n="store.badge">Atelier selections</span>
    </div>
    <div class="panel" id="storeList" data-i18n="store.loading" aria-live="polite">Loading…</div>
  </section>
</main>

<script src="scripts/a2hs.js"></script>
<script src="scripts/translations.js"></script>
<script>
(function () {
  const SHEET_ID = "1zHRWiXCF_SldNShxN_KEEcdhry86JZu61gC3gN6slTk";
  const SHEET_NAME = "Form Responses 1";
  const TQ = encodeURIComponent("select A,B,C,D,E,F,G,H");
  const URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=${encodeURIComponent(SHEET_NAME)}&tqx=out:json&tq=${TQ}`;

  const out = document.getElementById("storeList");

  let __t = (key, vars) => {
    const lang = document.documentElement.lang || 'en';
    const dict = window.__TRANSLATIONS?.[lang] || {};
    const fallback = window.__TRANSLATIONS?.en || {};
    let value = dict[key];
    if(value == null) value = fallback[key];
    if(value == null) value = key;
    if(typeof value === 'string' && vars && typeof vars === 'object'){
      value = value.replace(/\{\{(\w+)\}\}/g, (_, name) => (vars[name] ?? ''));
    }
    return value;
  };

  function syncTranslator(){
    const lang = document.documentElement.lang || 'en';
    __t = (key, vars)=>{
      const dict = window.__TRANSLATIONS?.[lang] || {};
      const fallback = window.__TRANSLATIONS?.en || {};
      let value = dict[key];
      if(value == null) value = fallback[key];
      if(value == null) value = key;
      if(typeof value === 'string' && vars && typeof vars === 'object'){
        value = value.replace(/\{\{(\w+)\}\}/g, (_, name) => (vars[name] ?? ''));
      }
      return value;
    };
  }
  let lastProducts = [];
  let lastStatus = 'loading';

  syncTranslator();

  window.addEventListener('DOMContentLoaded', syncTranslator);
  window.addEventListener('hcj:lang', ()=>{
    syncTranslator();
    if(!out) return;
    if(lastStatus === 'products'){
      render(lastProducts);
    }else if(lastStatus === 'empty'){
      out.removeAttribute('data-i18n');
      out.innerHTML = `<span class="badge">${__t('store.empty')}</span>`;
    }else if(lastStatus === 'error'){
      out.removeAttribute('data-i18n');
      out.innerHTML = `<span class="badge">${__t('store.loadFail')}</span>`;
    }else{
      out.setAttribute('data-i18n', 'store.loading');
      out.textContent = __t('store.loading') || out.textContent;
    }
  });

  /* ================== Live gold pricing (every 10s) ================== */
  // Endpoints (free) – we’ll race them for speed:
  const GOLDAPI_FREE = [
    "https://api.gold-api.com/price/XAU",
    "https://api.gold-api.com/price/XAU/USD",
    "https://www.gold-api.com/price/XAU",
    "https://www.gold-api.com/price/XAU/USD"
  ];

  // Pull the ounce price from whatever shape the API returns
  function pickOuncePrice(d){
    const c = [d?.price, d?.usd, d?.usd_ounce, d?.price_ounce, d?.ounce, d?.oz,
               d?.result?.price, d?.XAU?.USD].map(Number).filter(v => isFinite(v) && v > 0);
    if (c.length) return c[0];
    // If only gram(24k) is given, convert to ounce (≈31.1)
    const g24 = Number(d?.gram_24k || d?.price_gram_24k || d?.g24 || d?.per_gram);
    return (isFinite(g24) && g24 > 0) ? g24 * 31.1 : NaN;
  }
  function timeoutFetch(u,ms){
    const c = new AbortController(); const id = setTimeout(() => c.abort(), ms);
    return fetch(u,{signal:c.signal,cache:"no-store"}).finally(() => clearTimeout(id));
  }
  async function getSpotFast(){
    const tries = GOLDAPI_FREE.map(u =>
      timeoutFetch(u,3500)
        .then(r => r.ok ? r.json() : Promise.reject(r.status))
        .then(pickOuncePrice)
        .then(v => (isFinite(v) && v > 0) ? v : Promise.reject("bad"))
    );
    return Promise.any(tries);
  }

  // 18k: ((oz + 30)*32*750/995) + fee
  // 21k: ((oz + 30)*32*875/995) + fee
  // 22k: ((oz + 30)*32*916/995) + fee
  // 24k: ((oz + 30)/31.1)       + fee
  function perGramForKirat(oz, kiratStr, fee){
    const k   = String(kiratStr || "").toLowerCase();
    const add = Number.isFinite(fee) ? fee : 10; // fallback to 10 if the sheet cell is empty
    if (/\b18\b/.test(k)) return (((oz + 30) * 32 * 750 / 995)/1000) + add;
    if (/\b21\b/.test(k)) return (((oz + 30) * 32 * 875 / 995)/1000) + add;
    if (/\b22\b/.test(k)) return (((oz + 30) * 32 * 916 / 995)/1000) + add;
    if (/\b24\b/.test(k)) return (((oz + 30) / 31.1)/1000) + add;
    return NaN;
  }

  function computeItemPriceUSD(oz, product){
    const w   = toNum(product.weight);
    if (!Number.isFinite(w) || w <= 0) return NaN;
    const fee = toNum(product.fee);      // ← “أجور + ربح ex.2.5” (per gram) from column H
    const ppg = perGramForKirat(oz, product.kirat, fee);
    return Number.isFinite(ppg) ? (ppg * w) : NaN;
  }

  // Start a 10s refresh loop to update prices in-place
  const REFRESH_MS = 10_000;
  let _priceTimer = null;
  function startSpotRefresh(products){
    async function tick(){
      try{
        const oz = await getSpotFast();
        // Fill/override price for every product based on kirat & weight
        products.forEach(p => {
          const calc = computeItemPriceUSD(oz, p);
          if (isFinite(calc)) p.price = Math.round(calc); // round how you like
        });
        render(products);
      }catch(e){
        // On failure just keep whatever is rendered now
      }
    }
    // run now + schedule
    tick();
    if (_priceTimer) clearInterval(_priceTimer);
    _priceTimer = setInterval(tick, REFRESH_MS);
  }

  const ESCAPE = {"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"};
  function escapeHtml(value){
    return String(value == null ? "" : value).replace(/[&<>"']/g, function(ch){ return ESCAPE[ch] || ch; });
  }
  function sentenceCase(str){
    const trimmed = String(str == null ? "" : str).trim();
    if(!trimmed){ return ""; }
    if(trimmed === trimmed.toUpperCase()){
      const lower = trimmed.toLowerCase();
      return lower.charAt(0).toUpperCase() + lower.slice(1);
    }
    if(trimmed === trimmed.toLowerCase()){
      return trimmed.charAt(0).toUpperCase() + trimmed.slice(1);
    }
    return trimmed.charAt(0).toUpperCase() + trimmed.slice(1);
  }
  // Split a cell that may contain multiple links (comma, semicolon, or newline)
  function splitLinks(value){
    if (!value) return [];
    // If GViz gave an <a href> chip, pull its href and return as a single-item array
    const str = String(value).trim();
    const hrefMatch = str.match(/href="([^"]+)"/i);
    if (hrefMatch) return [hrefMatch[1]];

    // Otherwise, split on commas/semicolons/newlines and trim
    return str.split(/[\n,;]+/).map(s => s.trim()).filter(Boolean);
  }

  // Convert Drive links (open?id=... or /file/d/ID/...) -> direct image URLs
  function driveImages(value){
    const links = Array.isArray(value) ? value : splitLinks(value);
    return links.map(link => {
      // accept both /file/d/ID and ...?id=ID
      const m = link.match(/\/d\/([a-zA-Z0-9_-]+)/) || link.match(/[?&]id=([^&]+)/);
      const id = m ? m[1] : null;
      if (!id) return link; // if it's not Drive, use as-is
      // fast thumbnail endpoint that works in <img>
      return `https://lh3.googleusercontent.com/d/${id}=w1200`;
    });
  }
  function money(n) {
    const v = Number(n);
    return Number.isFinite(v) ? v.toLocaleString(undefined, {minimumFractionDigits:0}) : "";
  }

  // Parses "2.5" or "2,5" into a Number. Returns NaN if not numeric.
  function toNum(v){
    const s = String(v ?? "").trim()
      // Arabic decimal comma -> dot
      .replace(",", ".")
      // strip everything except digits, minus, and dot
      .replace(/[^\d.-]/g, "");
    const n = parseFloat(s);
    return Number.isFinite(n) ? n : NaN;
  }

  function render(products) {
    if(!out) return;
    out.removeAttribute('data-i18n');
    if (!products.length) {
      lastProducts = products;
      lastStatus = 'empty';
      out.innerHTML = `<span class="badge">${__t('store.empty')}</span>`;
      return;
    }
    lastProducts = products;
    lastStatus = 'products';
    const cards = products.map(p => {
      const title = sentenceCase(p.name || "");
      const safeTitle = escapeHtml(title);
      const photos = driveImages(p.photo);
      const main   = photos[0] || "";
      const price = money(p.price);
      const description = escapeHtml(p.description || "");
      const kirat = p.kirat ? `<span>${__t('store.karat')} ${escapeHtml(p.kirat)}</span>` : "";
      const sku = p.sku ? `<span>${__t('store.sku')} ${escapeHtml(p.sku)}</span>` : "";
      const weight = p.weight ? `<span>${__t('store.weight')} ${escapeHtml(p.weight)} g</span>` : "";
      const badgeClass = (p.in_stock && Number(p.in_stock) > 0) ? "store-item__badge store-item__badge--stock" : "store-item__badge";
      const badgeLabel = (p.in_stock && Number(p.in_stock) > 0) ? __t('store.inStock') : __t('store.outOfStock');
      const metaBits = [kirat, weight, sku, `<span class="${badgeClass}">${badgeLabel}</span>`]
        .filter(Boolean)
        .join("\n");
      return `
        <article class="store-item card">
          <figure class="store-item__thumb">
            ${main ? `<img class="js-main" src="${escapeHtml(main)}" alt="${safeTitle || 'Bracelet photo'}" loading="lazy">`
                   : `<div class="store-item__placeholder" aria-hidden="true"></div>`}
            ${photos.length > 1 ? `
              <div class="count-badge">${photos.length}</div>
              <div class="store-item__thumbs">
                ${photos.map((u,i)=>`
                  <img class="js-thumb ${i===0?'is-active':''}" src="${escapeHtml(u)}" alt="thumb ${i+1}" loading="lazy" />
                `).join('')}
              </div>
            ` : ``}
          </figure>
          <div class="store-item__body">
            <div class="store-item__header">
              <h3 class="store-item__title">${safeTitle}</h3>
              ${price ? `<div class="store-item__price">${price}<span class="store-item__currency">USD</span></div>` : ""}
            </div>
            ${description ? `<p class="store-item__description">${description}</p>` : ""}
            <div class="store-item__meta">${metaBits}</div>
          </div>
        </article>
      `;
    }).join("\n");
    out.innerHTML = cards;

    // Wire gallery clicks (event delegation)
    out.querySelectorAll('.store-item').forEach(card => {
      const mainImg = card.querySelector('.store-item__thumb .js-main');
      const thumbs = card.querySelectorAll('.store-item__thumbs .js-thumb');
      if (!mainImg || !thumbs.length) return;
      thumbs.forEach(t => {
        t.addEventListener('click', () => {
          thumbs.forEach(x => x.classList.remove('is-active'));
          t.classList.add('is-active');
          const next = t.getAttribute('src');
          if (next) mainImg.setAttribute('src', next);
        });
      });
    });
  }

  fetch(URL)
    .then(r => r.text())
    .then(txt => {
      const json = JSON.parse(txt.substring(47, txt.length - 2));
      const rows = (json.table?.rows || []);
      const products = rows.map(r => {
        // Keep both the raw value (v) and the formatted value (f)
        const cells = (r.c || []).map(c => c ? (c.f || c.v || "") : "");

        // Columns: A Timestamp, B name, C weight, D kirat, E description, F sku, G photo, H fee ("أجور + ربح ex.2.5")
        const name        = cells[1];
        const weight      = cells[2];
        const kirat       = cells[3];
        const description = cells[4];
        const sku         = cells[5];
        const photo       = cells[6];
        const fee         = cells[7];

        // You don’t have price or in_stock in the form yet — set sensible defaults
        const price = "";
        const in_stock = 1;

        return { name, price, kirat, photo, description, sku, in_stock, weight, fee };
      });
      startSpotRefresh(products);
    })
    .catch(err => {
      console.error(err);
      if(out){
        out.removeAttribute('data-i18n');
        out.innerHTML = `<span class="badge">${__t('store.loadFail')}</span>`;
      }
      lastProducts = [];
      lastStatus = 'error';
    });
})();
</script>
<script>
(function(){
  const KEY = window.__HCJ_THEME_KEY || 'hcj-theme';
  const THEMES = ['light','dark','plum','custom'];
  const top = document.getElementById('themeSelectTop');
  const inner = document.getElementById('themeSelect');
  function applySharedTheme(t){
    const next = THEMES.includes(t) ? t : 'light';
    if(typeof window.applyTheme === 'function'){
      window.applyTheme(next);
    }else{
      document.documentElement.dataset.theme = next;
    }
    try{ localStorage.setItem(KEY,next);}catch(_){ }
    if(inner && inner !== top) inner.value = next;
    return next;
  }
  let saved = 'light';
  try{ saved = localStorage.getItem(KEY) || document.documentElement.dataset.theme || 'light'; }catch(_){ }
  applySharedTheme(saved);
  if(top){
    top.value = saved;
    top.addEventListener('change', e => applySharedTheme(e.target.value));
  }
})();
</script>
<script>
  if('serviceWorker' in navigator){
    window.addEventListener('load', function(){
      navigator.serviceWorker.register('sw.js').catch(function(){});
    });
  }
</script>
<script>
/* ===== Minimal i18n engine (shared) ===== */
(function () {
  const LANG_KEY = 'hcj-lang';
  const langSelect = document.getElementById('langSelectTop');

  function translate(key, vars){
    const lang = document.documentElement.lang || 'en';
    const dict = window.__TRANSLATIONS?.[lang] || {};
    const fallback = window.__TRANSLATIONS?.en || {};
    let value = dict[key];
    if(value == null) value = fallback[key];
    if(value == null) value = '';
    if(typeof value === 'string' && vars && typeof vars === 'object'){
      value = value.replace(/\{\{(\w+)\}\}/g, (_, name) => (vars[name] ?? ''));
    }
    return value;
  }

  function t(key, vars){
    return translate(key, vars);
  }

  function applyDir(lang){
    document.documentElement.lang = lang;
    document.documentElement.dir = (lang === 'ar') ? 'rtl' : 'ltr';
  }

  function translateDOM(){
    document.querySelectorAll('[data-i18n]').forEach(el => {
      const key = el.getAttribute('data-i18n');
      const txt = t(key);
      if (txt) el.textContent = txt;
    });
    document.querySelectorAll('[data-i18n-attr]').forEach(el => {
      const map = el.getAttribute('data-i18n-attr').split(';').map(s=>s.trim()).filter(Boolean);
      map.forEach(pair=>{
        const [attr, key] = pair.split(':').map(s=>s.trim());
        const val = t(key);
        if(attr && val) el.setAttribute(attr, val);
      });
    });
  }

  function setLang(lang){
    applyDir(lang);
    try { localStorage.setItem(LANG_KEY, lang); } catch(e) {}
    translateDOM();
    window.dispatchEvent(new CustomEvent('hcj:lang', { detail: { lang } }));
  }

  let saved = 'en';
  try { saved = localStorage.getItem(LANG_KEY) || 'en'; } catch(e) {}
  applyDir(saved);

  if(langSelect){
    langSelect.value = saved;
    langSelect.addEventListener('change', e => setLang(e.target.value));
  }
  window.addEventListener('DOMContentLoaded', translateDOM);
})();
</script>
</body>
</html>
