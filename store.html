<!doctype html>
<html lang="en" data-theme="light">
<head>
<script>
  // Apply saved theme ASAP (before CSS loads to avoid a flash)
  (function () {
    try {
      var KEY = 'hcj-theme';
      var saved = localStorage.getItem(KEY) || 'light';
      document.documentElement.setAttribute('data-theme', saved);
      // expose the key so other scripts can use the same one
      window.__HCJ_THEME_KEY = KEY;
    } catch (e) {}
  })();
</script>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Hassan Chakaroun Jewelry — Store</title>

<!-- PWA + Icons -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#17120a">
<link rel="icon" href="icon/icon-1000.svg" type="image/svg+xml">
<link rel="apple-touch-icon" href="icon/icon-500.png">

<!-- Basic SEO/Open Graph -->
<meta name="description" content="Handcrafted gold jewelry. Live-priced by gold rate soon.">
<meta property="og:title" content="Hassan Chakaroun Jewelry — Store">
<meta property="og:description" content="Handcrafted gold jewelry.">
<meta property="og:type" content="website">
<meta property="og:image" content="icon/icon-500.png">

<style>
  :root{--radius:14px;--shadow:0 18px 36px rgba(0,0,0,.45)}
  /* reuse your themes (copied light/dark/plum vars) */
  html[data-theme="dark"]{
    --bg:#17120a;--bg2:#0f0b06;--card:#211a0e;--card-overlay:rgba(48,37,19,.86);
    --ink:#fff7e6;--muted:#e8d9b3;--gold:#d4af37;--gold2:#b88a1a;
    --border-soft:rgba(212,175,55,.18);--border-strong:rgba(212,175,55,.35);
    --control-border:rgba(212,175,55,.22);--control-bg:rgba(23,18,10,.75);
    --control-focus-bg:rgba(33,26,14,.85);--control-focus-shadow:rgba(212,175,55,.18);
    --head-bg:rgba(15,11,6,.45);--summary-bg:rgba(23,18,10,.85);
    --preview-glow:rgba(212,175,55,.12);--tab-bg:rgba(23,18,10,.75);--tab-active-bg:rgba(33,26,14,.85);
    --hud-bg:rgba(21,15,8,.72);--hud-border:rgba(212,175,55,.2);--hud-text:#fff7e6;
    --button-top:rgba(212,175,55,.16);--button-bottom:rgba(184,138,26,.16);
    --button-hover-top:rgba(212,175,55,.28);--button-hover-bottom:rgba(184,138,26,.2)
  }
  html:not([data-theme]), html[data-theme="light"]{
    --bg:#f6f2ea;--bg2:#e4e9f3;--card:#ffffff;--card-overlay:rgba(255,255,255,.9);
    --ink:#2b261c;--muted:#706b60;--gold:#c8892c;--gold2:#a56a18;
    --border-soft:rgba(200,137,44,.28);--border-strong:rgba(200,137,44,.45);
    --control-border:rgba(200,137,44,.34);--control-bg:rgba(250,244,234,.92);
    --control-focus-bg:rgba(255,250,243,.97);--control-focus-shadow:rgba(200,137,44,.3);
    --head-bg:rgba(242,234,220,.76);--summary-bg:rgba(255,250,243,.92);
    --preview-glow:rgba(200,137,44,.2);--tab-bg:rgba(250,244,234,.88);--tab-active-bg:rgba(255,250,243,.96);
    --hud-bg:rgba(255,250,243,.96);--hud-border:rgba(200,137,44,.38);--hud-text:#2b261c;
    --button-top:rgba(200,137,44,.22);--button-bottom:rgba(165,106,24,.18);
    --button-hover-top:rgba(200,137,44,.32);--button-hover-bottom:rgba(165,106,24,.26)
  }
  html[data-theme="plum"]{
    --bg:#160b19;--bg2:#341844;--card:#2b1433;--card-overlay:rgba(73,35,94,.72);
    --ink:#f8ecff;--muted:#d5c0ec;--gold:#d794ff;--gold2:#b162e4;
    --border-soft:rgba(215,148,255,.32);--border-strong:rgba(215,148,255,.48);
    --control-border:rgba(215,148,255,.36);--control-bg:rgba(41,20,51,.78);
    --control-focus-bg:rgba(55,28,68,.86);--control-focus-shadow:rgba(215,148,255,.26);
    --head-bg:rgba(39,18,50,.65);--summary-bg:rgba(41,20,51,.82);
    --preview-glow:rgba(215,148,255,.18);--tab-bg:rgba(41,20,51,.78);--tab-active-bg:rgba(55,28,68,.88)
  }

  *{box-sizing:border-box}
  body{
    margin:0;color:var(--ink);
    background:
      radial-gradient(1100px 500px at 15% -15%, rgba(0,0,0,0) 0%, transparent 60%),
      radial-gradient(900px 600px at 120% 0%, rgba(0,0,0,0) 0%, transparent 70%),
      linear-gradient(160deg, var(--bg) 0%, var(--bg2) 100%);
    font:15.5px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial
  }

  /* top bar */
  .topbar{
    position:sticky;top:0;z-index:50;
    background:var(--head-bg);backdrop-filter:saturate(1.2) blur(6px);
    border-bottom:1px solid var(--border-soft)
  }
  .topbar .wrap{max-width:1200px;margin:0 auto;padding:10px 16px;display:flex;align-items:center;gap:14px}
  .brand{display:flex;align-items:center;gap:10px;font-weight:800;letter-spacing:.4px;text-decoration:none;color:var(--ink)}
  .brand img{width:36px;height:36px;border-radius:8px}
  .brand span{font-size:16px}
  .nav{margin-left:auto;display:flex;gap:10px}
  .nav a{color:var(--ink);text-decoration:none;border:1px solid var(--border-soft);padding:8px 12px;border-radius:10px}
  .nav a:hover{border-color:var(--gold)}
  .nav a[aria-current="page"]{border-color:var(--gold);color:var(--gold)}

  /* grid */
  .container{max-width:1200px;margin:22px auto;padding:0 16px}
  .grid{
    display:grid;gap:16px;
    grid-template-columns:repeat( auto-fill, minmax(240px, 1fr) );
  }
  .card{
    background:linear-gradient(160deg,var(--card-overlay),var(--card));
    border:1px solid var(--border-soft);border-radius:14px;overflow:hidden;box-shadow:var(--shadow)
  }
  .thumb{
    position:relative;aspect-ratio:1/1;border-bottom:1px solid var(--border-soft);background:var(--bg2);
    overflow:hidden
  }
  .thumb img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;transition:opacity .35s ease}
  .thumb img.alt{opacity:0}
  .thumb:hover img.alt{opacity:1}
  .thumb:hover img.main{opacity:0}

  .panel{padding:12px 14px}
  .title{margin:0 0 4px;font-size:16px;font-weight:700}
  .meta{font-size:12px;color:var(--muted)}
  .priceBox{
    margin-top:10px;display:flex;align-items:center;justify-content:space-between;gap:8px
  }
  .price{
    font-size:18px;font-weight:800;color:var(--gold)
  }
  .btn{
    appearance:none;border:1px solid var(--border-strong);background:linear-gradient(180deg,var(--button-top),var(--button-bottom));
    padding:8px 12px;border-radius:10px;color:var(--ink);cursor:pointer
  }
  .btn:hover{border-color:var(--gold)}

  /* comments (local only for now) */
  .comments{border-top:1px solid var(--border-soft);margin-top:10px;padding-top:10px}
  .comments h4{margin:0 0 8px;font-size:13px;color:var(--muted)}
  .comments ul{list-style:none;margin:0;padding:0;display:flex;flex-direction:column;gap:8px;max-height:120px;overflow:auto}
  .comments li{font-size:13px;background:var(--control-bg);border:1px solid var(--control-border);padding:6px 8px;border-radius:8px}
  .comments form{display:flex;gap:8px;margin-top:8px}
  .comments input{flex:1;padding:8px 10px;border-radius:8px;border:1px solid var(--control-border);background:var(--control-bg);color:var(--ink)}
  .comments input:focus{outline:none;border-color:var(--gold);box-shadow:0 0 0 2px var(--control-focus-shadow)}

  /* === Store grid === */
  .productsGrid{
    display:grid;
    grid-template-columns:repeat(auto-fill,minmax(240px,1fr));
    gap:14px;
  }
  .productCard{
    display:flex;flex-direction:column;overflow:hidden;
    background:linear-gradient(160deg,var(--card-overlay),var(--card));
    border:1px solid var(--border-soft);border-radius:12px;box-shadow:var(--shadow);
  }
  .productCard .photo{
    aspect-ratio:4/3;background:var(--bg2);display:flex;align-items:center;justify-content:center;
  }
  .productCard img{width:100%;height:100%;object-fit:cover;display:block}
  .productCard .info{padding:12px 14px;display:flex;flex-direction:column;gap:6px}
  .productCard .title{margin:0;font-size:16px}
  .productCard .desc{margin:0;color:var(--muted);font-size:13px}
  .productCard .meta{display:flex;gap:8px;align-items:center;color:var(--muted);font-size:12px}
  .productCard .tag{border:1px solid var(--border-soft);padding:2px 8px;border-radius:999px}
  .productCard .price{margin-top:6px;font-weight:800;color:var(--gold)}
  #storeStatus{color:var(--muted);margin-bottom:10px}
</style>
</head>
<body>

<header class="topbar">
  <div class="wrap">
    <a class="brand" href="index.html">
      <img src="icon/icon-500.png" alt="Logo">
      <span>Hassan Chakaroun Jewelry</span>
    </a>
    <nav class="nav">
      <a href="index.html">Bracelet Builder</a>
      <a href="store.html" aria-current="page">Store</a>
    </nav>
  </div>
</header>

<main class="container">
  <h1 style="margin:6px 0 14px;font-size:22px;">Store</h1>
  <section class="card">
    <div class="panel">
      <div id="storeStatus" class="badge">Loading products…</div>
      <div id="productsGrid" class="productsGrid"></div>
    </div>
  </section>
</main>

<script>
/* === Google Sheet → Store grid === */
const SHEET_CSV_URL =
  'https://docs.google.com/spreadsheets/d/1zHRWiXCF_SldNShxN_KEEcdhry86JZu61gC3gN6slTk/gviz/tq?tqx=out:csv&sheet=Sheet1';

const currencyFmt = new Intl.NumberFormat('en-US',{style:'currency',currency:'USD'});
const grid = document.getElementById('productsGrid');
const statusEl = document.getElementById('storeStatus');

loadStore().catch(err=>{
  console.error(err);
  if(statusEl) statusEl.textContent = 'Could not load products.';
});

async function loadStore(){
  statusEl.textContent = 'Loading products…';
  const res = await fetch(SHEET_CSV_URL, {cache:'no-store'});
  const csv = await res.text();
  const rows = parseCSV(csv);
  const items = normalizeRows(rows);
  render(items);
  statusEl.textContent = items.length ? `${items.length} products` : 'No products yet.';
}

function normalizeRows(rows){
  if(!rows.length) return [];
  const header = rows[0].map(h => (h||'').trim().toLowerCase());
  const idx = name => header.indexOf(name);

  const ix = {
    name: idx('name'),
    price: idx('price'),
    kirat: idx('kirat'),
    photo: idx('photo'),
    description: idx('description'),
    sku: idx('sku'),
    in_stock: idx('in_stock')
  };

  return rows.slice(1)
    .filter(r => r.some(v => String(v||'').trim() !== ''))
    .map(r => {
      const photo = toDriveViewURL(r[ix.photo] || '');
      return {
        name: r[ix.name] || 'Untitled',
        price: Number(r[ix.price] || 0),
        kirat: (r[ix.kirat] || '').toString().trim(),
        photo: photo,
        description: r[ix.description] || '',
        sku: r[ix.sku] || '',
        inStock: toBool(r[ix.in_stock])
      };
    })
    .filter(p => p.inStock);
}

function render(items){
  grid.innerHTML = items.map(cardHTML).join('');
}

function cardHTML(p){
  const price = isFinite(p.price) ? currencyFmt.format(p.price) : '';
  const kirat = p.kirat ? `<span class="tag">${escapeHTML(p.kirat)}K</span>` : '';
  const sku = p.sku ? `<span class="tag">SKU ${escapeHTML(p.sku)}</span>` : '';
  const img = p.photo ? escapeAttr(p.photo) : 'icon/icon-500.png';
  const alt = escapeAttr(p.name);

  return `
  <article class="productCard">
    <div class="photo">
      <img src="${img}" alt="${alt}" onerror="this.src='icon/icon-500.png'">
    </div>
    <div class="info">
      <h3 class="title">${escapeHTML(p.name)}</h3>
      <div class="meta">${kirat}${sku}</div>
      ${p.description ? `<p class="desc">${escapeHTML(p.description)}</p>` : ''}
      <div class="price">${price}</div>
    </div>
  </article>`;
}

/* --- helpers --- */
function parseCSV(text){
  const rows = []; let row = [], field = '', inQuotes = false;
  for(let i=0;i<text.length;i++){
    const c = text[i], next = text[i+1];
    if(c === '"'){
      if(inQuotes && next === '"'){ field += '"'; i++; }
      else inQuotes = !inQuotes;
    }else if(c === ',' && !inQuotes){
      row.push(field); field = '';
    }else if((c === '\n' || c === '\r') && !inQuotes){
      if(c === '\r' && next === '\n') i++;
      row.push(field); rows.push(row); row = []; field = '';
    }else{
      field += c;
    }
  }
  if(field.length || row.length){ row.push(field); rows.push(row); }
  return rows;
}

function toBool(v){
  const s = String(v||'').trim().toLowerCase();
  if(s === '') return true; // blank = treat as in stock
  return ['true','1','yes','y'].includes(s);
}

function toDriveViewURL(u){
  const s = String(u||'').trim();
  if(!s) return '';
  const m1 = s.match(/[?&]id=([a-zA-Z0-9_-]+)/);
  const m2 = s.match(/\/d\/([a-zA-Z0-9_-]+)/);
  const id = m1?.[1] || m2?.[1];
  return id ? `https://drive.google.com/uc?export=view&id=${id}` : s;
}

function escapeHTML(s){
  return String(s||'').replace(/[&<>"']/g, m => ({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m]));
}
function escapeAttr(s){ return escapeHTML(s).replace(/"/g,'&quot;'); }
</script>
</body>
</html>
