<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Gold Design — Bracelet Builder (pin-accurate, horizontal assets)</title>
<style>
  :root{--bg:#0f1220;--panel:#151931;--ink:#e9ecf1;--muted:#9aa3b2;--radius:14px;--shadow:0 12px 28px rgba(0,0,0,.35)}
  *{box-sizing:border-box}html,body{height:100%}
  body{margin:0;background:
    radial-gradient(1100px 500px at 10% -10%, #1b2142 0%, transparent 60%),
    radial-gradient(800px 500px at 120% 10%, #172449 0%, transparent 60%), var(--bg);
    color:var(--ink);font:15.5px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial}
  .wrap{max-width:1200px;margin:28px auto;padding:0 16px;display:grid;gap:18px;grid-template-columns:1fr 1.35fr}
  @media (max-width:980px){.wrap{grid-template-columns:1fr}}
  .card{background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,.02));
    border:1px solid rgba(255,255,255,.08);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden}
  .head{display:flex;align-items:center;justify-content:space-between;padding:16px 18px;border-bottom:1px solid rgba(255,255,255,.08)}
  .head h1{margin:0;font-size:18px}.badge{font-size:12px;color:var(--muted)}
  .panel{padding:16px 18px}
  label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
  select,input{width:100%;padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.15);background:#0f1428;color:var(--ink);outline:none}
  .grid2{display:grid;gap:12px;grid-template-columns:1fr 1fr}
  .rows{display:flex;flex-direction:column;gap:10px;margin-top:10px}
  .row{display:grid;grid-template-columns:1.2fr .7fr auto auto;gap:10px;align-items:end}
  button{appearance:none;background:#10142a;color:var(--ink);border:1px solid rgba(255,255,255,.14);padding:10px 14px;border-radius:12px;cursor:pointer}
  button:hover{border-color:rgba(255,255,255,.28)}
  .summary{margin-top:12px;padding:12px 14px;border-radius:12px;background:#0e1223;border:1px solid rgba(255,255,255,.08);display:flex;justify-content:space-between;align-items:center;gap:10px}
  .summary .w{color:#ffd37d}.buttons{display:flex;gap:10px;flex-wrap:wrap;margin-top:14px}
  .preview{display:flex;align-items:center;justify-content:center;background:#0b0f1c;min-height:420px}
  svg#stage{width:100%;height:100%;max-height:560px}
</style>
</head>
<body>
<div class="wrap">
  <section class="card">
    <div class="head">
      <h1>Bracelet Builder</h1>
      <span class="badge">Pin snapping · horizontal SVGs</span>
    </div>
    <div class="panel">
      <div class="grid2">
        <div>
          <label for="pendant">Pendant</label>
          <select id="pendant"></select>
        </div>
        <div>
          <label for="pendantScale">Pendant size (px height)</label>
          <input id="pendantScale" type="number" min="20" max="160" step="2" value="80"/>
        </div>
      </div>

      <div class="rows" id="rows"></div>
      <div style="margin-top:8px"><button id="addRow">+ Add link type</button></div>

      <div class="summary" role="status" aria-live="polite">
        <div><strong>Estimated Weight:</strong> <span class="w" id="weight">0.00 g</span></div>
        <div class="badge">Placeholder grams (18K). Edit in WEIGHTS.</div>
      </div>

      <div class="buttons">
        <button id="downloadSVG">Download SVG</button>
        <button id="downloadPNG">Download PNG</button>
        <button id="reset">Reset</button>
      </div>
    </div>
  </section>

  <section class="card">
    <div class="head">
      <h1>Preview</h1><span class="badge">Export 1080×400</span>
    </div>
    <div class="preview">
      <svg id="stage" viewBox="0 0 1080 400" role="img" aria-label="Bracelet preview">
        <defs id="defs">
          <linearGradient id="gold" x1="0" y1="0" x2="1" y2="1">
            <stop offset="0%" stop-color="#ffe7a4"/><stop offset="35%" stop-color="#ffd36e"/>
            <stop offset="60%" stop-color="#c3922e"/><stop offset="85%" stop-color="#fff2c6"/>
            <stop offset="100%" stop-color="#e2b34a"/>
          </linearGradient>
          <filter id="softShadow" x="-20%" y="-20%" width="140%" height="140%">
            <feDropShadow dx="0" dy="2" stdDeviation="2" flood-color="#000" flood-opacity=".35"/>
          </filter>
        </defs>
        <rect x="0" y="0" width="1080" height="400" fill="#0b0f1c"/>
        <g id="bracelet"></g>
      </svg>
    </div>
  </section>
</div>

<script>
"use strict";

/* ------------------------------- 1) Assets -------------------------------- */
const PENDANTS = [
  "Infinity Knot 1.svg","Infinity Knot 2.svg","Infinity Knot 3.svg","Infinity Knot 4.svg",
  "bee 1.svg","bee 2.svg","butterfly 1.svg","butterfly 2.svg",
  "cube 1.svg","dolphin 1.svg",
  "flower 1.svg","flower 2.svg","flower 3.svg","flower 4.svg",
  "turtle 1.svg"
];

const LINKS = [
  "oval 1.1.svg",  // your horizontal oval with pins
  // (you can add more links here when you convert them to horizontal + pins)
];

/* 2) Weights & layout meta (horizontal files; NO rotation here) */
const LINK_META = {
  // Smaller than before so it matches pendant scale better
  "oval 1.1.svg": { targetH: 36, rotate: 0 }   // only scale; we’ll snap by pins
};

const WEIGHTS = {
  // pendants
  "Infinity Knot 1.svg":0.32, "Infinity Knot 2.svg":0.33, "Infinity Knot 3.svg":0.34, "Infinity Knot 4.svg":0.35,
  "bee 1.svg":0.28, "bee 2.svg":0.29, "butterfly 1.svg":0.32, "butterfly 2.svg":0.33,
  "cube 1.svg":0.25, "dolphin 1.svg":0.29,
  "flower 1.svg":0.30, "flower 2.svg":0.30, "flower 3.svg":0.31, "flower 4.svg":0.31,
  "turtle 1.svg":0.33,
  // per link piece
  "oval 1.1.svg":0.08,
  "__default_pendant":0.30, "__default_link":0.10
};

/* ------------------------------- 3) DOM ----------------------------------- */
const stage = document.getElementById("stage");
const defs = document.getElementById("defs");
const bracelet = document.getElementById("bracelet");
const selPendant = document.getElementById("pendant");
const inpPendantScale = document.getElementById("pendantScale");
const rowsBox = document.getElementById("rows");
const btnAddRow = document.getElementById("addRow");
const lblWeight = document.getElementById("weight");
const btnSVG = document.getElementById("downloadSVG");
const btnPNG = document.getElementById("downloadPNG");
const btnReset = document.getElementById("reset");

/* ------------------------------- 4) Utils --------------------------------- */
const enc = s => encodeURIComponent(s).replace(/%20/g," ");
async function fetchSVGText(path){ const r=await fetch(path); if(!r.ok) throw new Error("load "+path); return r.text(); }
function parseSVG(text){ return new DOMParser().parseFromString(text,"image/svg+xml").documentElement; }
function clear(n){ while(n.firstChild) n.removeChild(n.firstChild); }
function makeOption(t,v){ const o=document.createElement("option"); o.textContent=t; o.value=v; return o; }
function weightFor(name,type){ return WEIGHTS[name] ?? (type==="pendant" ? WEIGHTS.__default_pendant : WEIGHTS.__default_link); }

function numFromAttr(val, total){
  if(val==null) return null;
  const s = String(val).trim();
  if(s.endsWith("%")) return parseFloat(s)/100 * total;
  return parseFloat(s);
}

/* Load, scale, extract pins; no rotation needed for horizontal assets. */
async function loadWithPins(dir, filename, targetH){
  const url = `./${dir}/${enc(filename)}`;
  const svg = parseSVG(await fetchSVGText(url));

  // viewBox
  let vb = svg.getAttribute("viewBox");
  let w,h;
  if(vb){ const p = vb.trim().split(/\s+/).map(Number); w=p[2]; h=p[3]; }
  else{ w=parseFloat(svg.getAttribute("width"))||100; h=parseFloat(svg.getAttribute("height"))||100; }

  const scale = targetH / h;

  // extract pins BEFORE importing
  let pinLx=w*0.3, pinLy=h*0.5, pinRx=w*0.7, pinRy=h*0.5; // fallbacks
  const pinsG = svg.querySelector("#pins");
  if(pinsG){
    const pl = pinsG.querySelector("#pinL");
    const pr = pinsG.querySelector("#pinR");
    if(pl){ pinLx = numFromAttr(pl.getAttribute("cx"), w) ?? pinLx;
           pinLy = numFromAttr(pl.getAttribute("cy"), h) ?? pinLy; }
    if(pr){ pinRx = numFromAttr(pr.getAttribute("cx"), w) ?? pinRx;
           pinRy = numFromAttr(pr.getAttribute("cy"), h) ?? pinRy; }
  }

  // build a <g> that contains all visible geometry EXCEPT pins/defs
  const g = document.createElementNS("http://www.w3.org/2000/svg","g");
  [...svg.childNodes].forEach(n=>{
    if(n.nodeType!==1) return;
    const tag = n.tagName.toLowerCase();
    if(tag==="defs"){ // import defs safely with unique IDs
      [...n.children].forEach(el=>{
        const id = el.id ? `${filename.replace(/\W+/g,'_')}_${el.id}` : "";
        if(id) el.setAttribute("id", id);
        defs.appendChild(stage.ownerDocument.importNode(el,true));
      });
      return;
    }
    if(n.id==="pins") return; // skip pins group (hidden)
    g.appendChild(stage.ownerDocument.importNode(n,true));
  });

  // scale about (0,0) since files are horizontal already
  g.setAttribute("transform", `scale(${scale})`);

  return {
    node: g,
    width: w*scale,
    height: h*scale,
    pinL: { x: pinLx*scale, y: pinLy*scale },
    pinR: { x: pinRx*scale, y: pinRy*scale }
  };
}

/* ------------------------------- 5) UI init ------------------------------- */
(function init(){
  PENDANTS.forEach(n=> selPendant.appendChild(makeOption(n,n)));
  selPendant.value = PENDANTS[0];

  addRow({type:LINKS[0], qty:6});  // oval links by default on each side

  btnAddRow.addEventListener("click", ()=>addRow());
  selPendant.addEventListener("change", render);
  inpPendantScale.addEventListener("input", render);
  btnSVG.addEventListener("click", downloadSVG);
  btnPNG.addEventListener("click", downloadPNG);
  btnReset.addEventListener("click", ()=>{
    rowsBox.innerHTML="";
    addRow({type:LINKS[0], qty:6});
    selPendant.value=PENDANTS[0];
    inpPendantScale.value=80;
    render();
  });

  render();
})();

function addRow(init={type:LINKS[0], qty:6}){
  const row = document.createElement("div"); row.className="row";
  const sel = document.createElement("select"); LINKS.forEach(n=> sel.appendChild(makeOption(n,n))); sel.value = init.type;
  const qty = document.createElement("input"); qty.type="number"; qty.min="0"; qty.max="80"; qty.step="1"; qty.value = String(init.qty ?? 6);
  const addBtn=document.createElement("button"); addBtn.textContent="+ Duplicate";
  const delBtn=document.createElement("button"); delBtn.textContent="– Remove";

  row.appendChild(sel); row.appendChild(qty); row.appendChild(addBtn); row.appendChild(delBtn);
  rowsBox.appendChild(row);
  sel.addEventListener("change", render);
  qty.addEventListener("input", render);
  addBtn.addEventListener("click", ()=>{ addRow({type:sel.value, qty:qty.valueAsNumber||0}); render(); });
  delBtn.addEventListener("click", ()=>{ rowsBox.removeChild(row); render(); });
}

function readRows(){
  return [...rowsBox.querySelectorAll(".row")].map(r=>{
    const type = r.querySelector("select").value;
    const qty = r.querySelector('input[type="number"]').valueAsNumber||0;
    return {type, qty};
  }).filter(r=>r.qty>0);
}

/* ------------------------------- 6) Render (pin snapping) ----------------- */
let lastToken=0;
async function render(){
  const token=++lastToken;
  clear(bracelet);

  const rows = readRows();
  const pendantName = selPendant.value;
  const pendantH = Math.max(20, Math.min(160, inpPendantScale.valueAsNumber||80));

  // Load pendant (horizontal, with pins)
  let pendant;
  try{
    pendant = await loadWithPins("pendant", pendantName, pendantH);
  }catch(e){ console.error(e); pendant = null; }
  if(token!==lastToken) return;

  // Unique link types
  const uniq = [...new Set(rows.map(r=>r.type))];
  const linkDefs = {};
  for(const t of uniq){
    const meta = LINK_META[t] || {targetH:36, rotate:0};
    try{
      linkDefs[t] = await loadWithPins("link", t, meta.targetH);
    }catch(e){ console.error(e); }
    if(token!==lastToken) return;
  }

  /* --- Measure total footprint by simulating placement --- */
  const PAD=40, W=1080, H=400, midY=200;
  const leftSeq=[]; rows.forEach(r=>{ for(let i=0;i<r.qty;i++) leftSeq.push(r.type); });
  const rightSeq=[...leftSeq].reverse();

  let minX=Infinity, maxX=-Infinity;

  // Pendant at x=0 initially
  const pendantBox = { x:0, w:pendant.width };
  minX = Math.min(minX, 0);
  maxX = Math.max(maxX, pendant.width);

  // Right side (grow to the right from pendant.pinR.x)
  let xJoinR = pendant.pinR.x; // global join coordinate
  for(const t of rightSeq){
    const d = linkDefs[t]; if(!d) continue;
    const tx = xJoinR - d.pinL.x; // place so pinL sits at join
    minX = Math.min(minX, tx);
    maxX = Math.max(maxX, tx + d.width);
    xJoinR += (d.pinR.x - d.pinL.x); // advance join to this piece’s pinR
  }

  // Left side (grow to the left from pendant.pinL.x)
  let xJoinL = pendant.pinL.x;
  for(const t of leftSeq){
    const d = linkDefs[t]; if(!d) continue;
    const tx = xJoinL - d.pinR.x; // align its pinR to current join
    minX = Math.min(minX, tx);
    maxX = Math.max(maxX, tx + d.width);
    xJoinL -= (d.pinR.x - d.pinL.x); // move join left by piece length (pin distance)
  }

  const totalW = maxX - minX;
  const offsetX = Math.max(PAD, (W - totalW)/2) - minX; // shift so whole thing is centered with padding

  /* --- Draw left side --- */
  let curJoinL = offsetX + pendant.pinL.x;
  for(const t of leftSeq){
    const d = linkDefs[t]; if(!d) continue;
    const tx = curJoinL - d.pinR.x;
    const g = document.createElementNS("http://www.w3.org/2000/svg","g");
    g.setAttribute("transform", `translate(${tx}, ${midY - d.height/2})`);
    tintGold(d.node); g.appendChild(d.node.cloneNode(true)); bracelet.appendChild(g);
    curJoinL -= (d.pinR.x - d.pinL.x);
  }

  /* --- Draw pendant --- */
  const pendantTx = offsetX;
  const gp = document.createElementNS("http://www.w3.org/2000/svg","g");
  gp.setAttribute("transform", `translate(${pendantTx}, ${midY - pendant.height/2})`);
  tintGold(pendant.node); gp.appendChild(pendant.node); bracelet.appendChild(gp);

  /* --- Draw right side --- */
  let curJoinR2 = offsetX + pendant.pinR.x;
  for(const t of rightSeq){
    const d = linkDefs[t]; if(!d) continue;
    const tx = curJoinR2 - d.pinL.x;
    const g = document.createElementNS("http://www.w3.org/2000/svg","g");
    g.setAttribute("transform", `translate(${tx}, ${midY - d.height/2})`);
    tintGold(d.node); g.appendChild(d.node.cloneNode(true)); bracelet.appendChild(g);
    curJoinR2 += (d.pinR.x - d.pinL.x);
  }

  // Weight
  const pendantW = weightFor(pendantName,"pendant");
  const linksW = rows.reduce((s,r)=> s + weightFor(r.type,"link") * r.qty*2, 0);
  lblWeight.textContent = (pendantW + linksW).toFixed(2) + " g";
}

/* gold tint (preserves real holes; does NOT touch pins since we skip them) */
function tintGold(node){
  const w = document.createTreeWalker(node, NodeFilter.SHOW_ELEMENT);
  while(w.nextNode()){
    const el=w.currentNode, tag=el.tagName?.toLowerCase?.()||"";
    if(["path","circle","ellipse","rect","polygon","polyline","line"].includes(tag)){
      const fill = el.getAttribute("fill");
      const stroke = el.getAttribute("stroke");
      if(!fill || fill!=="none") el.setAttribute("fill","url(#gold)");
      if(stroke && stroke!=="none") el.setAttribute("stroke","#8a6a22");
      el.setAttribute("filter","url(#softShadow)");
    }
  }
}

/* ------------------------------ 7) Export --------------------------------- */
function downloadSVG(){
  const clone = stage.cloneNode(true);
  const xml = new XMLSerializer().serializeToString(clone);
  const blob = new Blob([xml],{type:"image/svg+xml;charset=utf-8"});
  const url = URL.createObjectURL(blob); trigger(url,"bracelet.svg");
}
function downloadPNG(){
  const clone = stage.cloneNode(true); clone.setAttribute("width","1080"); clone.setAttribute("height","400");
  const xml = new XMLSerializer().serializeToString(clone);
  const data = "data:image/svg+xml;base64," + btoa(unescape(encodeURIComponent(xml)));
  const img = new Image();
  img.onload = function(){
    const canvas=document.createElement("canvas"); canvas.width=1080; canvas.height=400;
    const ctx=canvas.getContext("2d"); ctx.drawImage(img,0,0,1080,400);
    canvas.toBlob(b=> trigger(URL.createObjectURL(b),"bracelet.png"),"image/png",0.98);
  };
  img.src = data;
}
function trigger(url,name){ const a=document.createElement("a"); a.href=url; a.download=name; document.body.appendChild(a); a.click(); a.remove(); setTimeout(()=>URL.revokeObjectURL(url),4000); }

/* helper */
function svgText(tag, attrs, text){ const el=document.createElementNS("http://www.w3.org/2000/svg",tag); for(const [k,v] of Object.entries(attrs)) el.setAttribute(k,String(v)); if(text) el.textContent=text; return el; }
</script>
</body>
</html>
