<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Gold Design — Bracelet Builder (Trial)</title>
  <style>
    :root{
      --bg:#0f1220; --panel:#151931; --ink:#e9ecf1; --muted:#9aa3b2;
      --accent:#7aa2ff; --ok:#92f2c1; --warn:#ffd37d; --radius:14px; --shadow:0 12px 28px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:
        radial-gradient(1100px 500px at 10% -10%, #1b2142 0%, transparent 60%),
        radial-gradient(800px 500px at 120% 10%, #172449 0%, transparent 60%),
        var(--bg);
      color:var(--ink); font:15.5px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial;
    }
    .wrap{max-width:1200px;margin:28px auto;padding:0 16px;display:grid;gap:18px;grid-template-columns:1fr 1.35fr}
    @media (max-width:980px){.wrap{grid-template-columns:1fr}}
    .card{background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.08); border-radius:var(--radius); box-shadow:var(--shadow); overflow:hidden}
    .head{display:flex;align-items:center;justify-content:space-between;padding:16px 18px;border-bottom:1px solid rgba(255,255,255,.08)}
    .head h1{margin:0;font-size:18px}
    .badge{font-size:12px;color:var(--muted)}
    .panel{padding:16px 18px}
    label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
    select,input{width:100%;padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.15);background:#0f1428;color:var(--ink);outline:none}
    .grid2{display:grid;gap:12px;grid-template-columns:1fr 1fr}
    .note{font-size:12px;color:var(--muted)}
    .rows{display:flex;flex-direction:column;gap:10px;margin-top:10px}
    .row{display:grid;grid-template-columns:1.2fr .7fr auto auto;gap:10px;align-items:end}
    .row button{height:40px}
    button{
      appearance:none;background:#10142a;color:var(--ink);border:1px solid rgba(255,255,255,.14);
      padding:10px 14px;border-radius:12px;cursor:pointer
    }
    button:hover{border-color:rgba(255,255,255,.28)}
    .summary{margin-top:12px;padding:12px 14px;border-radius:12px;background:#0e1223;border:1px solid rgba(255,255,255,.08);display:flex;justify-content:space-between;align-items:center;gap:10px}
    .summary .w{color:var(--warn)}
    .buttons{display:flex;gap:10px;flex-wrap:wrap;margin-top:14px}
    /* PREVIEW */
    .preview{display:flex;align-items:center;justify-content:center;background:#0b0f1c;min-height:420px}
    svg#stage{width:100%;height:100%;max-height:560px}
  </style>
</head>
<body>
  <div class="wrap">
    <!-- Controls -->
    <section class="card">
      <div class="head">
        <h1>Bracelet Builder</h1>
        <span class="badge">Loads your /pendant & /link SVGs</span>
      </div>
      <div class="panel">
        <div class="grid2">
          <div>
            <label for="pendant">Pendant</label>
            <select id="pendant"></select>
          </div>
          <div>
            <label for="pendantScale">Pendant size (px height)</label>
            <input id="pendantScale" type="number" min="20" max="160" step="2" value="80"/>
          </div>
        </div>

        <div class="rows" id="rows"></div>
        <div style="margin-top:8px">
          <button id="addRow">+ Add link type</button>
        </div>

        <div class="summary" role="status" aria-live="polite">
          <div>
            <strong>Estimated Weight:</strong> <span class="w" id="weight">0.00 g</span>
          </div>
          <div class="note">Placeholder weights (18K). Tweak in <code>WEIGHTS</code>.</div>
        </div>

        <div class="buttons">
          <button id="downloadSVG">Download SVG</button>
          <button id="downloadPNG">Download PNG</button>
          <button id="reset">Reset</button>
        </div>
        <p class="note" style="margin-top:8px">
          The preview is a straight bracelet: links(1..N) — pendant — mirror(…N..1).  
          Replace weights/asset lists later with your real data.
        </p>
      </div>
    </section>

    <!-- Preview -->
    <section class="card">
      <div class="head">
        <h1>Preview</h1>
        <span class="badge">Export 1080×400</span>
      </div>
      <div class="preview">
        <svg id="stage" viewBox="0 0 1080 400" role="img" aria-label="Bracelet preview">
          <defs id="defs">
            <linearGradient id="gold" x1="0" y1="0" x2="1" y2="1">
              <stop offset="0%" stop-color="#ffe7a4"/><stop offset="35%" stop-color="#ffd36e"/>
              <stop offset="60%" stop-color="#c3922e"/><stop offset="85%" stop-color="#fff2c6"/>
              <stop offset="100%" stop-color="#e2b34a"/>
            </linearGradient>
            <filter id="softShadow" x="-20%" y="-20%" width="140%" height="140%">
              <feDropShadow dx="0" dy="2" stdDeviation="2" flood-color="#000" flood-opacity=".35"/>
            </filter>
          </defs>
          <rect x="0" y="0" width="1080" height="400" fill="#0b0f1c"/>
          <g id="bracelet"></g>
        </svg>
      </div>
    </section>
  </div>

  <script>
  "use strict";

  /* ------------------------------------------------------------------
     1) Your asset names (match your repo)
     ------------------------------------------------------------------ */
  const PENDANTS = [
    "Infinity Knot 1.svg","Infinity Knot 2.svg","Infinity Knot 3.svg","Infinity Knot 4.svg",
    "bee 1.svg","bee 2.svg","butterfly 1.svg","butterfly 2.svg",
    "cube 1.svg","dolphin 1.svg",
    "flower 1.svg","flower 2.svg","flower 3.svg","flower 4.svg",
    "turtle 1.svg"
  ];
  const LINKS = [
    "Arrow Link.svg","Barrel Link.svg","Dual Orb Link.svg","Eclipse Link.svg","Floral Link.svg","Halo Link.svg"
  ];

  /* ------------------------------------------------------------------
     2) Placeholder weights (grams) — edit as you like
     ------------------------------------------------------------------ */
  const WEIGHTS = {
    // pendants
    "Infinity Knot 1.svg":0.32, "Infinity Knot 2.svg":0.33, "Infinity Knot 3.svg":0.34, "Infinity Knot 4.svg":0.35,
    "bee 1.svg":0.28, "bee 2.svg":0.29, "butterfly 1.svg":0.32, "butterfly 2.svg":0.33,
    "cube 1.svg":0.25, "dolphin 1.svg":0.29,
    "flower 1.svg":0.30, "flower 2.svg":0.30, "flower 3.svg":0.31, "flower 4.svg":0.31,
    "turtle 1.svg":0.33,
    // links per piece
    "Arrow Link.svg":0.08, "Barrel Link.svg":0.10, "Dual Orb Link.svg":0.12,
    "Eclipse Link.svg":0.09, "Floral Link.svg":0.11, "Halo Link.svg":0.10,
    // defaults
    "__default_pendant":0.30, "__default_link":0.10
  };

  /* ------------------------------------------------------------------
     3) DOM
     ------------------------------------------------------------------ */
  const stage = document.getElementById("stage");
  const defs = document.getElementById("defs");
  const bracelet = document.getElementById("bracelet");
  const selPendant = document.getElementById("pendant");
  const inpPendantScale = document.getElementById("pendantScale");
  const rowsBox = document.getElementById("rows");
  const btnAddRow = document.getElementById("addRow");
  const lblWeight = document.getElementById("weight");
  const btnSVG = document.getElementById("downloadSVG");
  const btnPNG = document.getElementById("downloadPNG");
  const btnReset = document.getElementById("reset");

  /* ------------------------------------------------------------------
     4) Helpers
     ------------------------------------------------------------------ */
  const enc = s => encodeURIComponent(s).replace(/%20/g," ");
  async function fetchSVGText(path){
    const res = await fetch(path);
    if(!res.ok) throw new Error("Failed to load " + path);
    return await res.text();
  }
  function parseSVG(text){
    const doc = new DOMParser().parseFromString(text,"image/svg+xml");
    // Prefer the inner contents of <svg> (so viewBox is available)
    const svg = doc.documentElement;
    return svg;
  }
  function makeOption(text, value){
    const o = document.createElement("option"); o.textContent=text; o.value=value; return o;
  }
  function clear(node){ while(node.firstChild) node.removeChild(node.firstChild); }

  // Return {node,width,height,viewBox:[x,y,w,h]}
  async function loadAndScaleSVG(dir, filename, targetHeight){
    const url = `./${dir}/${enc(filename)}`;
    const svg = parseSVG(await fetchSVGText(url));
    let vb = svg.getAttribute("viewBox");
    let w, h;
    if(vb){
      const [, , vw, vh] = vb.split(/\s+/).map(Number);
      w = vw; h = vh;
    }else{
      w = parseFloat(svg.getAttribute("width")) || 100;
      h = parseFloat(svg.getAttribute("height")) || 100;
    }
    const scale = targetHeight / h;
    const g = document.createElementNS("http://www.w3.org/2000/svg","g");
    // Move content inside a group to scale together
    // Import all children (excluding defs to avoid id clashes)
    [...svg.childNodes].forEach(n=>{
      if(n.nodeType===1){ // element
        if(n.tagName.toLowerCase()==="defs"){
          // inline defs to master <defs> with unique ids
          [...n.children].forEach(el=>{
            // ensure unique id
            const id = el.id ? `${filename.replace(/\W+/g,'_')}_${el.id}` : "";
            if(id) el.setAttribute("id", id);
            defs.appendChild(stage.ownerDocument.importNode(el,true));
          });
        }else{
          g.appendChild(stage.ownerDocument.importNode(n,true));
        }
      }
    });
    g.setAttribute("transform", `scale(${scale})`);
    return { node:g, width:w*scale, height:h*scale };
  }

  function weightFor(name, type){
    if(WEIGHTS[name]!=null) return WEIGHTS[name];
    return type==="pendant" ? WEIGHTS.__default_pendant : WEIGHTS.__default_link;
  }

  /* ------------------------------------------------------------------
     5) UI setup
     ------------------------------------------------------------------ */
  (function init(){
    // Pendant dropdown
    PENDANTS.forEach(n=> selPendant.appendChild(makeOption(n, n)));
    selPendant.value = PENDANTS[0];

    // First two link rows
    addRow({type:LINKS[0], qty:6});
    addRow({type:LINKS[1], qty:6});

    btnAddRow.addEventListener("click", ()=>addRow());
    selPendant.addEventListener("change", render);
    inpPendantScale.addEventListener("input", render);
    btnSVG.addEventListener("click", downloadSVG);
    btnPNG.addEventListener("click", downloadPNG);
    btnReset.addEventListener("click", ()=>{
      rowsBox.innerHTML="";
      addRow({type:LINKS[0], qty:6});
      addRow({type:LINKS[1], qty:6});
      selPendant.value=PENDANTS[0]; inpPendantScale.value=80;
      render();
    });

    render();
  })();

  function addRow(init={type:LINKS[0], qty:6}){
    const row = document.createElement("div"); row.className="row";
    const sel = document.createElement("select");
    LINKS.forEach(n=> sel.appendChild(makeOption(n,n)));
    sel.value = init.type || LINKS[0];

    const qty = document.createElement("input");
    qty.type="number"; qty.min="0"; qty.max="60"; qty.step="1"; qty.value = String(init.qty ?? 6);

    const addBtn = document.createElement("button"); addBtn.textContent="+ Duplicate";
    const delBtn = document.createElement("button"); delBtn.textContent="– Remove";

    row.appendChild(sel);
    row.appendChild(qty);
    row.appendChild(addBtn);
    row.appendChild(delBtn);
    rowsBox.appendChild(row);

    sel.addEventListener("change", render);
    qty.addEventListener("input", render);
    addBtn.addEventListener("click", ()=>{ addRow({type:sel.value, qty:qty.valueAsNumber||0}); render(); });
    delBtn.addEventListener("click", ()=>{ rowsBox.removeChild(row); render(); });

    render();
  }

  function readRows(){
    const rows = [...rowsBox.querySelectorAll(".row")].map(row=>{
      const sel = row.querySelector("select").value;
      const qty = row.querySelector('input[type="number"]').valueAsNumber || 0;
      return { type: sel, qty };
    }).filter(r=>r.qty>0);
    return rows;
  }

  /* ------------------------------------------------------------------
     6) Render bracelet
     ------------------------------------------------------------------ */
  let lastRenderToken = 0;
  async function render(){
    const token = ++lastRenderToken;
    clear(bracelet);

    const rows = readRows();
    const pendantName = selPendant.value;
    const pendantSize = Math.max(20, Math.min(160, inpPendantScale.valueAsNumber||80));
    // Load pendant
    let pendantPack;
    try{
      pendantPack = await loadAndScaleSVG("pendant", pendantName, pendantSize);
    }catch(e){
      console.error(e);
      pendantPack = {node:svgText("text",{x:540,y:200,fill:"#fff"}, "Missing Pendant"), width:120, height:60};
    }
    if(token!==lastRenderToken) return;

    // Load link masters for each unique type
    const uniqueLinkTypes = [...new Set(rows.map(r=>r.type))];
    const linkDefs = {};
    for(const t of uniqueLinkTypes){
      try{
        linkDefs[t] = await loadAndScaleSVG("link", t, 36); // target link height
      }catch(e){
        console.error(e);
      }
      if(token!==lastRenderToken) return;
    }

    // Layout geometry
    const PAD=40;
    const totalWidth = 1080;
    const midY = 200;
    const centerX = totalWidth/2;

    // Build left sequence (rows order)
    const leftSeq = [];
    for(const r of rows){
      for(let i=0;i<r.qty;i++) leftSeq.push(r.type);
    }
    // Right is a mirror (reverse order) for symmetry
    const rightSeq = [...leftSeq].reverse();

    // Compute widths
    const gap = 6;
    const leftWidth = leftSeq.reduce((acc,t)=>acc+(linkDefs[t]?.width||40)+gap, 0);
    const rightWidth = rightSeq.reduce((acc,t)=>acc+(linkDefs[t]?.width||40)+gap, 0);
    const pendantW = pendantPack.width;

    // Start positions so the whole composition is centered
    const needed = leftWidth + pendantW + rightWidth;
    let startX = Math.max(PAD, (totalWidth - needed)/2);
    const maxX = totalWidth - PAD;

    // Draw left links
    let cursor = startX;
    for(const t of leftSeq){
      const d = linkDefs[t];
      if(!d) continue;
      const g = document.createElementNS("http://www.w3.org/2000/svg","g");
      g.setAttribute("transform", `translate(${cursor}, ${midY - d.height/2})`);
      // tint to gold (optional)—many SVGs have strokes/fills; we gently override fill if not set
      applyGoldTint(d.node);
      g.appendChild(d.node.cloneNode(true));
      bracelet.appendChild(g);
      cursor += d.width + gap;
    }

    // Draw pendant
    const pendantX = cursor;
    const pendantG = document.createElementNS("http://www.w3.org/2000/svg","g");
    pendantG.setAttribute("transform", `translate(${pendantX}, ${midY - pendantPack.height/2})`);
    applyGoldTint(pendantPack.node);
    pendantG.appendChild(pendantPack.node);
    bracelet.appendChild(pendantG);
    cursor += pendantW + gap;

    // Draw right links
    for(const t of rightSeq){
      const d = linkDefs[t];
      if(!d) continue;
      const g = document.createElementNS("http://www.w3.org/2000/svg","g");
      g.setAttribute("transform", `translate(${cursor}, ${midY - d.height/2})`);
      applyGoldTint(d.node);
      g.appendChild(d.node.cloneNode(true));
      bracelet.appendChild(g);
      cursor += d.width + gap;
      if(cursor>maxX) break; // safety
    }

    // Weight
    const pendantWeight = weightFor(pendantName,"pendant");
    const linksWeight = rows.reduce((sum,r)=> sum + (weightFor(r.type,"link") * r.qty*2), 0); // ×2 for mirroring
    const total = pendantWeight + linksWeight;
    lblWeight.textContent = `${total.toFixed(2)} g`;
  }

  function applyGoldTint(node){
    // Gently make fills/strokes golden if they are solid colors.
    const walker = document.createTreeWalker(node, NodeFilter.SHOW_ELEMENT, null);
    while(walker.nextNode()){
      const el = walker.currentNode;
      const tag = el.tagName?.toLowerCase?.() || "";
      if(["path","circle","ellipse","rect","polygon","polyline","line"].includes(tag)){
        const fill = el.getAttribute("fill");
        const stroke = el.getAttribute("stroke");
        if(!fill || fill!=="none") el.setAttribute("fill","url(#gold)");
        if(stroke && stroke!=="none") el.setAttribute("stroke","#8a6a22");
        el.setAttribute("filter","url(#softShadow)");
      }
    }
  }

  /* ------------------------------------------------------------------
     7) Export
     ------------------------------------------------------------------ */
  function downloadSVG(){
    const clone = stage.cloneNode(true);
    const xml = new XMLSerializer().serializeToString(clone);
    const blob = new Blob([xml],{type:"image/svg+xml;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    trigger(url,"bracelet.svg");
  }
  function downloadPNG(){
    const clone = stage.cloneNode(true);
    clone.setAttribute("width","1080"); clone.setAttribute("height","400");
    const xml = new XMLSerializer().serializeToString(clone);
    const data = "data:image/svg+xml;base64," + btoa(unescape(encodeURIComponent(xml)));
    const img = new Image();
    img.onload = function(){
      const canvas = document.createElement("canvas"); canvas.width=1080; canvas.height=400;
      const ctx = canvas.getContext("2d"); ctx.drawImage(img,0,0,1080,400);
      canvas.toBlob(b=> trigger(URL.createObjectURL(b),"bracelet.png"),"image/png",0.98);
    };
    img.src = data;
  }
  function trigger(url,name){ const a=document.createElement("a"); a.href=url; a.download=name; document.body.appendChild(a); a.click(); a.remove(); setTimeout(()=>URL.revokeObjectURL(url),4000); }

  /* tiny helper to create an SVG element from tag+attrs (fallback text) */
  function svgText(tag, attrs, text){
    const el = document.createElementNS("http://www.w3.org/2000/svg", tag);
    for(const [k,v] of Object.entries(attrs)) el.setAttribute(k,String(v));
    if(text) el.textContent = text;
    return el;
  }
  </script>
</body>
</html>

