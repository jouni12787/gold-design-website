<!doctype html>
<html lang="en">
<head>
<script>
  // Apply saved theme ASAP (before CSS loads to avoid a flash)
  (function () {
    try {
      var KEY = 'hcj-theme';
      var saved = localStorage.getItem(KEY) || 'light';
      document.documentElement.setAttribute('data-theme', saved);
      // expose the key so other scripts can use the same one
      window.__HCJ_THEME_KEY = KEY;
    } catch (e) {}
  })();
</script>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#17120a">

<!-- Favicon (uses your 1000px SVG) -->
<link rel="icon" href="icon/icon-1000.svg" type="image/svg+xml">

<!-- Apple touch icon (can be any square PNG; using your 500px) -->
<link rel="apple-touch-icon" href="icon/icon-500.png">
<meta name="application-name" content="Chakaroun Jewelry">
<meta name="apple-mobile-web-app-title" content="Chakaroun Jewelry">
<meta property="og:title" content="Chakaroun Jewelry">
<meta property="og:site_name" content="Chakaroun Jewelry">
<meta name="twitter:title" content="Chakaroun Jewelry">
<title>Chakaroun Jewelry — Bracelet Builder</title>
<style>
  :root{
    --radius:14px;
    --shadow:0 18px 36px rgba(0,0,0,.45);
    --bar-font:clamp(.98rem,.9rem + .35vw,1.15rem);
    --bar-pad-y:14px;
    --bar-pad-x:18px;
    --bar-gap:12px;
    --bar-icon:56px;
    --bar-close:32px;
    --bar-btn-py:8px;
    --bar-btn-px:16px;
  }

  html[data-theme="dark"]{
    --bg:#17120a;
    --bg2:#0f0b06;
    --card:#211a0e;
    --card-overlay:rgba(48,37,19,.86);
    --ink:#fff7e6;
    --muted:#e8d9b3;
    --gold:#d4af37;
    --gold2:#b88a1a;
    --border-soft:rgba(212,175,55,.18);
    --border-strong:rgba(212,175,55,.35);
    --control-border:rgba(212,175,55,.22);
    --control-bg:rgba(23,18,10,.75);
    --control-focus-bg:rgba(33,26,14,.85);
    --control-focus-shadow:rgba(212,175,55,.18);
    --head-bg:rgba(15,11,6,.45);
    --summary-bg:rgba(23,18,10,.85);
    --preview-glow:rgba(212,175,55,.12);
    --tab-bg:rgba(23,18,10,.75);
    --tab-active-bg:rgba(33,26,14,.85);
    --hud-bg:rgba(21,15,8,.72);
    --hud-border:rgba(212,175,55,.2);
    --hud-text:#fff7e6;
    --button-top:rgba(212,175,55,.16);
    --button-bottom:rgba(184,138,26,.16);
    --button-hover-top:rgba(212,175,55,.28);
    --button-hover-bottom:rgba(184,138,26,.2);
    --accent-radial-1:rgba(212,175,55,.16);
    --accent-radial-2:rgba(184,138,26,.22);
    --pin-fill:#d4af37;
    --pin-stroke:#fff7e6;
  }

  html:not([data-theme]),
  html[data-theme="light"]{
    --bg:#f6f2ea;
    --bg2:#e4e9f3;
    --card:#ffffff;
    --card-overlay:rgba(255,255,255,.9);
    --ink:#2b261c;
    --muted:#706b60;
    --gold:#c8892c;
    --gold2:#a56a18;
    --border-soft:rgba(200,137,44,.28);
    --border-strong:rgba(200,137,44,.45);
    --control-border:rgba(200,137,44,.34);
    --control-bg:rgba(250,244,234,.92);
    --control-focus-bg:rgba(255,250,243,.97);
    --control-focus-shadow:rgba(200,137,44,.3);
    --head-bg:rgba(242,234,220,.76);
    --summary-bg:rgba(255,250,243,.92);
    --preview-glow:rgba(200,137,44,.2);
    --tab-bg:rgba(250,244,234,.88);
    --tab-active-bg:rgba(255,250,243,.96);
    --hud-bg:rgba(255,250,243,.96);
    --hud-border:rgba(200,137,44,.38);
    --hud-text:#2b261c;
    --button-top:rgba(200,137,44,.22);
    --button-bottom:rgba(165,106,24,.18);
    --button-hover-top:rgba(200,137,44,.32);
    --button-hover-bottom:rgba(165,106,24,.26);
    --accent-radial-1:rgba(200,137,44,.16);
    --accent-radial-2:rgba(165,106,24,.2);
    --pin-fill:#c8892c;
    --pin-stroke:#2b261c;
  }

  html[data-theme="plum"]{
    --bg:#160b19;
    --bg2:#341844;
    --card:#2b1433;
    --card-overlay:rgba(73,35,94,.72);
    --ink:#f8ecff;
    --muted:#d5c0ec;
    --gold:#d794ff;
    --gold2:#b162e4;
    --border-soft:rgba(215,148,255,.32);
    --border-strong:rgba(215,148,255,.48);
    --control-border:rgba(215,148,255,.36);
    --control-bg:rgba(41,20,51,.78);
    --control-focus-bg:rgba(55,28,68,.86);
    --control-focus-shadow:rgba(215,148,255,.26);
    --head-bg:rgba(39,18,50,.65);
    --summary-bg:rgba(41,20,51,.82);
    --preview-glow:rgba(215,148,255,.18);
    --tab-bg:rgba(41,20,51,.78);
    --tab-active-bg:rgba(55,28,68,.88);
    --hud-bg:rgba(45,22,58,.78);
    --hud-border:rgba(215,148,255,.34);
    --hud-text:#f8ecff;
    --button-top:rgba(215,148,255,.2);
    --button-bottom:rgba(177,98,228,.18);
    --button-hover-top:rgba(215,148,255,.3);
    --button-hover-bottom:rgba(177,98,228,.26);
    --accent-radial-1:rgba(215,148,255,.2);
    --accent-radial-2:rgba(177,98,228,.24);
    --pin-fill:#d794ff;
    --pin-stroke:#f8ecff;
  }

  /* === A2HS (Install) UI === */
  #a2hsBanner{
    position:fixed;top:0;left:0;right:0;z-index:9999;
    transform:translateY(-110%);transition:transform .45s ease;
    background:color-mix(in oklab,var(--bg) 88%,transparent);color:var(--ink);
    border-bottom:1px solid var(--border-soft);
    box-shadow:0 10px 30px rgba(0,0,0,.35);
    font-size:var(--bar-font);
  }
  #a2hsBanner.show{transform:translateY(0)}
  #a2hsBanner .wrap{display:flex;align-items:center;gap:var(--bar-gap);padding:var(--bar-pad-y) var(--bar-pad-x);}
  #a2hsBanner img.icon{width:var(--bar-icon);height:var(--bar-icon);border-radius:6px;flex:0 0 var(--bar-icon)}
  #a2hsBanner .txt{flex:1;display:flex;flex-direction:column}
  #a2hsBanner .txt .brand-title{font-weight:800;font-size:1.05em}
  #a2hsBanner .txt .brand-byline{font-weight:600;font-size:.88em;opacity:.8}
  #a2hsBanner .txt .banner-copy{font-size:.9em;opacity:.9;margin-top:2px}
  #a2hsBanner .cta{
    background:linear-gradient(135deg,var(--gold),var(--gold2));color:#2b1f10;
    border:0;border-radius:999px;padding:var(--bar-btn-py) var(--bar-btn-px);
    font-weight:800;cursor:pointer;font-size:1em;
  }
  #a2hsBanner .close{
    background:transparent;color:var(--ink);border:0;
    width:var(--bar-close);height:var(--bar-close);
    font-size:calc(var(--bar-close) * 0.56);line-height:var(--bar-close);cursor:pointer;flex:0 0 var(--bar-close);
  }

  #a2hsModal{position:fixed;inset:0;z-index:10001;display:none;align-items:center;justify-content:center;padding:24px 12px;}
  #a2hsModal.open{display:flex}
  #a2hsModal::before{content:"";position:absolute;inset:0;background:rgba(0,0,0,.6)}
  #a2hsModal .sheet{
    position:relative;width:min(560px,92vw);max-height:calc(100vh - 48px);overflow:auto;
    background:color-mix(in oklab,var(--bg) 86%,transparent);color:var(--ink);
    border:1px solid var(--border-soft);border-radius:16px;padding:16px;
    box-shadow:0 20px 50px rgba(0,0,0,.65);
  }
  #a2hsModal .steps{margin-top:6px;font-size:14px;line-height:1.7}
  #a2hsModal .steps .row{display:flex;gap:10px;margin:6px 0;flex-direction:column}
  #a2hsModal .stepimg{
    display:block;width:100%;height:auto;margin-top:8px;
    border-radius:10px;border:1px solid var(--border-soft);
  }
  #a2hsModal .x{position:absolute;top:8px;left:10px;background:transparent;border:0;color:var(--ink);font-size:20px;cursor:pointer}

  *{box-sizing:border-box}html,body{height:100%}
  body{margin:0;background:
    radial-gradient(1100px 500px at 15% -15%, var(--accent-radial-1) 0%, transparent 60%),
    radial-gradient(900px 600px at 120% 0%, var(--accent-radial-2) 0%, transparent 70%),
    linear-gradient(160deg, var(--bg) 0%, var(--bg2) 100%);
    color:var(--ink);font:15.5px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial;transition:color .3s ease, background .3s ease}
  .topbar{position:sticky;top:0;z-index:80;background:var(--head-bg);backdrop-filter:saturate(1.25) blur(10px);border-bottom:1px solid var(--border-soft)}
  .topbar .wrap{max-width:1240px;margin:0 auto;padding:12px 18px;display:flex;align-items:center;gap:14px}
  .topbar .brand{display:flex;align-items:center;gap:12px;text-decoration:none;color:var(--ink)}
  .topbar .brand img{width:40px;height:40px;border-radius:10px;box-shadow:0 8px 18px rgba(0,0,0,.35)}
  .topbar .brand .brand-stack{display:flex;flex-direction:column;line-height:1.05}
  .topbar .brand .brand-title{font-weight:800;letter-spacing:.42px;font-size:17px}
  .topbar .brand .brand-byline{font-weight:600;font-size:11px;opacity:.75;text-transform:uppercase;letter-spacing:.6px}
  .topbar .nav{margin-left:auto;display:flex;gap:12px;align-items:center;flex-wrap:nowrap;overflow-x:auto;padding-bottom:4px;scrollbar-width:none;-webkit-overflow-scrolling:touch}
  .topbar .nav::-webkit-scrollbar{display:none}
  .topbar .nav a{color:var(--ink);text-decoration:none;border:1px solid var(--border-soft);padding:9px 14px;border-radius:999px;font-size:13px;font-weight:600;letter-spacing:.04em;transition:border .2s,color .2s,background .2s;flex:0 0 auto;white-space:nowrap}
  .topbar .nav a:hover{border-color:var(--gold);color:var(--ink);background:color-mix(in oklab,var(--gold) 16%,transparent)}
  .topbar .nav a[aria-current="page"]{border-color:var(--gold);color:var(--gold);background:color-mix(in oklab,var(--gold) 18%,transparent)}
  .topbar .nav select{border:1px solid var(--border-soft);background:var(--control-bg);color:var(--ink);padding:8px 12px;border-radius:999px;font-size:13px;font-weight:600}
  .story-hero{position:relative;max-width:1240px;margin:0 auto;padding:48px 18px 52px;display:flex;align-items:center;justify-content:center;text-align:center}
  .story-hero::before{content:"";position:absolute;inset:18px;border-radius:24px;background:
    radial-gradient(1200px 600px at 10% 10%, color-mix(in oklab,var(--gold) 18%,transparent) 0%, transparent 65%),
    radial-gradient(1200px 680px at 90% 0%, color-mix(in oklab,var(--gold2) 24%,transparent) 0%, transparent 70%),
    linear-gradient(140deg, color-mix(in oklab,var(--bg) 75%, transparent) 0%, color-mix(in oklab,var(--bg2) 85%, transparent) 100%);
    opacity:.92;filter:blur(0);z-index:-2}
  .story-hero::after{content:"";position:absolute;inset:18px;border-radius:24px;border:1px solid var(--border-soft);backdrop-filter:blur(6px);z-index:-1}
  .story-hero .hero-content{max-width:720px;position:relative;z-index:1;display:flex;flex-direction:column;gap:18px;padding:32px 24px}
  .story-hero .hero-eyebrow{letter-spacing:.45em;font-size:12px;text-transform:uppercase;color:var(--muted)}
  .story-hero h2{margin:0;font-size:clamp(2.1rem,2.4vw + 1.6rem,3.2rem);letter-spacing:.02em}
  .story-hero p{margin:0;font-size:1.05rem;color:color-mix(in oklab,var(--ink) 88%, transparent)}
  .hero-actions{display:flex;gap:14px;justify-content:center;flex-wrap:wrap;margin-top:10px}
  .hero-btn{display:inline-flex;align-items:center;gap:10px;padding:12px 24px;border-radius:999px;text-decoration:none;font-weight:700;font-size:.98rem;border:1px solid var(--border-strong);color:var(--ink);background:linear-gradient(120deg,var(--button-top),var(--button-bottom));transition:border .2s,transform .2s,background .2s}
  .hero-btn:hover{border-color:var(--gold);transform:translateY(-1px);background:linear-gradient(120deg,var(--button-hover-top),var(--button-hover-bottom))}
  .hero-btn.secondary{background:transparent;border-color:var(--border-soft)}
  .wrap{max-width:1200px;margin:28px auto;padding:0 16px;display:grid;gap:18px;grid-template-columns:1fr 1.35fr}
  @media (max-width:980px){.wrap{grid-template-columns:1fr}}
  .card{background:linear-gradient(160deg,var(--card-overlay),var(--card));
    border:1px solid var(--border-soft);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden;transition:background .3s ease,border-color .3s ease,box-shadow .3s ease}
  .head{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:16px 18px;border-bottom:1px solid var(--border-soft);background:var(--head-bg)}
  .head h1{margin:0;font-size:18px}
  .headPrimary{display:flex;flex-direction:column;gap:4px}
  .headActions{display:flex;align-items:center;gap:12px;flex-wrap:wrap;justify-content:flex-end}
  .badge{font-size:12px;color:var(--muted)}
  .panel{padding:16px 18px}
  label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
  select,input{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--control-border);background:var(--control-bg);color:var(--ink);outline:none;transition:border .2s,box-shadow .2s,background .2s,color .3s ease}
  select:focus,input:focus{border-color:var(--gold);box-shadow:0 0 0 2px var(--control-focus-shadow);background:var(--control-focus-bg)}
  .grid2{display:grid;gap:12px;grid-template-columns:1fr 1fr}
  .rows{display:flex;flex-direction:column;gap:10px;margin-top:10px}
  .row{display:grid;grid-template-columns:1.2fr .7fr auto auto;gap:10px;align-items:end}
  button{appearance:none;background:linear-gradient(180deg,var(--button-top),var(--button-bottom));color:var(--ink);border:1px solid var(--border-strong);padding:10px 14px;border-radius:12px;cursor:pointer;transition:border .2s,background .2s,color .2s}
  button:hover{border-color:var(--gold);background:linear-gradient(180deg,var(--button-hover-top),var(--button-hover-bottom));color:var(--ink)}
  .summary{margin-top:16px;padding:18px;border-radius:18px;background:var(--summary-bg);border:1px solid var(--border-soft);display:flex;flex-wrap:wrap;gap:18px;align-items:flex-start}
  .summary .summary-primary{flex:1 1 220px;display:flex;flex-direction:column;gap:6px}
  .summary strong{font-size:1.05rem}
  .summary .w{color:var(--gold);font-size:1.2rem}
  .summary .summary-stats{display:flex;gap:16px;flex-wrap:wrap}
  .summary .stat{background:color-mix(in oklab,var(--control-bg) 78%,transparent);border:1px solid color-mix(in oklab,var(--border-soft) 80%,transparent);border-radius:14px;padding:12px 14px;min-width:120px}
  .summary .stat span{display:block;font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.08em;margin-bottom:4px}
  .buttons{display:flex;gap:10px;flex-wrap:wrap;margin-top:18px}
  .buttons button{flex:0 0 auto}
  button.secondary{background:transparent;border-color:var(--border-soft)}
  button.secondary:hover{border-color:var(--gold)}
  button.ghost{background:transparent;border:1px dashed var(--border-soft)}
  button.ghost:hover{border-color:var(--gold);background:color-mix(in oklab,var(--gold) 14%,transparent)}
  .preview{display:flex;align-items:center;justify-content:center;background:
    radial-gradient(600px 400px at 50% 0%, var(--preview-glow) 0%, transparent 70%),
    var(--bg2);min-height:320px;position:relative;transition:background .3s ease}
  svg#stage{width:100%;height:100%;max-height:560px}
  #stage [data-role="background"]{fill:var(--bg2);transition:fill .3s ease}
  .materialNarrative{margin-top:10px;font-size:.9rem;color:var(--muted);line-height:1.5}
  .themeDesigner{margin-top:12px;padding:14px;border-radius:14px;border:1px dashed var(--border-soft);background:color-mix(in oklab,var(--control-bg) 85%, transparent);display:none;gap:12px}
  .themeDesigner.open{display:grid}
  .themeDesigner__grid{display:grid;gap:12px;grid-template-columns:repeat(auto-fit,minmax(150px,1fr))}
  .themeDesigner label{font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.08em;margin-bottom:4px}
  .themeDesigner input[type="color"]{width:100%;height:40px;border:1px solid var(--border-soft);border-radius:12px;background:transparent;padding:0}
  .themeDesigner button{justify-self:start}
  #wishlistCTA{position:absolute;top:16px;right:16px;padding:10px 18px;border-radius:999px;border:1px solid var(--border-soft);background:color-mix(in oklab,var(--control-bg) 78%, transparent);color:var(--ink);font-weight:700;cursor:pointer;transition:transform .2s,border .2s}
  #wishlistCTA:hover{border-color:var(--gold);transform:translateY(-1px)}
  .stlHud{position:absolute;left:12px;bottom:12px;display:flex;gap:8px;align-items:center;background:var(--hud-bg);border:1px solid var(--hud-border);padding:8px 10px;border-radius:10px;color:var(--hud-text);backdrop-filter:blur(8px);transition:background .3s ease,border-color .3s ease,color .3s ease;flex-wrap:wrap}
  .stlHud .cameraControls{display:flex;gap:6px}
  .stlHud .cameraControls button{padding:6px 10px;font-size:11px;border-radius:8px;border:1px solid color-mix(in oklab,var(--hud-border) 70%, transparent);background:transparent;color:inherit;cursor:pointer}
  .stlHud .cameraControls button:hover{border-color:var(--gold);color:var(--gold)}
  .stlHud select{min-width:150px}
  .toast{position:fixed;left:50%;bottom:32px;transform:translateX(-50%) translateY(140%);transition:transform .4s ease,opacity .4s ease;opacity:0;background:var(--hud-bg);color:var(--hud-text);border:1px solid var(--hud-border);padding:14px 18px;border-radius:14px;z-index:1200;backdrop-filter:blur(12px);font-weight:600}
  .toast.show{transform:translateX(-50%) translateY(0);opacity:1}
  #tourOverlay{position:fixed;inset:0;background:rgba(0,0,0,.72);backdrop-filter:blur(6px);z-index:2000;display:none;align-items:center;justify-content:center;padding:20px}
  #tourOverlay.open{display:flex}
  #tourSpotlight{position:absolute;border-radius:22px;box-shadow:0 0 0 200vmax rgba(0,0,0,.7);pointer-events:none;transition:all .3s ease}
  #tourCard{position:relative;z-index:1;max-width:420px;background:color-mix(in oklab,var(--card) 92%, transparent);border-radius:18px;padding:22px;border:1px solid var(--border-soft);display:flex;flex-direction:column;gap:12px;color:var(--ink)}
  #tourCard h4{margin:0;font-size:1.2rem}
  #tourControls{display:flex;justify-content:space-between;gap:10px}
  #tourControls button{flex:1}
  @media (max-width:980px){
    .wrap{grid-template-columns:1fr}
    #wishlistCTA{top:auto;bottom:16px}
  }
  .tabs{display:flex;gap:6px}
  .tab{background:var(--tab-bg);border:1px solid var(--border-soft);color:var(--muted);padding:6px 10px;border-radius:10px;cursor:pointer;font-size:12px;transition:border .2s,color .2s,background .2s}
  .tab:hover{color:var(--ink);border-color:var(--gold)}
  .tab.active{border-color:var(--gold);color:var(--gold);background:var(--tab-active-bg)}
  #preview3d{display:none}
  #stlCanvas{width:100%;height:100%;max-height:560px;display:block}
  .stlHud select,.stlHud label{margin:0}
  .stlStatus{position:absolute;right:12px;bottom:12px;font:12px/1.3 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial;background:var(--hud-bg);border:1px solid var(--hud-border);color:var(--hud-text);padding:6px 8px;border-radius:8px;pointer-events:none;transition:background .3s ease,border-color .3s ease,color .3s ease}

  /* ====== Clean look overrides (paste at end of <style>) ====== */

  /* Simpler background */
  body{
    background: linear-gradient(160deg, var(--bg) 0%, var(--bg2) 100%) !important;
  }

  /* Remove hero’s extra glass frames */
  .story-hero::before,
  .story-hero::after{ display:none !important; }

  /* Flatter chrome */
  :root{
    --radius:10px !important;
    --shadow:0 10px 24px rgba(0,0,0,.25) !important;
  }

  .card{ background: var(--card) !important; box-shadow: var(--shadow) !important; }
  .head{ background: color-mix(in oklab,var(--bg) 8%, transparent) !important; }

  /* Hero spacing tighter */
  .story-hero{
    padding: 40px 18px 32px !important;
    border:1px solid color-mix(in oklab,var(--border-soft) 60%, transparent);
    border-radius: 20px;
    background: color-mix(in oklab,var(--bg2) 12%, transparent);
    box-shadow: var(--shadow);
  }
  .story-hero .hero-content{ padding: 20px !important; gap:20px; }

  /* Responsive hero adjustments */
  @media (max-width:600px){
    .story-hero p{ display:-webkit-box; -webkit-line-clamp:4; -webkit-box-orient:vertical; overflow:hidden; }
  }
  @media (max-width:520px){
    .hero-actions{ gap:18px; }
    .hero-btn{ width:100%; justify-content:center; }
  }
  @media (max-width:420px){
    .story-hero{ padding:32px 16px 24px !important; }
    .story-hero .hero-content{ gap:16px !important; }
    .story-hero .hero-eyebrow{ letter-spacing:.32em; }
  }
  @media (max-width:380px){
    .story-hero h2{ font-size:clamp(1.9rem,5.5vw + 1.1rem,2.3rem); }
  }

  /* Main grid tighter and narrower for a luxe feel */
  .wrap{ max-width: 1100px !important; grid-template-columns: 1.1fr 1fr !important; }
  @media (max-width:980px){ .wrap{ grid-template-columns: 1fr !important; } }

  /* Preview: remove glow */
  .preview{ background: var(--bg2) !important; }

  /* Buttons: small polish */
  button, .hero-btn{
    border-radius: 10px !important;
    box-shadow: 0 6px 16px rgba(0,0,0,.15);
  }

  /* A2HS banner doesn’t bump layout */
  #a2hsBanner.show{ transform: translateY(0) !important; position: sticky; top: 0; }

  @media (max-width:520px){
    .topbar .nav a{ padding:8px 12px; font-size:12px; }
  }
  @media (max-width:380px){
    .topbar .nav a{ padding:8px 10px; font-size:11.5px; }
  }

  /* Keep 3D canvas proportioned */
  #stlCanvas{ aspect-ratio: 4 / 3; width:100%; height:auto; }
</style>
</head>
<body>
<!-- A2HS Banner -->
<div id="a2hsBanner" aria-hidden="true">
  <div class="wrap" style="max-width:1100px;margin:0 auto;padding:0 16px;">
    <button class="close" type="button" aria-label="Close" data-i18n-attr="aria-label:common.close">×</button>
    <img class="icon" src="icon/icon-500.png" alt="Chakaroun Jewelry icon" data-i18n-attr="alt:brand.logoAlt">
    <div class="txt">
      <div class="brand-title" data-i18n="brand.title">Chakaroun Jewelry</div>
      <div class="brand-byline" data-i18n="brand.byline">by Hassan Chakaroun &amp; Ali Jouni</div>
      <div class="banner-copy" data-i18n="a2hs.banner">Add it to your Home Screen.</div>
    </div>
    <button class="cta" type="button" id="a2hsGet" data-i18n="a2hs.install">Install</button>
  </div>
</div>

<!-- iOS Guide (no images; simple instructions) -->
<div id="a2hsModal" aria-hidden="true">
  <div class="sheet" role="dialog" aria-modal="true" aria-labelledby="a2hsTitle">
    <button class="x" type="button" aria-label="Close" data-i18n-attr="aria-label:common.close">×</button>
      <h3 id="a2hsTitle" data-i18n="a2hs.title">Add “Chakaroun Jewelry” to Home Screen</h3>
    <div class="steps">
      <div class="row">
        <div><strong>1.</strong> <span data-i18n="a2hs.step1">Tap <em>Share</em> in Safari.</span></div>
        <img class="stepimg" src="./icon/share.jpg" alt="iPhone Share button screenshot">
      </div>
      <div class="row">
        <div><strong>2.</strong> <span data-i18n="a2hs.step2">Choose <em>Add to Home Screen</em>, then <em>Add</em>.</span></div>
        <img class="stepimg" src="./icon/save%20to%20home%20screen.jpeg" alt="Add to Home Screen screenshot">
      </div>
</div>
</div>
</div>
<header class="topbar">
  <div class="wrap">
   <a class="brand" href="index.html" aria-label="Chakaroun Jewelry — by Hassan Chakaroun &amp; Ali Jouni" data-i18n-attr="aria-label:brand.aria">
      <img src="icon/icon-500.png" alt="Chakaroun Jewelry logo" data-i18n-attr="alt:brand.logoAlt">
      <span class="brand-stack">
        <span class="brand-title" data-i18n="brand.title">Chakaroun Jewelry</span>
        <small class="brand-byline" data-i18n="brand.byline">by Hassan Chakaroun &amp; Ali Jouni</small>
      </span>
    </a>
    <nav class="nav">
      <a href="index.html" aria-current="page" data-i18n="nav.builder">Builder</a>
      <a href="store.html" data-i18n="nav.store">Store</a>
      <a href="about.html" data-i18n="nav.about">About</a>
      <select id="themeSelectTop" aria-label="Select theme" data-i18n-attr="aria-label:common.theme.select">
        <option value="dark" data-i18n="theme.dark">Dark</option>
        <option value="light" data-i18n="theme.light">Light</option>
        <option value="plum" data-i18n="theme.plum">Plum</option>
        <option value="custom" data-i18n="theme.custom">Custom</option>
      </select>
      <select id="langSelectTop" aria-label="Select language">
        <option value="en">English</option>
        <option value="ar">العربية</option>
        <option value="fr">Français</option>
        <option value="it">Italiano</option>
      </select>
    </nav>
  </div>
</header>
<section class="story-hero" id="maison">
  <div class="hero-content">
    <span class="hero-eyebrow" data-i18n="home.eyebrow">Maison Chakaroun · Established Beirut 1964</span>
    <h2 data-i18n="home.headline">Bespoke bracelets infused with Levantine poetry and Parisian polish.</h2>
    <p data-i18n="home.copy">Craft a signature piece from the same atelier that shapes our haute joaillerie. Every pendant, halo link and clasp follows archival proportions that honour our founders while embracing contemporary luxury.</p>
    <div class="hero-actions">
      <a class="hero-btn" href="about.html#craftsmanship" data-i18n="home.cta.primary">Discover our craftsmanship</a>
      <a class="hero-btn secondary" href="store.html" data-i18n="home.cta.secondary">Visit the online boutique</a>
    </div>
  </div>
</section>
<div class="wrap">
  <!-- LEFT -->
  <section class="card">
    <div class="head">
      <div class="headPrimary">
        <h1 data-i18n="builder.title">Bracelet Builder</h1>
        <span class="badge" data-i18n="builder.badge">Pin snapping · horizontal SVGs</span>
      </div>
      <div class="headActions">
        <button class="ghost" type="button" id="startTour" data-i18n="builder.tour.start">Guide me</button>
      </div>
    </div>
    <div class="panel">
      <div class="themeDesigner" id="themeDesigner" aria-hidden="true">
        <div class="themeDesigner__grid">
          <div>
            <label for="customAccent" data-i18n="builder.theme.accent">Accent color</label>
            <input type="color" id="customAccent" value="#d4af37">
          </div>
          <div>
            <label for="customBackground" data-i18n="builder.theme.background">Background</label>
            <input type="color" id="customBackground" value="#17120a">
          </div>
          <div>
            <label for="customBackground2" data-i18n="builder.theme.backgroundGlow">Background glow</label>
            <input type="color" id="customBackground2" value="#2a1b0f">
          </div>
          <div>
            <label for="customInk" data-i18n="builder.theme.typography">Typography</label>
            <input type="color" id="customInk" value="#fff7e6">
          </div>
        </div>
        <button type="button" id="applyCustomTheme" data-i18n="builder.theme.apply">Apply palette</button>
      </div>
      <div class="grid2">
        <div>
          <label for="pendant" data-i18n="builder.pendant">Pendant</label>
          <select id="pendant"></select>
        </div>
      </div>

      <div class="rows" id="rows"></div>
      <div class="grid2" style="margin-top:10px">
        <div>
          <label for="lockSelect" data-i18n="builder.lock">Lock (left end)</label>
          <select id="lockSelect"></select>
        </div>
      </div>
      <div class="grid2" style="margin-top:10px">
        <div>
          <label for="angleStep" data-i18n="builder.angle">Link bend per step (°)</label>
          <input id="angleStep" type="range" min="0" max="15" step="0.5" value="15"/>
        </div>
        <div>
          <label>&nbsp;</label>
          <output id="angleStepOut">15°</output>
        </div>
      </div>
      <div style="margin-top:8px"><button id="addRow" data-i18n="builder.addRow">+ Add link type</button></div>

      <div class="grid2" style="margin-top:16px">
        <div>
          <label for="metalPreset" data-i18n="builder.metal">Metal &amp; purity</label>
          <select id="metalPreset"></select>
        </div>
        <div>
          <label for="wristSize" data-i18n="builder.wrist">Wrist size (cm)</label>
          <input id="wristSize" type="number" min="14" max="24" step="0.5" value="18">
        </div>
      </div>
      <div class="summary" id="materialSummary" role="status" aria-live="polite">
        <div class="summary-primary">
          <div><strong data-i18n="builder.summary.h">Estimated Weight</strong></div>
          <span class="w" id="totalWeight">0.00 g</span>
          <div class="badge" id="materialDetails" data-i18n="builder.summary.details">Select a metal profile to view density, price &amp; narrative.</div>
        </div>
        <div class="summary-stats">
          <div class="stat">
            <span data-i18n="builder.summary.metalWeight.label">Metal weight</span>
            <strong id="metalWeight">0.00 g</strong>
          </div>
          <div class="stat">
            <span data-i18n="builder.summary.estimate.label">Estimate</span>
            <strong id="priceEstimate">$0.00</strong>
          </div>
        </div>
      </div>
      <div class="materialNarrative" id="materialNarrative" data-i18n="builder.narrative">Weights are calibrated to our atelier’s 1:1 prototypes.</div>

      <div class="buttons">
        <button id="downloadSVG" data-i18n="builder.actions.svg">Download SVG</button>
        <button id="downloadPNG" data-i18n="builder.actions.png">Download PNG</button>
        <button id="saveSession" class="secondary" data-i18n="builder.actions.save">Save session</button>
        <button id="reset" class="ghost" data-i18n="builder.actions.reset">Reset</button>
      </div>

    </div>
  </section>

  <!-- RIGHT -->
  <section class="card">
    <div class="head">
      <h1 data-i18n="builder.preview.h">Preview</h1>
      <div class="tabs">
        <button class="tab active" id="tab2d" data-i18n="builder.preview.tab2d">2D</button>
        <button class="tab" id="tab3d" data-i18n="builder.preview.tab3d">3D (STL)</button>
      </div>
    </div>

    <!-- 2D -->
    <div class="preview" id="preview2d">
      <svg id="stage" viewBox="0 0 1080 320" role="img" aria-label="Bracelet preview">
        <defs id="defs">
          <!-- 18K: warm classic gold -->
          <linearGradient id="gold18" x1="0" y1="0" x2="1" y2="1">
            <stop offset="0%"   stop-color="#fff7e6"/>
            <stop offset="28%"  stop-color="#f3dfa9"/>
            <stop offset="58%"  stop-color="#d4af37"/>
            <stop offset="85%"  stop-color="#b88a1a"/>
            <stop offset="100%" stop-color="#f6e4bb"/>
          </linearGradient>

          <!-- 21K: more concentrated/saturated gold (deeper body, tighter highlight) -->
          <linearGradient id="gold21" x1="0" y1="0" x2="1" y2="1">
            <stop offset="0%"   stop-color="#fff3c9"/>
            <stop offset="18%"  stop-color="#f2cf5a"/>
            <stop offset="50%"  stop-color="#c89a00"/>
            <stop offset="78%"  stop-color="#a87900"/>
            <stop offset="100%" stop-color="#f3e08b"/>
          </linearGradient>

          <!-- Silver: neutral metallic greys (no gold tint) -->
          <linearGradient id="silver" x1="0" y1="0" x2="1" y2="1">
            <stop offset="0%"   stop-color="#ffffff"/>
            <stop offset="25%"  stop-color="#e5e5e5"/>
            <stop offset="55%"  stop-color="#bfc0c2"/>
            <stop offset="82%"  stop-color="#9a9a9a"/>
            <stop offset="100%" stop-color="#efefef"/>
          </linearGradient>
          <filter id="softShadow" x="-20%" y="-20%" width="140%" height="140%">
            <feDropShadow dx="0" dy="2" stdDeviation="2" flood-color="#000" flood-opacity=".35"/>
          </filter>
        </defs>
        <rect x="0" y="0" width="1080" height="320" fill="#0f0b06" data-role="background"/>
        <g id="bracelet"></g>
      </svg>
    </div>

    <!-- 3D -->
    <div class="preview" id="preview3d">
      <button id="wishlistCTA" type="button" data-i18n="builder.wishlist">♡ Add to wishlist</button>
      <canvas id="stlCanvas"></canvas>
      <div class="stlHud">
        <select id="stlSelect" title="Choose model" data-i18n-attr="title:builder.stl.select.title">
          <option value="__assembly__" data-i18n="builder.stl.option.assembly">Bracelet assembly</option>
          <option value="pendant/Infinity Knot 1 1mm.stl" data-i18n="builder.stl.option.pendant.infinity1">Infinity Knot 1 — 1mm</option>
          <option value="link/halo link 1mm.stl" data-i18n="builder.stl.option.link.halo1">halo link — 1mm</option>
          <option value="link/gold circle link.stl" data-i18n="builder.stl.option.link.circle">gold circle link — 1mm</option>

        </select>
        <select id="lightingPreset" title="Lighting preset" data-i18n-attr="title:builder.lighting.title">
          <option value="gallery" data-i18n="builder.lighting.gallery">Gallery glow</option>
          <option value="spotlight" data-i18n="builder.lighting.spotlight">Spotlight focus</option>
          <option value="twilight" data-i18n="builder.lighting.twilight">Twilight bloom</option>
        </select>
        <div class="cameraControls" role="group" aria-label="Camera bookmarks" data-i18n-attr="aria-label:builder.camera.aria">
          <button type="button" data-bookmark="front" data-i18n="builder.camera.front">Front</button>
          <button type="button" data-bookmark="threeQuarter" data-i18n="builder.camera.threeQuarter">Three-quarter</button>
          <button type="button" data-bookmark="top" data-i18n="builder.camera.top">Top</button>
        </div>
        <label style="display:inline-flex;gap:.35rem;align-items:center;">
          <input type="checkbox" id="stlAutoRotate">
          <span data-i18n="builder.preview.auto">Auto rotate</span>
        </label>
        <button id="stlDownload" type="button" data-i18n="builder.preview.download">Download STL</button>
      </div>
    </div>
  </section>
</div>

<div class="toast" id="toast" role="status" aria-live="polite"></div>

<div id="tourOverlay" aria-hidden="true">
  <div id="tourSpotlight"></div>
  <div id="tourCard" role="dialog" aria-modal="true" aria-labelledby="tourTitle">
    <h4 id="tourTitle" data-i18n="builder.tour.welcome.title">Welcome to the Atelier</h4>
    <p id="tourBody" data-i18n="builder.tour.welcome.body">Let us highlight the controls that shape your bracelet.</p>
    <div id="tourControls">
      <button type="button" id="tourPrev" class="ghost" data-i18n="builder.tour.prev">Back</button>
      <button type="button" id="tourNext" data-i18n="builder.tour.next">Next</button>
    </div>
    <button type="button" id="tourSkip" class="ghost" style="margin-top:6px" data-i18n="builder.tour.skip">Skip tour</button>
  </div>
</div>

<script src="scripts/a2hs.js"></script>
<script src="scripts/translations.js"></script>

<script>
  if('serviceWorker' in navigator){
    window.addEventListener('load', function(){
      navigator.serviceWorker.register('sw.js').catch(function(){});
    });
  }
</script>

<!-- ==================== 2D BUILDER ==================== -->
<script>
"use strict";

function t(key, vars){
  const lang = document.documentElement.lang || 'en';
  const dict = window.__TRANSLATIONS?.[lang] || {};
  const fallback = window.__TRANSLATIONS?.en || {};
  let value = dict[key];
  if(value == null) value = fallback[key];
  if(value == null) value = key;
  if(typeof value === 'string' && vars && typeof vars === 'object'){
    value = value.replace(/\{\{(\w+)\}\}/g, (_, name) => (vars[name] ?? ''));
  }
  return value;
}

function onLanguageChange(){
  rebuildTourSteps();
  applyDynamicTranslations();
  render();
  if(isTourActive) showTourStep(tourIndex);
}

window.addEventListener('hcj:lang', onLanguageChange);

const THEMES = ["light", "dark", "plum", "custom"];
const THEME_KEY = window.__HCJ_THEME_KEY || "hcj-theme";
const DEFAULT_THEME = document.documentElement.dataset.theme || "light";
const STAGE_W = 1080;
const STAGE_H = 320; // compact height
const STORAGE_KEYS = {
  session: 'hcj-builder-session',
  wishlist: 'hcj-builder-wishlist',
  customTheme: 'hcj-theme-custom',
  tour: 'hcj-builder-tour'
};
const BASE_DENSITY = 15.6; // 18K heritage gold baseline (g/cm^3)
const BASE_WRIST_CM = 18;

const METAL_PRESETS = [
  { id: 'gold-18', labelKey: 'builder.metal.gold18.label', density: 15.6, pricePerGram: 62, narrativeKey: 'builder.metal.gold18.narrative' },
  { id: 'gold-21', labelKey: 'builder.metal.gold21.label', density: 17.2, pricePerGram: 66, narrativeKey: 'builder.metal.gold21.narrative' },
  { id: 'silver',  labelKey: 'builder.metal.silver.label', density: 10.5, pricePerGram: 10, narrativeKey: 'builder.metal.silver.narrative' }
];

const CUSTOM_THEME_DEFAULTS = {
  accent: '#d4af37',
  bg: '#17120a',
  bg2: '#2a1b0f',
  ink: '#fff7e6'
};

const priceFormatter = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 });

function ensureCustomThemeStyle(){
  let styleEl = document.getElementById('hcj-custom-theme-style');
  if(!styleEl){
    styleEl = document.createElement('style');
    styleEl.id = 'hcj-custom-theme-style';
    document.head.appendChild(styleEl);
  }
  return styleEl;
}

function normalizeThemeConfig(cfg){
  const base = { ...CUSTOM_THEME_DEFAULTS };
  if(cfg && typeof cfg === 'object'){
    if(typeof cfg.accent === 'string') base.accent = cfg.accent;
    if(typeof cfg.bg === 'string') base.bg = cfg.bg;
    if(typeof cfg.bg2 === 'string') base.bg2 = cfg.bg2;
    if(typeof cfg.ink === 'string') base.ink = cfg.ink;
  }
  return base;
}

function applyCustomThemeVars(cfg){
  const settings = normalizeThemeConfig(cfg);
  const styleEl = ensureCustomThemeStyle();
  const { accent, bg, bg2, ink } = settings;
  styleEl.textContent = `html[data-theme="custom"]{
    --bg:${bg};
    --bg2:${bg2};
    --card:color-mix(in oklab, ${bg} 85%, ${bg2});
    --card-overlay:color-mix(in oklab, ${bg2} 70%, transparent);
    --ink:${ink};
    --muted:color-mix(in oklab, ${ink} 60%, transparent);
    --gold:${accent};
    --gold2:color-mix(in oklab, ${accent} 60%, #000 40%);
    --border-soft:color-mix(in oklab, ${accent} 30%, transparent);
    --border-strong:color-mix(in oklab, ${accent} 48%, transparent);
    --control-border:color-mix(in oklab, ${accent} 36%, transparent);
    --control-bg:color-mix(in oklab, ${bg} 88%, transparent);
    --control-focus-bg:color-mix(in oklab, ${bg} 70%, ${bg2});
    --control-focus-shadow:color-mix(in oklab, ${accent} 28%, transparent);
    --head-bg:color-mix(in oklab, ${bg} 82%, transparent);
    --summary-bg:color-mix(in oklab, ${bg} 80%, ${bg2});
    --preview-glow:color-mix(in oklab, ${accent} 25%, transparent);
    --tab-bg:color-mix(in oklab, ${bg} 82%, transparent);
    --tab-active-bg:color-mix(in oklab, ${bg2} 70%, transparent);
    --hud-bg:color-mix(in oklab, ${bg} 72%, transparent);
    --hud-border:color-mix(in oklab, ${accent} 26%, transparent);
    --hud-text:${ink};
    --button-top:color-mix(in oklab, ${accent} 20%, transparent);
    --button-bottom:color-mix(in oklab, ${accent} 16%, transparent);
    --button-hover-top:color-mix(in oklab, ${accent} 30%, transparent);
    --button-hover-bottom:color-mix(in oklab, ${accent} 24%, transparent);
    --accent-radial-1:color-mix(in oklab, ${accent} 22%, transparent);
    --accent-radial-2:color-mix(in oklab, ${accent} 18%, transparent);
    --pin-fill:${accent};
    --pin-stroke:${ink};
  }`;
  return settings;
}

function loadCustomTheme(){
  try{
    const raw = localStorage?.getItem(STORAGE_KEYS.customTheme);
    if(raw){
      return normalizeThemeConfig(JSON.parse(raw));
    }
  }catch(_){/* ignore */}
  return { ...CUSTOM_THEME_DEFAULTS };
}

function saveCustomTheme(cfg){
  try{
    localStorage?.setItem(STORAGE_KEYS.customTheme, JSON.stringify(normalizeThemeConfig(cfg)));
  }catch(_){/* ignore */}
}

function updateThemeDesignerVisibility(){
  if(!themeDesigner) return;
  const open = selTheme?.value === 'custom';
  themeDesigner.classList.toggle('open', open);
  themeDesigner.setAttribute('aria-hidden', open ? 'false' : 'true');
  const cfg = normalizeThemeConfig(customThemeSettings);
  if(inpCustomAccent) inpCustomAccent.value = cfg.accent;
  if(inpCustomBackground) inpCustomBackground.value = cfg.bg;
  if(inpCustomBackground2) inpCustomBackground2.value = cfg.bg2;
  if(inpCustomInk) inpCustomInk.value = cfg.ink;
}
  
function applyPinsByRatio(pack, ratios){
  if(!pack || !ratios) return;
  const w = pack.width || 1, h = pack.height || 1;
  const L = ratios.L ? { x: ratios.L.x * w, y: ratios.L.y * h } : null;
  const R = ratios.R ? { x: ratios.R.x * w, y: ratios.R.y * h } : null;
  pack.pins = { L, R };
  pack.pinRatios = {
    L: L ? { x: ratios.L.x, y: ratios.L.y } : null,
    R: R ? { x: ratios.R.x, y: ratios.R.y } : null
  };
}

function applyTheme(theme){
  const normalized = theme === "navy" ? "dark" : theme;
  const next = THEMES.includes(normalized) ? normalized : DEFAULT_THEME;
  document.documentElement.dataset.theme = next;
  if(typeof window.__update3DTheme === "function"){
    window.__update3DTheme(next);
  }
  try{
    if(typeof localStorage !== "undefined") localStorage.setItem(THEME_KEY, next);
  }catch(_){/* ignore */}
  return next;
}

let customThemeSettings = applyCustomThemeVars(loadCustomTheme());
let currentTheme = DEFAULT_THEME;
try{
  const stored = (typeof localStorage !== "undefined") ? localStorage.getItem(THEME_KEY) : null;
  if(stored) currentTheme = stored;
}catch(_){ currentTheme = DEFAULT_THEME; }
currentTheme = applyTheme(currentTheme);

/* Exact asset names */
const PENDANTS = ["Infinity Knot 1.svg"];
const LINKS    = ["halo link.svg", "gold circle link.svg"];

/* Locks (terminal, left end only) */
const LOCKS = ["dolphin fish lock.svg"];

const LOCK_META = {
  "dolphin fish lock.svg": {
    targetH: 65,
    rotate: -90,
    // pin positions as ratios of the rendered box (0..1)
    pins: {
      L: { x: 0.20, y: 0.50 },
      R: { x: 0.965, y: 0.505 } // connector ring center
    },
    // optional micro-nudge
    dx: 0,
    dy: 0
  }
};


/* Link layout meta (tweak targetH if your halo looks too big/small) */
const LINK_META = { "halo link.svg": { targetH: 34, rotate: 0 } };

const LINK_PARTS = {
  "halo link.svg": {
    base:  "halo link.svg",
    under: "bottom half of the halo link.svg",
    over:  "top half of the halo link.svg",
    targetH: 34,
    rotate: 0
  },

  // NEW:
  "gold circle link.svg": {
    base:  "gold circle link.svg",
    under: "gold circle link bottom.svg",
    over:  "gold circle link top.svg",
    targetH: 30,  // adjust if your circle looks too big/small
    rotate: 0     // set to 90 if your art is “standing up” sideways
  }
};



const STL_FILES = {
  pendant: {
    "Infinity Knot 1.svg": "pendant/Infinity Knot 1 1mm.stl"
  },
  link: {
    "halo link.svg": "link/halo link 1mm.stl",
    "gold circle link.svg": "link/gold circle link.stl"
  }
};

const PENDANT_MASK_ID = "pendantCutMask";

/* Placeholder weights */
const WEIGHTS = {
  "Infinity Knot 1.svg": 0.32,
  "halo link.svg": 0.10,
  "gold circle link.svg": 0.10,
  "dolphin fish lock.svg": 0.12,
  "__default_pendant": 0.30,
  "__default_link": 0.10
};


/* DOM refs */
const stage = document.getElementById("stage");
const defs = document.getElementById("defs");
const bracelet = document.getElementById("bracelet");
const selThemeInner = document.getElementById("themeSelect");
const selThemeTop = document.getElementById("themeSelectTop");
const selTheme = selThemeInner || selThemeTop;
const selPendant = document.getElementById("pendant");
const selLock = document.getElementById("lockSelect");
const rowsBox = document.getElementById("rows");
const btnAddRow = document.getElementById("addRow");
const btnSVG = document.getElementById("downloadSVG");
const btnPNG = document.getElementById("downloadPNG");
const btnReset = document.getElementById("reset");
const btnSaveSession = document.getElementById("saveSession");
const inpStep = document.getElementById("angleStep");
const outStep = document.getElementById("angleStepOut");
const selMetal = document.getElementById("metalPreset");
const inpWrist = document.getElementById("wristSize");
const lblTotalWeight = document.getElementById("totalWeight");
const lblMetalWeight = document.getElementById("metalWeight");
const lblEstimate = document.getElementById("priceEstimate");
const lblMaterialDetails = document.getElementById("materialDetails");
const materialNarrative = document.getElementById("materialNarrative");
const toast = document.getElementById("toast");
const btnStartTour = document.getElementById("startTour");
const tourOverlay = document.getElementById("tourOverlay");
const tourSpotlight = document.getElementById("tourSpotlight");
const tourCard = document.getElementById("tourCard");
const tourTitle = document.getElementById("tourTitle");
const tourBody = document.getElementById("tourBody");
const tourNext = document.getElementById("tourNext");
const tourPrev = document.getElementById("tourPrev");
const tourSkip = document.getElementById("tourSkip");
const themeDesigner = document.getElementById("themeDesigner");
const inpCustomAccent = document.getElementById("customAccent");
const inpCustomBackground = document.getElementById("customBackground");
const inpCustomBackground2 = document.getElementById("customBackground2");
const inpCustomInk = document.getElementById("customInk");
const btnApplyCustomTheme = document.getElementById("applyCustomTheme");
const wishlistCTA = document.getElementById("wishlistCTA");
const selLighting = document.getElementById("lightingPreset");
const cameraButtons = Array.from(document.querySelectorAll('.cameraControls button'));

let lastToken = 0;
let lastMaterialSnapshot = null;
let toastTimer = null;
let isRestoringSession = false;
let tourIndex = 0;
let isTourActive = false;

/* Utils */
const enc = s => encodeURIComponent(s); // keep %20 for spaces (GitHub Pages)
async function fetchSVGText(path){ const r=await fetch(path); if(!r.ok) throw new Error("load "+path); return r.text(); }
function parseSVG(text){ return new DOMParser().parseFromString(text,"image/svg+xml").documentElement; }
function clear(n){ while(n.firstChild) n.removeChild(n.firstChild); }
function makeOption(label, value, key){
  const o = document.createElement("option");
  o.textContent = label;
  o.value = value;
  if(key) o.setAttribute('data-i18n', key);
  return o;
}
function weightFor(name,type){ return WEIGHTS[name] ?? (type==="pendant" ? WEIGHTS.__default_pendant : WEIGHTS.__default_link); }
const toNum = v => (v==null||v==="") ? null : (typeof v==="number" ? v : parseFloat(String(v)));
function getStepDeg(){
  const v = Math.max(0, Math.min(15, parseFloat(inpStep?.value ?? 15)));
  if(outStep) outStep.textContent = `${v}°`;
  return v;
}
function parseCoord(v, dim){ if(v==null) return null; const s=String(v).trim(); return s.endsWith("%") ? parseFloat(s)/100*dim : parseFloat(s); }
function rewriteURLRefs(root, idMap){
  if(!root || !idMap) return;
  const ATTRS = ['clip-path','mask','filter','fill','stroke',
                 'marker-start','marker-mid','marker-end'];
  const w = document.createTreeWalker(root, NodeFilter.SHOW_ELEMENT);
  while(w.nextNode()){
    const el = w.currentNode;

    // url(#id) attributes
    for(const a of ATTRS){
      const v = el.getAttribute(a);
      if(!v) continue;
      const m = v.match(/^url\(#([^)]+)\)$/);
      if(m && idMap[m[1]]) el.setAttribute(a, `url(#${idMap[m[1]]})`);
    }

    // <use href="#id"> and old xlink:href
    const href = el.getAttribute('href') || el.getAttribute('xlink:href');
    if(href && href.startsWith('#')){
      const key = href.slice(1);
      if(idMap[key]){
        el.setAttribute('href', `#${idMap[key]}`);
        el.setAttribute('xlink:href', `#${idMap[key]}`);
      }
    }
  }
}

function populateMetalOptions(){
  if(!selMetal) return;
  const prev = selMetal.value;
  selMetal.innerHTML = '';
  METAL_PRESETS.forEach(meta => {
    selMetal.appendChild(makeOption(t(meta.labelKey), meta.id, meta.labelKey));
  });
  if(prev && METAL_PRESETS.some(meta => meta.id === prev)){
    selMetal.value = prev;
  }else if(!selMetal.value && METAL_PRESETS[0]){
    selMetal.value = METAL_PRESETS[0].id;
  }
}

function applyDynamicTranslations(){
  populateMetalOptions();

  if(selLock){
    Array.from(selLock.options).forEach(opt => {
      const key = opt.getAttribute('data-i18n');
      if(key) opt.textContent = t(key);
    });
  }

  document.querySelectorAll('#rows .row').forEach(row => {
    const buttons = row.querySelectorAll('button');
    if(buttons[0]) buttons[0].textContent = t('builder.row.duplicate');
    if(buttons[1]) buttons[1].textContent = t('builder.row.remove');
  });

  if(tourSkip) tourSkip.textContent = t('builder.tour.skip');
  if(!isTourActive){
    if(tourTitle) tourTitle.textContent = t('builder.tour.welcome.title');
    if(tourBody) tourBody.textContent = t('builder.tour.welcome.body');
  }
  if(tourPrev) tourPrev.textContent = t('builder.tour.prev');
  if(tourNext) tourNext.textContent = t('builder.tour.next');

  const stlSelect = document.getElementById('stlSelect');
  if(stlSelect){
    Array.from(stlSelect.options).forEach(opt => {
      const key = opt.getAttribute('data-i18n');
      if(key) opt.textContent = t(key);
    });
  }

  if(selLighting){
    Array.from(selLighting.options).forEach(opt => {
      const key = opt.getAttribute('data-i18n');
      if(key) opt.textContent = t(key);
    });
  }

  cameraButtons.forEach(btn => {
    const key = btn.getAttribute('data-i18n');
    if(key) btn.textContent = t(key);
  });
}

function getMetalPreset(){
  const id = selMetal?.value || METAL_PRESETS[0]?.id;
  return METAL_PRESETS.find(meta => meta.id === id) || METAL_PRESETS[0];
}

function getWristScale(){
  const wrist = Math.max(10, Math.min(28, parseFloat(inpWrist?.value ?? BASE_WRIST_CM) || BASE_WRIST_CM));
  if(inpWrist) inpWrist.value = wrist.toString();
  return wrist / BASE_WRIST_CM;
}

function updateMaterialSummary(baseWeight){
  const preset = getMetalPreset();
  const wristScale = getWristScale();

  // Convert the baseline volume to the selected alloy’s mass
  const volume = baseWeight / BASE_DENSITY;            // cm³
  const metalWeight = volume * preset.density * wristScale; // g
  const totalWeight = metalWeight;

  // Price comes from live spot (store logic); filled by refresh loop
  const k = kiratForPreset(preset.id);
  const pricePerGram = k ? (window.__HCJ_PRICE_PER_GRAM__ || preset.pricePerGram) : preset.pricePerGram;
  const estimate = pricePerGram * metalWeight;

  if(lblTotalWeight) lblTotalWeight.textContent = `${totalWeight.toFixed(2)} g`;
  if(lblMetalWeight) lblMetalWeight.textContent = `${metalWeight.toFixed(2)} g`;
  if(lblEstimate) lblEstimate.textContent = priceFormatter.format(estimate || 0);
  const presetLabel = t(preset.labelKey);
  const densityStr = preset.density.toFixed(1);
  if(lblMaterialDetails) lblMaterialDetails.textContent =
    t('builder.summary.detailsMeta', { metal: presetLabel, density: densityStr });
  const baseNarrative = t('builder.materialNarrative', { metal: presetLabel, scale: wristScale.toFixed(2) });
  const presetNarrative = preset.narrativeKey ? t(preset.narrativeKey) : '';
  if(materialNarrative) materialNarrative.textContent = presetNarrative ? `${baseNarrative} ${presetNarrative}`.trim() : baseNarrative;

  lastMaterialSnapshot = { baseWeight, totalWeight, metalWeight, estimate, presetId: preset.id, wristScale };
  return lastMaterialSnapshot;
}

/* ===== Live gold price (shared with store) ===== */
const GOLDAPI_FREE = [
  "https://api.gold-api.com/price/XAU",
  "https://api.gold-api.com/price/XAU/USD",
  "https://www.gold-api.com/price/XAU",
  "https://www.gold-api.com/price/XAU/USD"
];
function pickOuncePrice(d){
  const c = [d?.price, d?.usd, d?.usd_ounce, d?.price_ounce, d?.ounce, d?.oz,
             d?.result?.price, d?.XAU?.USD].map(Number).filter(v => isFinite(v) && v > 0);
  if (c.length) return c[0];
  const g24 = Number(d?.gram_24k || d?.price_gram_24k || d?.g24 || d?.per_gram);
  return (isFinite(g24) && g24 > 0) ? g24 * 31.1 : NaN;
}
function timeoutFetch(u,ms){
  const c = new AbortController(); const id = setTimeout(() => c.abort(), ms);
  return fetch(u,{signal:c.signal,cache:"no-store"}).finally(() => clearTimeout(id));
}
async function getSpotFast(){
  const tries = GOLDAPI_FREE.map(u =>
    timeoutFetch(u,3500)
      .then(r => r.ok ? r.json() : Promise.reject(r.status))
      .then(pickOuncePrice)
      .then(v => (isFinite(v) && v > 0) ? v : Promise.reject("bad"))
  );
  return Promise.any(tries);
}

// Same formula set you use in the store:
function perGramForKirat(oz, kiratStr, fee){
  const k = String(kiratStr||"").toLowerCase();
  const add = Number.isFinite(fee) ? fee : 10; // default fee/gram
  if (/\b18\b/.test(k)) return (((oz + 30) * 32 * 750 / 995)/1000) + add;
  if (/\b21\b/.test(k)) return (((oz + 30) * 32 * 875 / 995)/1000) + add;
  if (/\b22\b/.test(k)) return (((oz + 30) * 32 * 916 / 995)/1000) + add;
  if (/\b24\b/.test(k)) return (((oz + 30) / 31.1)/1000) + add;
  return NaN;
}

function kiratForPreset(presetId){
  if(/gold-18/.test(presetId)) return "18";
  if(/gold-21/.test(presetId)) return "21";
  return ""; // silver uses fixed pricePerGram
}

// Refresh a global per-gram price used by updateMaterialSummary()
let _ppgTimer = null;
if(typeof window.__HCJ_PRICE_PER_GRAM__ === 'undefined') window.__HCJ_PRICE_PER_GRAM__ = undefined;

async function refreshPerGramPrice(){
  try{
    const oz = await getSpotFast();
    const preset = getMetalPreset();
    const k = kiratForPreset(preset.id);
    const ppg = k ? perGramForKirat(oz, k, 10) : preset.pricePerGram; // fee=10 default
    if(isFinite(ppg) && ppg > 0){
      window.__HCJ_PRICE_PER_GRAM__ = ppg;
      // Recompute the summary with the fresh price
      if(lastMaterialSnapshot) updateMaterialSummary(lastMaterialSnapshot.baseWeight);
    }
  }catch(_){ /* keep last price */ }
}

// start loop
refreshPerGramPrice();
if(_ppgTimer) clearInterval(_ppgTimer);
_ppgTimer = setInterval(refreshPerGramPrice, 10000);

function showToast(message){
  if(!toast) return;
  toast.textContent = message;
  toast.classList.add('show');
  if(toastTimer) clearTimeout(toastTimer);
  toastTimer = setTimeout(()=> toast.classList.remove('show'), 3400);
}

function collectSessionState(){
  return {
    theme: selTheme?.value || currentTheme,
    pendant: selPendant?.value || PENDANTS[0],
    lock: selLock?.value || '',
    rows: readRows(),
    angle: parseFloat(inpStep?.value ?? 15) || 15,
    metal: selMetal?.value || METAL_PRESETS[0]?.id,
    wrist: parseFloat(inpWrist?.value ?? BASE_WRIST_CM) || BASE_WRIST_CM,
    lighting: selLighting?.value || 'gallery',
    model: document.getElementById('stlSelect')?.value || '__assembly__',
    autoRotate: document.getElementById('stlAutoRotate')?.checked || false
  };
}

function saveSession(auto = false){
  if(isRestoringSession) return;
  try{
    localStorage?.setItem(STORAGE_KEYS.session, JSON.stringify(collectSessionState()));
    if(!auto) showToast(t('builder.toast.sessionSaved'));
  }catch(_){ if(!auto) showToast(t('builder.toast.sessionUnavailable')); }
}

function hydrateSession(){
  let data = null;
  try{
    const raw = localStorage?.getItem(STORAGE_KEYS.session);
    if(raw) data = JSON.parse(raw);
  }catch(_){ data = null; }
  if(!data) return false;

  isRestoringSession = true;

  if(selTheme && data.theme){
    selTheme.value = THEMES.includes(data.theme) ? data.theme : currentTheme;
    currentTheme = applyTheme(selTheme.value);
  }

  if(selPendant && data.pendant && PENDANTS.includes(data.pendant)) selPendant.value = data.pendant;
  if(selLock && typeof data.lock === 'string') selLock.value = data.lock;

  rowsBox.innerHTML = '';
  if(Array.isArray(data.rows) && data.rows.length){
    data.rows.forEach(item => addRow(item));
  }else{
    addRow({type:LINKS[0], qty:6});
  }

  if(inpStep && typeof data.angle === 'number'){ inpStep.value = data.angle; }
  if(outStep && inpStep){ outStep.textContent = `${inpStep.value}°`; }
  if(selMetal && data.metal) selMetal.value = data.metal;
  if(inpWrist && data.wrist != null) inpWrist.value = data.wrist;
  if(selLighting && data.lighting) selLighting.value = data.lighting;
  const stlSelect = document.getElementById('stlSelect');
  if(stlSelect && data.model) stlSelect.value = data.model;
  const stlAuto = document.getElementById('stlAutoRotate');
  if(stlAuto && typeof data.autoRotate === 'boolean') stlAuto.checked = data.autoRotate;

  isRestoringSession = false;
  return true;
}

function hasCompletedTour(){
  try{ return localStorage?.getItem(STORAGE_KEYS.tour) === '1'; }
  catch(_){ return false; }
}

function markTourSeen(){
  try{ localStorage?.setItem(STORAGE_KEYS.tour, '1'); }
  catch(_){/* ignore */}
}

function buildTourSteps(){
  return [
    { selector: '.headActions', title: t('tour.s1.h'), body: t('tour.s1.p') },
    { selector: '#pendant', title: t('tour.s2.h'), body: t('tour.s2.p') },
    { selector: '#rows', title: t('tour.s3.h'), body: t('tour.s3.p') },
    { selector: '#angleStep', title: t('tour.s4.h'), body: t('tour.s4.p') },
    { selector: '#materialSummary', title: t('tour.s5.h'), body: t('tour.s5.p') },
    { selector: '#preview3d', title: t('tour.s6.h'), body: t('tour.s6.p') },
    { selector: '.buttons', title: t('tour.s7.h'), body: t('tour.s7.p') }
  ];
}

let TOUR_STEPS = buildTourSteps();

function rebuildTourSteps(){
  TOUR_STEPS = buildTourSteps();
}

function spotlightStep(step){
  if(!tourSpotlight) return;
  const padding = 16;
  const target = step?.selector ? document.querySelector(step.selector) : null;
  if(target){
    const rect = target.getBoundingClientRect();
    const scrollLeft = window.scrollX || document.documentElement.scrollLeft || 0;
    const scrollTop = window.scrollY || document.documentElement.scrollTop || 0;
    const x = rect.left + scrollLeft - padding;
    const y = rect.top + scrollTop - padding;
    const w = rect.width + padding * 2;
    const h = rect.height + padding * 2;
    tourSpotlight.style.width = `${w}px`;
    tourSpotlight.style.height = `${h}px`;
    tourSpotlight.style.transform = `translate(${x}px, ${y}px)`;
    target.scrollIntoView({ behavior: 'smooth', block: 'center' });
  }else{
    tourSpotlight.style.width = '0';
    tourSpotlight.style.height = '0';
  }
}

function showTourStep(idx){
  const step = TOUR_STEPS[idx];
  if(!step){ endTour(); return; }
  tourIndex = idx;
  if(tourTitle) tourTitle.textContent = step.title;
  if(tourBody) tourBody.textContent = step.body;
  spotlightStep(step);
  if(tourPrev){
    tourPrev.disabled = idx === 0;
    tourPrev.textContent = t('builder.tour.prev');
  }
  if(tourNext){
    const key = idx === TOUR_STEPS.length - 1 ? 'builder.tour.finish' : 'builder.tour.next';
    tourNext.textContent = t(key);
  }
}

function startTour(force = false){
  if(!tourOverlay) return;
  if(!force && hasCompletedTour()) return;
  isTourActive = true;
  tourOverlay.classList.add('open');
  tourOverlay.setAttribute('aria-hidden', 'false');
  showTourStep(0);
}

function endTour(markSeen = true){
  if(!tourOverlay) return;
  isTourActive = false;
  tourOverlay.classList.remove('open');
  tourOverlay.setAttribute('aria-hidden', 'true');
  if(markSeen) markTourSeen();
}

function addToWishlist(){
  const summary = lastMaterialSnapshot || {};
  const entry = {
    ...collectSessionState(),
    summary,
    savedAt: Date.now()
  };
  try{
    const raw = localStorage?.getItem(STORAGE_KEYS.wishlist);
    const list = raw ? JSON.parse(raw) : [];
    list.unshift(entry);
    if(list.length > 12) list.length = 12;
    localStorage?.setItem(STORAGE_KEYS.wishlist, JSON.stringify(list));
    showToast(t('builder.toast.wishlistAdded'));
  }catch(_){
    showToast(t('builder.toast.wishlistUnavailable'));
  }
}

/* Load SVG, scale, rotate, extract invisible pins */
async function loadScaleRotate(dir, filename, targetH, rotateDeg){
  const url = `./${dir}/${enc(filename)}`;
  const svg = parseSVG(await fetchSVGText(url));

  let vb = svg.getAttribute("viewBox");
  let w,h;
  if(vb){ const parts = vb.replace(/,/g," ").trim().split(/\s+/).map(Number); w=parts[2]; h=parts[3]; }
  else{ w = toNum(svg.getAttribute("width")) || 100; h = toNum(svg.getAttribute("height")) || 100; }

  const scale = targetH / h;
  const g = document.createElementNS("http://www.w3.org/2000/svg","g");
  [...svg.childNodes].forEach(n=>{
    if(n.nodeType===1){
      if(n.tagName.toLowerCase()==="defs"){
        [...n.children].forEach(el=>{
          // Keep original IDs so clip-path="url(#clip-top|clip-bottom)" still matches.
          defs.appendChild(stage.ownerDocument.importNode(el,true));
        });
      }else{
        g.appendChild(stage.ownerDocument.importNode(n,true));
      }
    }
  });

  const cxS=(w*scale)/2, cyS=(h*scale)/2;
  let tf = `scale(${scale})`;
  if(rotateDeg && Math.abs(rotateDeg)%360!==0){ tf += ` rotate(${rotateDeg}, ${w/2}, ${h/2})`; }
  g.setAttribute("transform", tf);

  let outW = (Math.abs((rotateDeg||0)%180)===90) ? h*scale : w*scale;
  let outH = (Math.abs((rotateDeg||0)%180)===90) ? w*scale : h*scale;

  let pinL=null, pinR=null;
  const pinsGroup = svg.querySelector("#pins");
  if(pinsGroup){
    const cL = pinsGroup.querySelector("#pinL");
    const cR = pinsGroup.querySelector("#pinR");
    if(cL && cR){
      let pxL = parseCoord(cL.getAttribute("cx"), w) * scale;
      let pyL = parseCoord(cL.getAttribute("cy"), h) * scale;
      let pxR = parseCoord(cR.getAttribute("cx"), w) * scale;
      let pyR = parseCoord(cR.getAttribute("cy"), h) * scale;

      const rot = (rotateDeg||0) * Math.PI/180;
      if(rot!==0){
        function rotP(x,y){ const dx=x-cxS, dy=y-cyS; return {x: cxS + (dx*Math.cos(rot)-dy*Math.sin(rot)), y: cyS + (dx*Math.sin(rot)+dy*Math.cos(rot))}; }
        const a = rotP(pxL,pyL), b = rotP(pxR,pyR);
        pinL=a; pinR=b;
      }else{ pinL={x:pxL,y:pyL}; pinR={x:pxR,y:pyR}; }
    }
  }

  const pinRatios = {
    L: pinL && outW && outH ? { x: pinL.x/outW, y: pinL.y/outH } : null,
    R: pinR && outW && outH ? { x: pinR.x/outW, y: pinR.y/outH } : null
  };

  return {
    node:g,
    width:outW,
    height:outH,
    rawWidth:w,
    rawHeight:h,
    scale:scale,
    rotation: rotateDeg || 0,
    pins:{L:pinL,R:pinR},
    pinRatios
  };
}

/* Init UI */
(function init(){
  PENDANTS.forEach(n=> selPendant.appendChild(makeOption(n,n)));
  if(selPendant && !selPendant.value) selPendant.value = PENDANTS[0];

  if(selLock){
    selLock.appendChild(makeOption(t('builder.lock.none'), "", 'builder.lock.none'));
    LOCKS.forEach(n=> selLock.appendChild(makeOption(n, n)));
    selLock.value = selLock.value ?? "";
    selLock.addEventListener("change", render);
  }

  if(inpStep){
    if(outStep) outStep.textContent = `${inpStep.value}°`;
    inpStep.addEventListener("input", ()=>{
      if(outStep) outStep.textContent = `${getStepDeg()}°`;
      render();
    });
  }

  populateMetalOptions();

  if(selTheme){
    const initial = THEMES.includes(currentTheme) ? currentTheme : DEFAULT_THEME;
    selTheme.value = initial;
    if(selThemeInner && selThemeInner !== selTheme) selThemeInner.value = initial;
    if(selThemeTop && selThemeTop !== selTheme) selThemeTop.value = initial;
    updateThemeDesignerVisibility();
    selTheme.addEventListener("change", e=>{
      const chosen = applyTheme(e.target.value);
      currentTheme = chosen;
      if(selThemeInner && selThemeInner !== e.target) selThemeInner.value = chosen;
      if(selThemeTop && selThemeTop !== e.target) selThemeTop.value = chosen;
      updateThemeDesignerVisibility();
      saveSession(true);
      render();
    });
  }

  if(selMetal) selMetal.addEventListener("change", ()=>{ refreshPerGramPrice(); render(); });
  if(inpWrist) inpWrist.addEventListener("input", ()=>render());

  if(btnAddRow) btnAddRow.addEventListener("click", ()=>{ addRow(); render(); });
  if(selPendant) selPendant.addEventListener("change", render);
  if(btnSVG) btnSVG.addEventListener("click", downloadSVG);
  if(btnPNG) btnPNG.addEventListener("click", downloadPNG);

  if(btnReset){
    btnReset.addEventListener("click", ()=>{
      rowsBox.innerHTML = "";
      addRow({type:LINKS[0], qty:6});
      if(selPendant) selPendant.value = PENDANTS[0];
      if(selLock) selLock.value = "";
      if(inpStep){ inpStep.value = "15"; if(outStep) outStep.textContent = "15°"; }
      if(selMetal && METAL_PRESETS[0]) selMetal.value = METAL_PRESETS[0].id;
      if(inpWrist) inpWrist.value = BASE_WRIST_CM.toString();
      saveSession(true);
      showToast(t('builder.toast.reset'));
      render();
    });
  }

  if(btnSaveSession) btnSaveSession.addEventListener("click", ()=> saveSession(false));
  if(btnStartTour) btnStartTour.addEventListener("click", ()=> startTour(true));

  if(btnApplyCustomTheme){
    btnApplyCustomTheme.addEventListener("click", ()=>{
      customThemeSettings = normalizeThemeConfig({
        accent: inpCustomAccent?.value,
        bg: inpCustomBackground?.value,
        bg2: inpCustomBackground2?.value,
        ink: inpCustomInk?.value
      });
      applyCustomThemeVars(customThemeSettings);
      saveCustomTheme(customThemeSettings);
      currentTheme = applyTheme('custom');
      if(selTheme) selTheme.value = 'custom';
      updateThemeDesignerVisibility();
      render();
      showToast(t('builder.toast.customApplied'));
    });
  }

  if(themeDesigner){
    [inpCustomAccent, inpCustomBackground, inpCustomBackground2, inpCustomInk].forEach(input=>{
      if(!input) return;
      input.addEventListener('input', ()=>{
        if(selTheme?.value === 'custom'){
          customThemeSettings = normalizeThemeConfig({
            accent: inpCustomAccent?.value,
            bg: inpCustomBackground?.value,
            bg2: inpCustomBackground2?.value,
            ink: inpCustomInk?.value
          });
          applyCustomThemeVars(customThemeSettings);
          saveCustomTheme(customThemeSettings);
          render();
        }
      });
    });
  }

  if(selLighting){
    selLighting.addEventListener('change', ()=>{
      if(typeof window.__setLightingPreset === 'function') window.__setLightingPreset(selLighting.value);
      saveSession(true);
    });
  }

  cameraButtons.forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const id = btn.dataset.bookmark;
      if(typeof window.__goToBookmark === 'function') window.__goToBookmark(id);
    });
  });

  if(wishlistCTA) wishlistCTA.addEventListener('click', addToWishlist);

  const restored = hydrateSession();
  if(!restored){
    addRow({type:LINKS[0], qty:6});
  }

  refreshPerGramPrice();
  updateThemeDesignerVisibility();
  applyDynamicTranslations();
  render();

  if(selLighting && typeof window.__setLightingPreset === 'function'){
    window.__setLightingPreset(selLighting.value);
  }

  document.getElementById('tab2d').addEventListener('click', ()=>switchMode('2d'));
  document.getElementById('tab3d').addEventListener('click', ()=>switchMode('3d'));

  if(!hasCompletedTour()){
    setTimeout(()=> startTour(false), 900);
  }

  window.addEventListener('resize', ()=>{ if(isTourActive) showTourStep(tourIndex); });
  document.addEventListener('keydown', e=>{ if(e.key === 'Escape' && isTourActive) endTour(false); });
  if(tourOverlay) tourOverlay.addEventListener('click', e=>{ if(e.target === tourOverlay) endTour(false); });
  if(tourNext) tourNext.addEventListener('click', ()=>{ if(tourIndex >= TOUR_STEPS.length - 1) endTour(); else showTourStep(tourIndex + 1); });
  if(tourPrev) tourPrev.addEventListener('click', ()=>{ if(tourIndex > 0) showTourStep(tourIndex - 1); });
  if(tourSkip) tourSkip.addEventListener('click', ()=> endTour());
})();

function addRow(init={type:LINKS[0], qty:6}){
  const row = document.createElement("div"); row.className="row";
  const sel = document.createElement("select"); LINKS.forEach(n=> sel.appendChild(makeOption(n,n))); sel.value = init.type;
  const qty = document.createElement("input"); qty.type="number"; qty.min="0"; qty.max="80"; qty.step="1"; qty.value = String(init.qty ?? 6);
  const addBtn=document.createElement("button"); addBtn.textContent = t('builder.row.duplicate');
  const delBtn=document.createElement("button"); delBtn.textContent = t('builder.row.remove');

  row.appendChild(sel); row.appendChild(qty); row.appendChild(addBtn); row.appendChild(delBtn);
  rowsBox.appendChild(row);
  sel.addEventListener("change", render);
  qty.addEventListener("input", render);
  addBtn.addEventListener("click", ()=>{ addRow({type:sel.value, qty:qty.valueAsNumber||0}); render(); });
  delBtn.addEventListener("click", ()=>{ rowsBox.removeChild(row); render(); });
}

function readRows(){
  return [...rowsBox.querySelectorAll(".row")].map(r=>{
    const type = r.querySelector("select").value;
    const qty = r.querySelector('input[type="number"]').valueAsNumber||0;
    return {type, qty};
  }).filter(r=>r.qty>0);
}

function tintMetal(node, metalId){
  const fillId =
    metalId === 'gold-21' ? 'gold21' :
    metalId === 'silver'  ? 'silver' :
                            'gold18';

  const strokeColor =
    metalId === 'silver'  ? '#8a8a8a' :
    metalId === 'gold-21' ? '#8a6a00' :
                            '#b88a1a';

  const w = document.createTreeWalker(node, NodeFilter.SHOW_ELEMENT);
  while(w.nextNode()){
    const el  = w.currentNode;
    const tag = (el.tagName || '').toLowerCase();
    if(["path","circle","ellipse","rect","polygon","polyline","line"].includes(tag)){
      const fill   = el.getAttribute("fill");
      const stroke = el.getAttribute("stroke");
      if(!fill || fill!=="none") el.setAttribute("fill", `url(#${fillId})`);
      if(stroke && stroke!=="none") el.setAttribute("stroke", strokeColor);
      el.setAttribute("filter", "url(#softShadow)");
    }
  }
}

function clonePendantForMask(node){
  if(!node) return null;
  const clone = node.cloneNode(true);
  const elements=[clone];
  const walker = document.createTreeWalker(clone, NodeFilter.SHOW_ELEMENT);
  while(walker.nextNode()) elements.push(walker.currentNode);
  for(const el of elements){
    if(!(el?.tagName)) continue;
    const tag = el.tagName.toLowerCase();
    if(tag === "defs"){ el.remove(); continue; }
    if(el.hasAttribute("id")) el.removeAttribute("id");
    if(el.hasAttribute("filter")) el.removeAttribute("filter");
    if(tag !== "g" && tag !== "mask"){
      el.setAttribute("fill", "#000");
      el.setAttribute("stroke", "#000");
      if(el.hasAttribute("stroke-width")) el.removeAttribute("stroke-width");
    }
  }
  return clone;
}

function buildLinkGroup(def, tx, ty, metalId = getMetalPreset().id){
  const g = document.createElementNS("http://www.w3.org/2000/svg","g");
  g.setAttribute("transform", `translate(${tx}, ${ty})`);

  const underNode = (def.under || def.base).node.cloneNode(true);
  tintMetal(underNode, metalId);
  g.appendChild(underNode);

  if(def.over){
    const overNode = def.over.node.cloneNode(true);
    tintMetal(overNode, metalId);
    g.appendChild(overNode);
  }
  return g;
}

// draw ONLY one half ("under" | "over"), with optional rotation around a pivot
function buildLinkLayer(def, tx, ty, which /* 'under'|'over' */, rotateDeg = 0, pivot = null, metalId = getMetalPreset().id){
  const g = document.createElementNS("http://www.w3.org/2000/svg","g");
  // apply translate first, then rotate around the link's pin (pivot is in local coords)
  if (rotateDeg && pivot) {
    g.setAttribute("transform",
      `translate(${tx}, ${ty}) rotate(${rotateDeg}, ${pivot.x}, ${pivot.y})`);
  } else {
    g.setAttribute("transform", `translate(${tx}, ${ty})`);
  }

  const pack = which === 'over' ? (def.over || null) : (def.under || def.base);
  if(!pack) return g;

  const node = pack.node.cloneNode(true);
  tintMetal(node, metalId);
  g.appendChild(node);
  return g;
}



function clonePoint(pt){ return pt ? {x: pt.x, y: pt.y} : null; }

function sanitizePackFor3D(pack, type, name){
  if(!pack) return null;
  const stl = (type === 'pendant' ? STL_FILES.pendant[name] : STL_FILES.link[name]) || null;
  const pinRatios = pack.pinRatios || {};
  return {
    type,
    name,
    stl,
    width: pack.width,
    height: pack.height,
    rawWidth: pack.rawWidth,
    rawHeight: pack.rawHeight,
    scale: pack.scale,
    rotation: pack.rotation || 0,
    pins: {
      L: clonePoint(pack.pins?.L),
      R: clonePoint(pack.pins?.R)
    },
    pinRatios: {
      L: pinRatios.L ? {x: pinRatios.L.x, y: pinRatios.L.y} : null,
      R: pinRatios.R ? {x: pinRatios.R.x, y: pinRatios.R.y} : null
    }
  };
}
// === rotation helpers for 2D layout ===
const toRad = d => d * Math.PI / 180;
function rotateAround(x, y, cx, cy, rad){
  const dx = x - cx, dy = y - cy;
  return {
    x: cx + dx * Math.cos(rad) - dy * Math.sin(rad),
    y: cy + dx * Math.sin(rad) + dy * Math.cos(rad)
  };
}

/* Render everything */
async function render(){
  const token=++lastToken;
  clear(bracelet);
  if(defs){
    defs.querySelectorAll(`[data-role="pendant-mask"]`).forEach(n=>n.remove());
  }

  const themeStyles = getComputedStyle(document.documentElement);
  const bg2 = (themeStyles.getPropertyValue("--bg2") || "").trim() || "#0f0b06";
  const stageBg = stage.querySelector('[data-role="background"]');
  if(stageBg) stageBg.setAttribute("fill", bg2);
  const rows = readRows();
  const pendantName = selPendant.value;
  const pendantH = 160;           // fixed pendant height
  const lockName = (selLock?.value || "").trim();
  const lockH = 70;               // fixed lock height
  const currentMetal = getMetalPreset().id;

  // two z-stacks for the “woven” effect
  const stackUnder = document.createElementNS("http://www.w3.org/2000/svg","g");
  stackUnder.setAttribute("id","stackUnder");
  const stackOverMasked = document.createElementNS("http://www.w3.org/2000/svg","g");
  stackOverMasked.setAttribute("id","stackOverMasked");
  const stackOverTop = document.createElementNS("http://www.w3.org/2000/svg","g");
  stackOverTop.setAttribute("id","stackOverTop");

  // order: UNDER → (pendant) → OVER
  bracelet.appendChild(stackUnder);

  const layoutLeft=[];
  const layoutRight=[];
  let layoutPendant=null;

  // Pendant
  let pendantPack;
  try{
    pendantPack = await loadScaleRotate("pendant", pendantName, pendantH, 0);
  }catch(e){ console.error(e); pendantPack = {node:document.createElementNS("http://www.w3.org/2000/svg","g"), width:120, height:60, pins:{L:null,R:null}}; }
  if(token!==lastToken) return;
  const pendantMaskClone = clonePendantForMask(pendantPack.node);
  const pendant3D = sanitizePackFor3D(pendantPack, 'pendant', pendantName);

 let lockPack = null;
if(lockName){
  try{
    const meta = LOCK_META[lockName] || { rotate: 0 };
    const targetH = Number.isFinite(lockH) ? lockH : (meta.targetH ?? 34);
    lockPack = await loadScaleRotate("lock", lockName, targetH, meta.rotate ?? 0);

    // NEW: only override if the SVG had no pins
if (!lockPack.pins?.L || !lockPack.pins?.R) {
  if (meta.pins) applyPinsByRatio(lockPack, meta.pins);
}

  }catch(e){
    console.error(e);
    lockPack = null;
  }
}

  if(token!==lastToken) return;

  // Link defs
  const uniq = [...new Set(rows.map(r=>r.type))];
  const linkDefs = {};
  for(const t of uniq){
    try{
      if(LINK_PARTS[t]){
        const p = LINK_PARTS[t];
        const base  = await loadScaleRotate("link", p.base,  p.targetH, p.rotate);
        const under = await loadScaleRotate("link", p.under, p.targetH, p.rotate);
        const over  = await loadScaleRotate("link", p.over,  p.targetH, p.rotate);
        linkDefs[t] = { base, under, over };
      }else{
        const meta = LINK_META[t] || {targetH:34, rotate:0};
        const pack = await loadScaleRotate("link", t, meta.targetH, meta.rotate);
        linkDefs[t] = { base: pack, under: pack, over: null };
      }
    }catch(e){ console.error(e); }
    if(token!==lastToken) return;
  }

  // Layout
  const PAD = 40, W = STAGE_W, midY = STAGE_H / 2;
  function spanOf(def){
    const p = def?.base?.pins;
    return (p?.L && p?.R) ? (p.R.x - p.L.x) : (def?.base?.width || 0);
  }

  const leftSeq = [];
  rows.forEach(r => { for (let i = 0; i < r.qty; i++) leftSeq.push(r.type); });
  const rightSeq = [...leftSeq];

  const leftLinksSpan  = leftSeq.reduce((s,t)=> s + spanOf(linkDefs[t]), 0);
  const rightLinksSpan = rightSeq.reduce((s,t)=> s + spanOf(linkDefs[t]), 0);
  const lockSpan = lockPack ? spanOf({ base: lockPack }) : 0;

  const leftSpan  = leftLinksSpan + lockSpan;
  const rightSpan = rightLinksSpan;

  const pendSpan = spanOf({base:pendantPack});

  const totalSpan = leftSpan + pendSpan + rightSpan;
  let startX = Math.max(PAD, (W - totalSpan)/2);

  const STEP_UI = getStepDeg(); // 0..15 from the slider

  // Pendant position
  const pendPinMidY = (pendantPack.pins?.L?.y != null && pendantPack.pins?.R?.y != null)
                      ? (pendantPack.pins.L.y + pendantPack.pins.R.y)/2
                      : pendantPack.height/2;
  const pendantLeftPinWorldX = startX + leftSpan;
  const gpX = pendantLeftPinWorldX - (pendantPack.pins?.L?.x ?? 0);
  const gpY = midY - pendPinMidY;

  const gp = document.createElementNS("http://www.w3.org/2000/svg","g");
  gp.setAttribute("transform", `translate(${gpX}, ${gpY})`);
  let pendantMaskUrl = null;
  if(pendantMaskClone && defs){
    const mask = document.createElementNS("http://www.w3.org/2000/svg","mask");
    mask.setAttribute("id", PENDANT_MASK_ID);
    mask.setAttribute("maskUnits", "userSpaceOnUse");
    mask.setAttribute("maskContentUnits", "userSpaceOnUse");
    mask.setAttribute("data-role", "pendant-mask");
    const rect = document.createElementNS("http://www.w3.org/2000/svg","rect");
    rect.setAttribute("x", "0");
    rect.setAttribute("y", "0");
    rect.setAttribute("width", String(STAGE_W));
    rect.setAttribute("height", String(STAGE_H));
    rect.setAttribute("fill", "#fff");
    const maskGroup = document.createElementNS("http://www.w3.org/2000/svg","g");
    maskGroup.setAttribute("transform", `translate(${gpX}, ${gpY})`);
    maskGroup.appendChild(pendantMaskClone);
    mask.appendChild(rect);
    mask.appendChild(maskGroup);
    defs.appendChild(mask);
    pendantMaskUrl = `url(#${PENDANT_MASK_ID})`;
  }
  tintMetal(pendantPack.node, currentMetal); gp.appendChild(pendantPack.node); bracelet.appendChild(gp);
  bracelet.appendChild(stackOverMasked);
  if(pendantMaskUrl) stackOverMasked.setAttribute("mask", pendantMaskUrl);
  bracelet.appendChild(stackOverTop);

  layoutPendant = {
    type:'pendant',
    pack: pendant3D,
    tx: gpX,
    ty: gpY,
    pins: {
      L: pendantPack.pins?.L ? {x: gpX + pendantPack.pins.L.x, y: gpY + pendantPack.pins.L.y} : null,
      R: pendantPack.pins?.R ? {x: gpX + pendantPack.pins.R.x, y: gpY + pendantPack.pins.R.y} : null
    }
  };

// ---------- LEFT side (pendant → outward), iterate FORWARD ----------
let anchorL = { x: pendantLeftPinWorldX, y: midY };
let leftAngleDeg = 0;

for (let i = 0; i < leftSeq.length; i++) {
  const t = leftSeq[i];
  const d = linkDefs[t]; if (!d) continue;
  const L = d.base.pins?.L, R = d.base.pins?.R;
  const rad = toRad(leftAngleDeg);

  // pivot is the R-pin (we attach to previous via R)
  const pivot = R || null;

  // translation to place the unrotated link so R pin sits at anchor
  const tx = pivot ? (anchorL.x - pivot.x) : (anchorL.x - d.base.width);
  const ty = pivot ? (anchorL.y - pivot.y) : (midY - d.base.height/2);

  // flip halves ONLY for the first link next to the pendant (if it has split art)
  const hasSplit = !!d.over;                 // link provides separate 'over' layer?
  const flipFirst = (i === 0 && hasSplit);   // first left-side link near pendant
  const whichUnder = flipFirst ? 'over' : 'under';
  const whichOver  = flipFirst ? 'under' : 'over';

  const u = buildLinkLayer(d, tx, ty, whichUnder, leftAngleDeg, pivot, currentMetal);
  const o = buildLinkLayer(d, tx, ty, whichOver,  leftAngleDeg, pivot, currentMetal);

  // z-order for weave
  stackUnder.insertBefore(u, stackUnder.firstChild || null);
  const frontTarget = flipFirst ? stackOverTop : stackOverMasked;
  frontTarget.appendChild(o);

  // 3D payload — give this instance the extra rotation
  const pack3D = sanitizePackFor3D(d.base, 'link', t);
  if (pack3D) pack3D.rotation = (pack3D.rotation || 0) + leftAngleDeg;

  layoutLeft.push({
    type: 'link',
    name: t,
    pack: pack3D,
    tx, ty,
    pins: {
      L: L ? { x: tx + L.x, y: ty + L.y } : null,
      R: R ? { x: tx + R.x, y: ty + R.y } : null
    }
  });

  // update anchor: rotate L around R by the same angle
  if (L && R) {
    const Lr = rotateAround(L.x, L.y, R.x, R.y, rad);
    anchorL = { x: tx + Lr.x, y: ty + Lr.y };
  } else {
    anchorL = { x: tx, y: midY };
  }

  leftAngleDeg += STEP_UI;
}


// ----- LEFT terminal lock (optional) -----
if (lockPack) {
  const d = { base: lockPack, under: lockPack, over: null };
  const L = d.base.pins?.L, R = d.base.pins?.R;

  const tx = R ? (anchorL.x - R.x) : (anchorL.x - d.base.width);
  const ty = R ? (anchorL.y - R.y) : (midY - d.base.height / 2);

  // rotate the lock around its R-pin by the current leftAngleDeg
  const pivot = R || null;
  const u = buildLinkLayer(d, tx, ty, 'under', leftAngleDeg, pivot, currentMetal);
  const o = buildLinkLayer(d, tx, ty, 'over',  leftAngleDeg, pivot, currentMetal);

  stackUnder.insertBefore(u, stackUnder.firstChild || null);
  stackOverMasked.appendChild(o);

  const pack3D = sanitizePackFor3D(d.base, 'link', lockName);
  if (pack3D) pack3D.rotation = (pack3D.rotation || 0) + leftAngleDeg;

  layoutLeft.push({
    type: 'link',
    name: lockName,
    pack: pack3D,
    tx, ty,
    pins: {
      L: L ? { x: tx + L.x, y: ty + L.y } : null,
      R: R ? { x: tx + R.x, y: ty + R.y } : null
    }
  });

}

// ---------- RIGHT side (pendant → outward), iterate FORWARD ----------
let anchorR = { x: pendantLeftPinWorldX + pendSpan, y: midY };
let rightAngleDeg = 0;

for (let i = 0; i < rightSeq.length; i++) {
  const t = rightSeq[i];
  const d = linkDefs[t]; if (!d) continue;
  const L = d.base.pins?.L, R = d.base.pins?.R;
  const rad = toRad(rightAngleDeg);

  // pivot is the L-pin (we attach to pendant/previous via L)
  const pivot = L || null;

  const tx = pivot ? (anchorR.x - pivot.x) : (anchorR.x);
  const ty = pivot ? (anchorR.y - pivot.y) : (midY - d.base.height/2);

  // flip halves ONLY for the first link next to the pendant (if it has split art)
  const hasSplit = !!d.over;
  const flipFirst = (i === 0 && hasSplit);   // first right-side link near pendant
  const whichUnder = flipFirst ? 'over' : 'under';
  const whichOver  = flipFirst ? 'under' : 'over';

  const u = buildLinkLayer(d, tx, ty, whichUnder, rightAngleDeg, pivot, currentMetal);
  const o = buildLinkLayer(d, tx, ty, whichOver,  rightAngleDeg, pivot, currentMetal);

  stackUnder.insertBefore(u, stackUnder.firstChild || null);
  const frontTarget = flipFirst ? stackOverTop : stackOverMasked;
  frontTarget.appendChild(o);

  const pack3D = sanitizePackFor3D(d.base, 'link', t);
  if (pack3D) pack3D.rotation = (pack3D.rotation || 0) + rightAngleDeg;

  layoutRight.push({
    type: 'link',
    name: t,
    pack: pack3D,
    tx, ty,
    pins: {
      L: L ? { x: tx + L.x, y: ty + L.y } : null,
      R: R ? { x: tx + R.x, y: ty + R.y } : null
    }
  });

  // update anchor: rotate R around L by the same angle
  if (L && R) {
    const Rr = rotateAround(R.x, R.y, L.x, L.y, rad);
    anchorR = { x: tx + Rr.x, y: ty + Rr.y };
  } else {
    anchorR = { x: tx + d.base.width, y: midY };
  }

  rightAngleDeg += STEP_UI;
}


  // Weight
  const pendantW = weightFor(pendantName,"pendant");
  const linksW = rows.reduce((s,r)=> s + weightFor(r.type,"link") * r.qty*2, 0);
  const lockW = lockName ? weightFor(lockName,"link") : 0;
  updateMaterialSummary(pendantW + linksW + lockW);

  const layoutPayload = {
    items: [...layoutLeft, ...(layoutPendant ? [layoutPendant] : []), ...layoutRight],
    stage: { width: W, height: STAGE_H },
    timestamp: Date.now()
  };
  window.__bracelet3DLayout = layoutPayload;
  if(typeof window.__update3DAssembly === 'function'){
    try{ window.__update3DAssembly(layoutPayload); }
    catch(err){ console.error('3D update failed', err); }
  }
  saveSession(true);
}

/* Export */
function downloadSVG(){
  const clone = stage.cloneNode(true);
  const xml = new XMLSerializer().serializeToString(clone);
  const blob = new Blob([xml],{type:"image/svg+xml;charset=utf-8"});
  const url = URL.createObjectURL(blob); trigger(url,"bracelet.svg");
}
function downloadPNG(){
  const clone = stage.cloneNode(true);
  clone.setAttribute("width", String(STAGE_W));
  clone.setAttribute("height", String(STAGE_H));
  const xml = new XMLSerializer().serializeToString(clone);
  const data = "data:image/svg+xml;base64," + btoa(unescape(encodeURIComponent(xml)));
  const img = new Image();
  img.onload = function(){
    const canvas = document.createElement("canvas");
    canvas.width  = STAGE_W;
    canvas.height = STAGE_H;
    const ctx = canvas.getContext("2d");
    ctx.drawImage(img, 0, 0, STAGE_W, STAGE_H);
    canvas.toBlob(b=> trigger(URL.createObjectURL(b),"bracelet.png"),"image/png",0.98);
  };
  img.src = data;
}
function trigger(url,name){ const a=document.createElement("a"); a.href=url; a.download=name; document.body.appendChild(a); a.click(); a.remove(); setTimeout(()=>URL.revokeObjectURL(url),4000); }

/* Tab switcher with hard 3D resize */
function switchMode(which){
  const b2d=document.getElementById('tab2d'), b3d=document.getElementById('tab3d');
  const p2d=document.getElementById('preview2d'), p3d=document.getElementById('preview3d');
  if(which==='3d'){
    b3d.classList.add('active'); b2d.classList.remove('active');
    p3d.style.display='flex'; p2d.style.display='none';
    setTimeout(()=>{ window.dispatchEvent(new Event('resize')); if(window.__resize3D) window.__resize3D(); }, 50);
  }else{
    b2d.classList.add('active'); b3d.classList.remove('active');
    p2d.style.display='flex'; p3d.style.display='none';
  }
}
</script>

<!-- ==================== 3D VIEWER (fixed) ==================== -->
<script type="importmap">
{
  "imports": {
    "three": "https://cdn.jsdelivr.net/npm/three@0.157.0/build/three.module.js",
    "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.157.0/examples/jsm/"
  }
}
</script>
<script type="module">
import * as THREE from 'three';
import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
import { STLLoader } from 'three/addons/loaders/STLLoader.js';
import { STLExporter } from 'three/addons/exporters/STLExporter.js';

const container = document.getElementById('preview3d');
const canvas    = document.getElementById('stlCanvas');
const sel       = document.getElementById('stlSelect');
const auto      = document.getElementById('stlAutoRotate');
const btnDownload = document.getElementById('stlDownload');
const lightingSelect = document.getElementById('lightingPreset');

const LIGHTING_PRESETS = {
  gallery: {
    exposure: 1.75,
    lights: {
      ambient: { intensity: 1.3, color: 0xffffff },
      hemi: { intensity: 0.75, sky: 0xfff4d2, ground: 0x201810 },
      key: { intensity: 1.6, position: [6,7,10], color: 0xffffff },
      accent: { intensity: 1.1, position: [-6,-4,5], color: 0xfff4d2 },
      rim: { intensity: 0.9, position: [-3,5,-4], color: 0xfff6e0 },
      fill: { intensity: 0.75, position: [0,2,-8], color: 0xfff0d8 },
      front: { intensity: 0.65, position: [0,-1,6], color: 0xfff4d2 }
    }
  },
  spotlight: {
    exposure: 2.05,
    lights: {
      ambient: { intensity: 0.85, color: 0xfdf2d1 },
      hemi: { intensity: 0.55, sky: 0xffe9c0, ground: 0x120a06 },
      key: { intensity: 2.2, position: [4,8,6], color: 0xffffff },
      accent: { intensity: 0.9, position: [-8,-2,6], color: 0xffd8a2 },
      rim: { intensity: 1.1, position: [-2,5,-5], color: 0xfff7da },
      fill: { intensity: 0.6, position: [0,1,-6], color: 0xf8dcb2 },
      front: { intensity: 0.85, position: [0,-0.5,5.2], color: 0xfff4d2 }
    }
  },
  twilight: {
    exposure: 1.55,
    lights: {
      ambient: { intensity: 0.95, color: 0xe6d0ff },
      hemi: { intensity: 0.65, sky: 0xf4d7ff, ground: 0x130b1c },
      key: { intensity: 1.4, position: [5,6,9], color: 0xf9e6ff },
      accent: { intensity: 1.0, position: [-6,-3,4], color: 0xdac8ff },
      rim: { intensity: 0.9, position: [-3,4,-6], color: 0xf5ddff },
      fill: { intensity: 0.7, position: [0,1.5,-7], color: 0xd7c5ff },
      front: { intensity: 0.55, position: [0,-1,5.5], color: 0xeed8ff }
    }
  }
};

// Debug HUD (load status + size)
const msg = document.createElement('div');
msg.className = 'stlStatus';
container.appendChild(msg);

function setStatus(key, vars){
  if(msg) msg.textContent = t(key, vars);
}

const loader = new STLLoader();
const exporter = new STLExporter();
const geometryCache = new Map();
const metricsCache = new WeakMap();

let renderer, scene, camera, controls;
let currentObject = null;
let activeMaterials = [];
let wire = false;
let loadToken = 0;
let lastLayout = null;
let stageHeight = typeof STAGE_H !== 'undefined' ? STAGE_H : 320;
let lastFitDistance = 12;
const lights = {};

window.__update3DAssembly = handleLayoutUpdate;
if(window.__bracelet3DLayout){
  handleLayoutUpdate(window.__bracelet3DLayout);
}

init();
loadCurrent();

sel.addEventListener('change', loadCurrent);
auto.addEventListener('change', ()=> controls.autoRotate = auto.checked);
btnDownload.addEventListener('click', downloadCurrent);
window.addEventListener('resize', resize3D);
// let non-module switcher force-resize when tab opens
window.__resize3D = resize3D;
window.__setLightingPreset = applyLightingPreset;
window.__goToBookmark = goToBookmark;

function updateViewerTheme(){
  if(!scene) return;
  const styles = getComputedStyle(document.documentElement);
  const bg = (styles.getPropertyValue('--bg2') || '').trim() || '#0f0b06';
  let bgColor;
  try{ bgColor = new THREE.Color(bg); }
  catch(_){ bgColor = new THREE.Color(0x0f0b06); }
  scene.background = bgColor;
  if(renderer){ renderer.setClearColor(bgColor, 1); }

  const accent = (styles.getPropertyValue('--gold') || '').trim() || '#d4af37';
  activeMaterials.forEach(mat=> mat.color.set(accent));

  if(msg){
    const hudBg = (styles.getPropertyValue('--hud-bg') || '').trim() || 'rgba(21,15,8,.72)';
    const hudBorder = (styles.getPropertyValue('--hud-border') || '').trim() || 'rgba(212,175,55,.2)';
    const hudText = (styles.getPropertyValue('--hud-text') || '').trim() || '#fff7e6';
    msg.style.backgroundColor = hudBg;
    msg.style.borderColor = hudBorder;
    msg.style.color = hudText;
  }
}

window.__update3DTheme = updateViewerTheme;

function init(){
  scene = new THREE.Scene();

  camera = new THREE.PerspectiveCamera(40, 1, 0.01, 5000);
  camera.position.set(0, 0, 10);

  renderer = new THREE.WebGLRenderer({canvas, antialias:true});
  renderer.setPixelRatio(window.devicePixelRatio || 1);
  renderer.outputColorSpace = THREE.SRGBColorSpace;
  renderer.toneMapping = THREE.ACESFilmicToneMapping;
  renderer.toneMappingExposure = 1.75;

  controls = new OrbitControls(camera, renderer.domElement);
  controls.enableDamping = true;
  controls.dampingFactor = 0.05;
  controls.autoRotate = auto.checked;
  controls.autoRotateSpeed = 1.2;

  // lights
  const ambient = new THREE.AmbientLight(0xffffff, 1.35); scene.add(ambient);
  const hemi = new THREE.HemisphereLight(0xfff4d2, 0x201810, 0.75); scene.add(hemi);
  const d1 = new THREE.DirectionalLight(0xffffff, 1.6); d1.position.set(6,7,10); scene.add(d1);
  const d2 = new THREE.DirectionalLight(0xfff4d2, 1.1); d2.position.set(-6,-4,5); scene.add(d2);
  const rim = new THREE.DirectionalLight(0xfff6e0, 0.9); rim.position.set(-3, 5, -4); scene.add(rim);
  const fill = new THREE.DirectionalLight(0xfff0d8, 0.75); fill.position.set(0, 2, -8); scene.add(fill);
  const frontFill = new THREE.PointLight(0xfff4d2, 0.65, 22);
  frontFill.position.set(0, -1, 6);
  scene.add(frontFill);

  lights.ambient = ambient;
  lights.hemi = hemi;
  lights.key = d1;
  lights.accent = d2;
  lights.rim = rim;
  lights.fill = fill;
  lights.front = frontFill;

  // press "W" to toggle wireframe (debug)
  window.addEventListener('keydown', e=>{
    if(e.key.toLowerCase()==='w'){
      wire = !wire;
      activeMaterials.forEach(mat=> mat.wireframe = wire);
    }
  });

  resize3D();
  updateViewerTheme();
  applyLightingPreset(lightingSelect?.value || 'gallery');
  animate();
}

function resize3D(){
  const r = container.getBoundingClientRect();
  const w = Math.max(200, r.width);
  const h = Math.max(300, r.height);
  camera.aspect = w/h;
  camera.updateProjectionMatrix();
  renderer.setSize(w, h, false);
}

function applyLightingPreset(id){
  const preset = LIGHTING_PRESETS[id] || LIGHTING_PRESETS.gallery;
  if(!preset || !renderer) return;
  if(typeof preset.exposure === 'number') renderer.toneMappingExposure = preset.exposure;

  const cfg = preset.lights || {};
  if(lights.ambient){
    if(typeof cfg.ambient?.intensity === 'number') lights.ambient.intensity = cfg.ambient.intensity;
    if(cfg.ambient?.color) lights.ambient.color.setHex(cfg.ambient.color);
  }
  if(lights.hemi){
    if(typeof cfg.hemi?.intensity === 'number') lights.hemi.intensity = cfg.hemi.intensity;
    if(cfg.hemi?.sky) lights.hemi.color.setHex(cfg.hemi.sky);
    if(cfg.hemi?.ground) lights.hemi.groundColor.setHex(cfg.hemi.ground);
  }
  if(lights.key){
    if(typeof cfg.key?.intensity === 'number') lights.key.intensity = cfg.key.intensity;
    if(cfg.key?.position) lights.key.position.set(...cfg.key.position);
    if(cfg.key?.color) lights.key.color.setHex(cfg.key.color);
  }
  if(lights.accent){
    if(typeof cfg.accent?.intensity === 'number') lights.accent.intensity = cfg.accent.intensity;
    if(cfg.accent?.position) lights.accent.position.set(...cfg.accent.position);
    if(cfg.accent?.color) lights.accent.color.setHex(cfg.accent.color);
  }
  if(lights.rim){
    if(typeof cfg.rim?.intensity === 'number') lights.rim.intensity = cfg.rim.intensity;
    if(cfg.rim?.position) lights.rim.position.set(...cfg.rim.position);
    if(cfg.rim?.color) lights.rim.color.setHex(cfg.rim.color);
  }
  if(lights.fill){
    if(typeof cfg.fill?.intensity === 'number') lights.fill.intensity = cfg.fill.intensity;
    if(cfg.fill?.position) lights.fill.position.set(...cfg.fill.position);
    if(cfg.fill?.color) lights.fill.color.setHex(cfg.fill.color);
  }
  if(lights.front){
    if(typeof cfg.front?.intensity === 'number') lights.front.intensity = cfg.front.intensity;
    if(cfg.front?.position) lights.front.position.set(...cfg.front.position);
    if(cfg.front?.color) lights.front.color.setHex(cfg.front.color);
  }
}

function goToBookmark(id){
  if(!camera || !controls) return;
  const dist = Math.max(4, lastFitDistance || 10);
  const target = new THREE.Vector3(0,0,0);
  let position;
  switch(id){
    case 'threeQuarter':
      position = new THREE.Vector3(dist * 0.9, dist * 0.35, dist * 0.7);
      camera.up.set(0,1,0);
      break;
    case 'top':
      position = new THREE.Vector3(0, dist, 0.01);
      camera.up.set(0,0,-1);
      break;
    case 'front':
    default:
      position = new THREE.Vector3(0, dist * 0.1, dist);
      camera.up.set(0,1,0);
      break;
  }
  camera.position.copy(position);
  controls.target.copy(target);
  controls.update();
}

async function loadCurrent(){
  const token = ++loadToken;
  controls.autoRotate = auto.checked;
  if(sel.value === '__assembly__'){
    await loadAssembly(token);
  }else{
    await loadSingle(sel.value, token);
  }
}

async function loadSingle(raw, token){
  try{
    setStatus('builder.stl.loading', { source: raw });
    const geom = await loadGeometry(raw);
    if(token !== loadToken) return;

    clearCurrentObject();
    const mat = createMaterial();
    const mesh = new THREE.Mesh(geom, mat);
    currentObject = mesh;
    scene.add(mesh);
    fitToView(mesh);

    updateViewerTheme();

    const box = new THREE.Box3().setFromObject(mesh);
    const sz  = new THREE.Vector3(); box.getSize(sz);
    setStatus('builder.stl.loaded', { x: sz.x.toFixed(2), y: sz.y.toFixed(2), z: sz.z.toFixed(2) });
  }catch(err){
    if(token !== loadToken) return;
    console.error('STL load failed:', err);
    setStatus('builder.stl.loadFail');
  }
}

async function loadAssembly(token){
  const layout = lastLayout || window.__bracelet3DLayout;
  if(!layout || !Array.isArray(layout.items) || layout.items.length===0){
    clearCurrentObject();
    setStatus('builder.stl.notReady');
    return;
  }

  stageHeight = layout.stage?.height ?? stageHeight;
  const items = layout.items.filter(item=> item?.pack?.stl);
  if(items.length===0){
    clearCurrentObject();
    setStatus('builder.stl.noParts');
    return;
  }

  setStatus('builder.stl.building');

  try{
    const paths = [...new Set(items.map(item=> item.pack.stl))];
    await Promise.all(paths.map(path=> loadGeometry(path)));
  }catch(err){
    if(token !== loadToken) return;
    console.error('Assembly STL load failed:', err);
    setStatus('builder.stl.assemblyFail');
    return;
  }
  if(token !== loadToken) return;

  clearCurrentObject();
  const group = new THREE.Group();
  activeMaterials = [];

  for(const item of items){
    const geom = await loadGeometry(item.pack.stl);
    if(token !== loadToken) return;
    const metrics = getMetrics(geom);
    const scale = computeScale(item.pack, metrics);
    const mat = createMaterial();
    const mesh = new THREE.Mesh(geom, mat);
    mesh.scale.set(scale, scale, scale);
    const transform = computeTransform(item, metrics, scale);
    mesh.position.copy(transform.position);
    mesh.rotation.set(0, 0, transform.rotation);
    group.add(mesh);
  }

  if(!group.children.length){
    setStatus('builder.stl.noMeshes');
    return;
  }

  const bbox = new THREE.Box3().setFromObject(group);
  const center = new THREE.Vector3(); bbox.getCenter(center);
  group.position.set(-center.x, -center.y, -center.z);

  scene.add(group);
  currentObject = group;
  fitToView(group);
  updateViewerTheme();

  const sz = new THREE.Vector3(); bbox.getSize(sz);
  setStatus('builder.stl.assemblyLoaded', { x: sz.x.toFixed(2), y: sz.y.toFixed(2), z: sz.z.toFixed(2) });
}

function computeScale(pack, metrics){
  const size = metrics.size;
  if(pack?.height && size.y > 1e-6){
    return pack.height / size.y;
  }
  if(pack?.width && size.x > 1e-6){
    return pack.width / size.x;
  }
  return 1;
}

function rotateAroundZ(vec, angle){
  if(!vec) return null;
  const c = Math.cos(angle), s = Math.sin(angle);
  return new THREE.Vector3(
    vec.x * c - vec.y * s,
    vec.x * s + vec.y * c,
    vec.z
  );
}

function computeTransform(item, metrics, scale){
  const pack = item.pack || {};
  const pins = item.pins || {};
  const ratioL = pack.pinRatios?.L;
  const ratioR = pack.pinRatios?.R;

  const localL = ratioL ? ratioToLocal(ratioL, metrics).multiplyScalar(scale) : null;
  const localR = ratioR ? ratioToLocal(ratioR, metrics).multiplyScalar(scale) : null;

  const fallback = fallbackPoint(item, pack);
  const targetL = pins.L ? to3DPoint(pins.L) : to3DPoint(fallback);
  const targetR = pins.R ? to3DPoint(pins.R) : (pins.L ? to3DPoint(pins.L) : to3DPoint(fallback));

  const baseRotation = (Number.isFinite(pack.rotation) ? pack.rotation : 0) * Math.PI/180;
  let rotation = baseRotation;

  if(localL && localR && pins.L && pins.R){
    const localVec = localR.clone().sub(localL);
    const orientedLocalVec = rotateAroundZ(localVec, baseRotation) || localVec;
    const worldVec = targetR.clone().sub(targetL);
    if(orientedLocalVec.lengthSq() > 1e-6 && worldVec.lengthSq() > 1e-6){
      const a = Math.atan2(worldVec.y, worldVec.x);
      const b = Math.atan2(orientedLocalVec.y, orientedLocalVec.x);
      rotation = baseRotation + (a - b);
    }
  }

  const candidates = [];
  if(localL){
    const rotated = rotateAroundZ(localL, rotation);
    candidates.push(targetL.clone().sub(rotated));
  }
  if(localR){
    const rotated = rotateAroundZ(localR, rotation);
    candidates.push(targetR.clone().sub(rotated));
  }

  if(!candidates.length){
    const fallbackTarget = to3DPoint(fallback);
    const center = metrics.box.getCenter(new THREE.Vector3()).multiplyScalar(scale);
    const rotatedCenter = rotateAroundZ(center, rotation) || center;
    candidates.push(fallbackTarget.sub(rotatedCenter));
  }

  const position = candidates.reduce((acc, vec)=> acc.add(vec), new THREE.Vector3()).multiplyScalar(1 / candidates.length);
  return { position, rotation };
}

function ratioToLocal(ratio, metrics){
  const { box, size } = metrics;
  const clamp = (v)=> Math.min(Math.max(v ?? 0.5, 0), 1);
  const rx = clamp(ratio?.x);
  const ry = clamp(ratio?.y);
  const rz = clamp(ratio?.z);
  const invertedY = 1 - ry;
  return new THREE.Vector3(
    box.min.x + size.x * rx,
    box.min.y + size.y * invertedY,
    box.min.z + size.z * rz
  );
}

function fallbackPoint(item, pack){
  const w = pack?.width ?? 0;
  const h = pack?.height ?? 0;
  const tx = item?.tx ?? 0;
  const ty = item?.ty ?? 0;
  return { x: tx + w/2, y: ty + h/2 };
}

function to3DPoint(pt){
  const x = typeof pt?.x === 'number' ? pt.x : 0;
  const y = typeof pt?.y === 'number' ? pt.y : 0;
  return new THREE.Vector3(x, (stageHeight/2) - y, 0);
}

async function loadGeometry(rawPath){
  if(!rawPath) return null;
  if(geometryCache.has(rawPath)) return geometryCache.get(rawPath);
  const url = rawPath.replace(/ /g, '%20');
  const promise = loader.loadAsync(url).then(geom=>{
    geom.computeVertexNormals();
    return geom;
  }).catch(err=>{
    geometryCache.delete(rawPath);
    throw err;
  });
  geometryCache.set(rawPath, promise);
  return promise;
}

function getMetrics(geom){
  if(metricsCache.has(geom)) return metricsCache.get(geom);
  if(!geom.boundingBox) geom.computeBoundingBox();
  const box = geom.boundingBox.clone();
  const size = new THREE.Vector3(); box.getSize(size);
  const metrics = { box, size };
  metricsCache.set(geom, metrics);
  return metrics;
}

function createMaterial(){
  const mat = new THREE.MeshPhysicalMaterial({
    color: 0xd4af37,
    metalness: 1,
    roughness: 0.25,
    reflectivity: 1,
    clearcoat: 0.5,
    clearcoatRoughness: 0.3,
    side: THREE.DoubleSide,
    wireframe: wire
  });
  activeMaterials.push(mat);
  return mat;
}

function clearCurrentObject(){
  if(!currentObject) return;
  if(currentObject.traverse){
    currentObject.traverse(node=>{
      if(node.isMesh && node.material?.dispose){
        node.material.dispose();
      }
    });
  }else if(currentObject.isMesh && currentObject.material?.dispose){
    currentObject.material.dispose();
  }
  scene.remove(currentObject);
  currentObject = null;
  activeMaterials = [];
}

function fitToView(obj){
  const box = new THREE.Box3().setFromObject(obj);
  const center = new THREE.Vector3(); box.getCenter(center);
  obj.position.sub(center);
  controls.target.set(0,0,0);

  const size = new THREE.Vector3(); box.getSize(size);
  let maxDim = Math.max(size.x || 0, size.y || 0, size.z || 0);
  if(!isFinite(maxDim) || maxDim <= 1e-6) maxDim = 50; // fallback for tiny/flat models

  const fov = camera.fov * (Math.PI/180);
  let dist = maxDim / (2 * Math.tan(fov/2));
  dist *= 1.6;
  lastFitDistance = dist;
  camera.up.set(0,1,0);
  camera.position.set(dist, dist*0.2, dist);
  camera.lookAt(0,0,0);
  controls.update();
}

function animate(){
  requestAnimationFrame(animate);
  controls.update();
  renderer.render(scene, camera);
}

function downloadCurrent(){
  if(!currentObject){
    setStatus('builder.stl.nothingToExport');
    return;
  }
  try{
    const data = exporter.parse(currentObject, {binary:true});
    const blob = new Blob([data], {type:'model/stl'});
    const name = makeFileName(sel.value);
    triggerDownload(blob, name);
    setStatus('builder.stl.downloadStarted');
  }catch(err){
    console.error('STL export failed:', err);
    setStatus('builder.stl.exportFail');
  }
}

function triggerDownload(blob, name){
  const url = URL.createObjectURL(blob);
  const link = document.createElement('a');
  link.href = url;
  link.download = name;
  document.body.appendChild(link);
  link.click();
  link.remove();
  setTimeout(()=> URL.revokeObjectURL(url), 4000);
}

function makeFileName(raw){
  if(raw === '__assembly__') return 'bracelet-assembly.stl';
  const base = (raw.split('/').pop() || 'model.stl').trim();
  const safe = base.replace(/\s+/g,'-').toLowerCase();
  return safe.endsWith('.stl') ? safe : `${safe}.stl`;
}

function handleLayoutUpdate(layout){
  lastLayout = layout;
  if(layout?.stage?.height) stageHeight = layout.stage.height;
  if(sel.value === '__assembly__' && controls){
    loadCurrent();
  }
}
</script>
<script>
(function(){
  const KEY = window.__HCJ_THEME_KEY || 'hcj-theme';
  const THEMES = ['light','dark','plum','custom'];
  const top = document.getElementById('themeSelectTop');
  const inner = document.getElementById('themeSelect');
  function applyTopTheme(t){
    const next = THEMES.includes(t) ? t : 'light';
    if(typeof window.applyTheme === 'function'){
      window.applyTheme(next);
    }else{
      document.documentElement.dataset.theme = next;
    }
    try{ localStorage.setItem(KEY,next);}catch(_){ }
    if(inner && inner !== top) inner.value = next;
    return next;
  }
  let saved = 'light';
  try{ saved = localStorage.getItem(KEY) || document.documentElement.dataset.theme || 'light'; }catch(_){ }
  applyTopTheme(saved);
  if(top){
    top.value = saved;
    top.addEventListener('change', e => applyTopTheme(e.target.value));
  }
})();
</script>
<script>
/* ===== Minimal i18n engine (shared) ===== */
(function () {
  const LANG_KEY = 'hcj-lang';
  const langSelect = document.getElementById('langSelectTop');

  function translate(key, vars){
    const lang = document.documentElement.lang || 'en';
    const dict = window.__TRANSLATIONS?.[lang] || {};
    const fallback = window.__TRANSLATIONS?.en || {};
    let value = dict[key];
    if(value == null) value = fallback[key];
    if(value == null) value = '';
    if(typeof value === 'string' && vars && typeof vars === 'object'){
      value = value.replace(/\{\{(\w+)\}\}/g, (_, name) => (vars[name] ?? ''));
    }
    return value;
  }

  function t(key, vars){
    return translate(key, vars);
  }

  function applyDir(lang){
    document.documentElement.lang = lang;
    document.documentElement.dir = (lang === 'ar') ? 'rtl' : 'ltr';
  }

  function translateDOM(){
    document.querySelectorAll('[data-i18n]').forEach(el => {
      const key = el.getAttribute('data-i18n');
      const txt = t(key);
      if (txt) el.textContent = txt;
    });
    document.querySelectorAll('[data-i18n-attr]').forEach(el => {
      const map = el.getAttribute('data-i18n-attr').split(';').map(s=>s.trim()).filter(Boolean);
      map.forEach(pair=>{
        const [attr, key] = pair.split(':').map(s=>s.trim());
        const val = t(key);
        if(attr && val) el.setAttribute(attr, val);
      });
    });
  }

  function setLang(lang){
    applyDir(lang);
    try { localStorage.setItem(LANG_KEY, lang); } catch(e) {}
    translateDOM();
    window.dispatchEvent(new CustomEvent('hcj:lang', { detail: { lang } }));
  }

  let saved = 'en';
  try { saved = localStorage.getItem(LANG_KEY) || 'en'; } catch(e) {}
  applyDir(saved);

  if(langSelect){
    langSelect.value = saved;
    langSelect.addEventListener('change', e => setLang(e.target.value));
  }
  window.addEventListener('DOMContentLoaded', translateDOM);
})();
</script>
</body>
</html>
