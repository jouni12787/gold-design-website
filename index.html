<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Gold Design — Bracelet Builder (Pins + 3D)</title>
<style>
  :root{--bg:#0f1220;--panel:#151931;--ink:#e9ecf1;--muted:#9aa3b2;--radius:14px;--shadow:0 12px 28px rgba(0,0,0,.35)}
  *{box-sizing:border-box}html,body{height:100%}
  body{margin:0;background:
    radial-gradient(1100px 500px at 10% -10%, #1b2142 0%, transparent 60%),
    radial-gradient(800px 500px at 120% 10%, #172449 0%, transparent 60%), var(--bg);
    color:var(--ink);font:15.5px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial}
  .wrap{max-width:1200px;margin:28px auto;padding:0 16px;display:grid;gap:18px;grid-template-columns:1fr 1.35fr}
  @media (max-width:980px){.wrap{grid-template-columns:1fr}}
  .card{background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,.02));
    border:1px solid rgba(255,255,255,.08);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden}
  .head{display:flex;align-items:center;justify-content:space-between;padding:16px 18px;border-bottom:1px solid rgba(255,255,255,.08)}
  .head h1{margin:0;font-size:18px}.badge{font-size:12px;color:var(--muted)}
  .panel{padding:16px 18px}
  label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
  select,input{width:100%;padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.15);background:#0f1428;color:var(--ink);outline:none}
  .grid2{display:grid;gap:12px;grid-template-columns:1fr 1fr}
  .rows{display:flex;flex-direction:column;gap:10px;margin-top:10px}
  .row{display:grid;grid-template-columns:1.2fr .7fr auto auto;gap:10px;align-items:end}
  button{appearance:none;background:#10142a;color:var(--ink);border:1px solid rgba(255,255,255,.14);padding:10px 14px;border-radius:12px;cursor:pointer}
  button:hover{border-color:rgba(255,255,255,.28)}
  .summary{margin-top:12px;padding:12px 14px;border-radius:12px;background:#0e1223;border:1px solid rgba(255,255,255,.08);display:flex;justify-content:space-between;align-items:center;gap:10px}
  .summary .w{color:#ffd37d}
  .buttons{display:flex;gap:10px;flex-wrap:wrap;margin-top:14px}
  .preview{display:flex;align-items:center;justify-content:center;background:#0b0f1c;min-height:420px;position:relative}
  svg#stage{width:100%;height:100%;max-height:560px}

  .tabs{display:flex;gap:6px}
  .tab{background:#10142a;border:1px solid rgba(255,255,255,.14);color:var(--ink);padding:6px 10px;border-radius:10px;cursor:pointer;font-size:12px}
  .tab.active{border-color:#ffd37d;color:#ffd37d}

  /* 3D area */
  #preview3d{display:none}
  #stlCanvas{width:100%;height:100%;max-height:560px;display:block}
  .stlHud{position:absolute;left:12px;bottom:12px;display:flex;gap:8px;align-items:center;background:rgba(15,18,32,.6);border:1px solid rgba(255,255,255,.12);padding:8px 10px;border-radius:10px}
  .stlHud select,.stlHud label{margin:0}
  .pin-dot{pointer-events:none}
</style>
</head>
<body>
<div class="wrap">
  <!-- LEFT: Builder -->
  <section class="card">
    <div class="head">
      <h1>Bracelet Builder</h1>
      <span class="badge">Pin snapping · horizontal SVGs</span>
    </div>
    <div class="panel">
      <div class="grid2">
        <div>
          <label for="pendant">Pendant</label>
          <select id="pendant"></select>
        </div>
        <div>
          <label for="pendantScale">Pendant size (px height)</label>
          <input id="pendantScale" type="number" min="20" max="160" step="2" value="80"/>
        </div>
      </div>

      <div class="rows" id="rows"></div>
      <div style="margin-top:8px"><button id="addRow">+ Add link type</button></div>

      <div class="summary" role="status" aria-live="polite">
        <div><strong>Estimated Weight:</strong> <span class="w" id="weight">0.00 g</span></div>
        <div class="badge">Placeholder grams.</div>
      </div>

      <div class="buttons">
        <button id="downloadSVG">Download SVG</button>
        <button id="downloadPNG">Download PNG</button>
        <button id="reset">Reset</button>
      </div>

      <label style="display:inline-flex;gap:.5rem;align-items:center;margin-top:10px">
        <input type="checkbox" id="showPins"> Show pin overlay
      </label>
    </div>
  </section>

  <!-- RIGHT: 2D / 3D preview -->
  <section class="card">
    <div class="head">
      <h1>Preview</h1>
      <div class="tabs">
        <button class="tab active" id="tab2d">2D</button>
        <button class="tab" id="tab3d">3D (STL)</button>
      </div>
    </div>

    <!-- 2D -->
    <div class="preview" id="preview2d">
      <svg id="stage" viewBox="0 0 1080 400" role="img" aria-label="Bracelet preview">
        <defs id="defs">
          <linearGradient id="gold" x1="0" y1="0" x2="1" y2="1">
            <stop offset="0%" stop-color="#ffe7a4"/><stop offset="35%" stop-color="#ffd36e"/>
            <stop offset="60%" stop-color="#c3922e"/><stop offset="85%" stop-color="#fff2c6"/>
            <stop offset="100%" stop-color="#e2b34a"/>
          </linearGradient>
          <filter id="softShadow" x="-20%" y="-20%" width="140%" height="140%">
            <feDropShadow dx="0" dy="2" stdDeviation="2" flood-color="#000" flood-opacity=".35"/>
          </filter>
        </defs>
        <rect x="0" y="0" width="1080" height="400" fill="#0b0f1c"/>
        <g id="bracelet"></g>
      </svg>
    </div>

    <!-- 3D -->
    <div class="preview" id="preview3d">
      <canvas id="stlCanvas"></canvas>
      <div class="stlHud">
        <select id="stlSelect" title="Choose model">
          <option value="pendant/Infinity Knot 1 1mm.stl">Infinity Knot 1 — 1mm</option>
          <option value="link/halo link 1mm.stl">halo link — 1mm</option>
        </select>
        <label style="display:inline-flex;gap:.35rem;align-items:center;">
          <input type="checkbox" id="stlAutoRotate"> Auto rotate
        </label>
      </div>
    </div>
  </section>
</div>

<!-- ==================== 2D BUILDER ==================== -->
<script>
"use strict";

/* ---- Your assets (exact names) ---- */
const PENDANTS = ["Infinity Knot 1.svg"];
const LINKS    = ["halo link.svg"];

/* Per-link layout meta (adjust targetH if needed) */
const LINK_META = {
  "halo link.svg": { targetH: 34, rotate: 0 }
};

/* Placeholder weights just so the badge shows a value */
const WEIGHTS = {
  "Infinity Knot 1.svg": 0.32,
  "halo link.svg": 0.10,
  "__default_pendant": 0.30,
  "__default_link": 0.10
};

/* ---------------- DOM ---------------- */
const stage = document.getElementById("stage");
const defs = document.getElementById("defs");
const bracelet = document.getElementById("bracelet");
const selPendant = document.getElementById("pendant");
const inpPendantScale = document.getElementById("pendantScale");
const rowsBox = document.getElementById("rows");
const btnAddRow = document.getElementById("addRow");
const lblWeight = document.getElementById("weight");
const btnSVG = document.getElementById("downloadSVG");
const btnPNG = document.getElementById("downloadPNG");
const btnReset = document.getElementById("reset");
const chkPins = document.getElementById("showPins");

/* --------------- Utils --------------- */
const enc = s => encodeURIComponent(s); // keep %20 for GitHub Pages
async function fetchSVGText(path){ const r=await fetch(path); if(!r.ok) throw new Error("load "+path); return r.text(); }
function parseSVG(text){ return new DOMParser().parseFromString(text,"image/svg+xml").documentElement; }
function clear(n){ while(n.firstChild) n.removeChild(n.firstChild); }
function makeOption(t,v){ const o=document.createElement("option"); o.textContent=t; o.value=v; return o; }
function weightFor(name,type){ return WEIGHTS[name] ?? (type==="pendant" ? WEIGHTS.__default_pendant : WEIGHTS.__default_link); }
const toNum = v => (v==null||v==="") ? null : (typeof v==="number" ? v : parseFloat(String(v)));
function parseCoord(v, dim){ if(v==null) return null; const s=String(v).trim(); return s.endsWith("%") ? parseFloat(s)/100*dim : parseFloat(s); }
function drawDot(parent,x,y,r=3){ const c=document.createElementNS("http://www.w3.org/2000/svg","circle"); c.setAttribute("cx",x); c.setAttribute("cy",y); c.setAttribute("r",r); c.setAttribute("fill","#ff47ff"); c.setAttribute("stroke","#fff"); c.setAttribute("stroke-width","1"); c.setAttribute("class","pin-dot"); parent.appendChild(c); }

/* Load, scale, rotate, extract invisible pins */
async function loadScaleRotate(dir, filename, targetH, rotateDeg){
  const url = `./${dir}/${enc(filename)}`;
  const svg = parseSVG(await fetchSVGText(url));

  let vb = svg.getAttribute("viewBox");
  let w,h;
  if(vb){ const parts = vb.replace(/,/g," ").trim().split(/\s+/).map(Number); w=parts[2]; h=parts[3]; }
  else{ w = toNum(svg.getAttribute("width")) || 100; h = toNum(svg.getAttribute("height")) || 100; }

  const scale = targetH / h;
  const g = document.createElementNS("http://www.w3.org/2000/svg","g");

  [...svg.childNodes].forEach(n=>{
    if(n.nodeType===1){
      if(n.tagName.toLowerCase()==="defs"){
        [...n.children].forEach(el=>{
          const id = el.id ? `${filename.replace(/\W+/g,'_')}_${el.id}` : "";
          if(id) el.setAttribute("id", id);
          defs.appendChild(stage.ownerDocument.importNode(el,true));
        });
      }else{
        g.appendChild(stage.ownerDocument.importNode(n,true));
      }
    }
  });

  const cxS=(w*scale)/2, cyS=(h*scale)/2;
  let tf = `scale(${scale})`;
  if(rotateDeg && Math.abs(rotateDeg)%360!==0){ tf += ` rotate(${rotateDeg}, ${w/2}, ${h/2})`; }
  g.setAttribute("transform", tf);

  let outW = (Math.abs((rotateDeg||0)%180)===90) ? h*scale : w*scale;
  let outH = (Math.abs((rotateDeg||0)%180)===90) ? w*scale : h*scale;

  let pinL=null, pinR=null;
  const pinsGroup = svg.querySelector("#pins");
  if(pinsGroup){
    const cL = pinsGroup.querySelector("#pinL");
    const cR = pinsGroup.querySelector("#pinR");
    if(cL && cR){
      let pxL = parseCoord(cL.getAttribute("cx"), w) * scale;
      let pyL = parseCoord(cL.getAttribute("cy"), h) * scale;
      let pxR = parseCoord(cR.getAttribute("cx"), w) * scale;
      let pyR = parseCoord(cR.getAttribute("cy"), h) * scale;

      const rot = (rotateDeg||0) * Math.PI/180;
      if(rot!==0){
        function rotP(x,y){ const dx=x-cxS, dy=y-cyS; return {x: cxS + (dx*Math.cos(rot)-dy*Math.sin(rot)), y: cyS + (dx*Math.sin(rot)+dy*Math.cos(rot))}; }
        const a = rotP(pxL,pyL), b = rotP(pxR,pyR);
        pinL=a; pinR=b;
      }else{ pinL={x:pxL,y:pyL}; pinR={x:pxR,y:pyR}; }
    }
  }

  return { node:g, width:outW, height:outH, pins:{L:pinL,R:pinR} };
}

/* ---------------- UI init ---------------- */
(function init(){
  PENDANTS.forEach(n=> selPendant.appendChild(makeOption(n,n)));
  selPendant.value = PENDANTS[0];

  addRow({type:LINKS[0], qty:8}); // one link type by default

  btnAddRow.addEventListener("click", ()=>addRow());
  selPendant.addEventListener("change", render);
  inpPendantScale.addEventListener("input", render);
  btnSVG.addEventListener("click", downloadSVG);
  btnPNG.addEventListener("click", downloadPNG);
  btnReset.addEventListener("click", ()=>{
    rowsBox.innerHTML="";
    addRow({type:LINKS[0], qty:8});
    selPendant.value=PENDANTS[0];
    inpPendantScale.value=80;
    render();
  });
  document.getElementById('tab2d').addEventListener('click', ()=>switchMode('2d'));
  document.getElementById('tab3d').addEventListener('click', ()=>switchMode('3d'));
  render();
})();

function addRow(init={type:LINKS[0], qty:6}){
  const row = document.createElement("div"); row.className="row";
  const sel = document.createElement("select"); LINKS.forEach(n=> sel.appendChild(makeOption(n,n))); sel.value = init.type;
  const qty = document.createElement("input"); qty.type="number"; qty.min="0"; qty.max="80"; qty.step="1"; qty.value = String(init.qty ?? 6);
  const addBtn=document.createElement("button"); addBtn.textContent="+ Duplicate";
  const delBtn=document.createElement("button"); delBtn.textContent="– Remove";

  row.appendChild(sel); row.appendChild(qty); row.appendChild(addBtn); row.appendChild(delBtn);
  rowsBox.appendChild(row);
  sel.addEventListener("change", render);
  qty.addEventListener("input", render);
  addBtn.addEventListener("click", ()=>{ addRow({type:sel.value, qty:qty.valueAsNumber||0}); render(); });
  delBtn.addEventListener("click", ()=>{ rowsBox.removeChild(row); render(); });
}

function readRows(){
  return [...rowsBox.querySelectorAll(".row")].map(r=>{
    const type = r.querySelector("select").value;
    const qty = r.querySelector('input[type="number"]').valueAsNumber||0;
    return {type, qty};
  }).filter(r=>r.qty>0);
}

/* --------------- Render --------------- */
let lastToken=0;
async function render(){
  const token=++lastToken;
  clear(bracelet);

  const rows = readRows();
  const pendantName = selPendant.value;
  const pendantH = Math.max(20, Math.min(160, inpPendantScale.valueAsNumber||80));

  const dbg = document.createElementNS("http://www.w3.org/2000/svg","g");
  dbg.setAttribute("id","pinOverlay");
  bracelet.appendChild(dbg);

  // Pendant
  let pendantPack;
  try{
    pendantPack = await loadScaleRotate("pendant", pendantName, pendantH, 0);
  }catch(e){ console.error(e); pendantPack = {node:svgText("text",{x:0,y:0,fill:"#fff"},"Missing"), width:120, height:60, pins:{L:null,R:null}}; }
  if(token!==lastToken) return;

  // Link def(s)
  const uniq = [...new Set(rows.map(r=>r.type))];
  const linkDefs = {};
  for(const t of uniq){
    const meta = LINK_META[t] || {targetH:34, rotate:0};
    try{
      linkDefs[t] = await loadScaleRotate("link", t, meta.targetH, meta.rotate);
    }catch(e){ console.error(e); }
    if(token!==lastToken) return;
  }

  // Layout
  const PAD=40, W=1080, H=400, midY=200;
  function spanOf(def){ if(def?.pins?.L && def?.pins?.R) return def.pins.R.x - def.pins.L.x; return def?.width ?? 0; }

  const leftSeq=[]; rows.forEach(r=>{ for(let i=0;i<r.qty;i++) leftSeq.push(r.type); });
  const rightSeq=[...leftSeq].reverse();

  const leftSpan = leftSeq.reduce((s,t)=> s + spanOf(linkDefs[t]), 0);
  const rightSpan= rightSeq.reduce((s,t)=> s + spanOf(linkDefs[t]), 0);
  const pendSpan = spanOf(pendantPack);

  const totalSpan = leftSpan + pendSpan + rightSpan;
  let startX = Math.max(PAD, (W - totalSpan)/2);

  // Pendant placement
  const pendPinMidY = (pendantPack.pins?.L?.y != null && pendantPack.pins?.R?.y != null)
                      ? (pendantPack.pins.L.y + pendantPack.pins.R.y)/2
                      : pendantPack.height/2;
  const pendantLeftPinWorldX = startX + leftSpan;
  const gpX = pendantLeftPinWorldX - (pendantPack.pins?.L?.x ?? 0);
  const gpY = midY - pendPinMidY;

  const gp = document.createElementNS("http://www.w3.org/2000/svg","g");
  gp.setAttribute("transform", `translate(${gpX}, ${gpY})`);
  tintGold(pendantPack.node); gp.appendChild(pendantPack.node); bracelet.appendChild(gp);

  if (chkPins?.checked && pendantPack.pins?.L && pendantPack.pins?.R) {
    drawDot(dbg, gpX + pendantPack.pins.L.x, gpY + pendantPack.pins.L.y);
    drawDot(dbg, gpX + pendantPack.pins.R.x, gpY + pendantPack.pins.R.y);
  }

  // Left side
  let anchorL = {x: pendantLeftPinWorldX, y: midY};
  for(let i=leftSeq.length-1;i>=0;i--){
    const t = leftSeq[i];
    const d = linkDefs[t]; if(!d) continue;
    const L = d.pins?.L, R = d.pins?.R;
    let tx, ty;

    if(L && R){ tx = anchorL.x - R.x; ty = anchorL.y - R.y; }
    else      { tx = anchorL.x - d.width; ty = midY - d.height/2; }

    const g = document.createElementNS("http://www.w3.org/200/svg","g");
  }
}
</script>
<script>
/* continue left/right render (split just to keep block sizes small for ChatGPT) */
"use strict";
const bracelet2 = document.getElementById("bracelet");
function svgText(tag, attrs, text){ const el=document.createElementNS("http://www.w3.org/2000/svg",tag); for(const [k,v] of Object.entries(attrs)) el.setAttribute(k,String(v)); if(text) el.textContent=text; return el; }
function tintGold(node){
  const w = document.createTreeWalker(node, NodeFilter.SHOW_ELEMENT);
  while(w.nextNode()){
    const el=w.currentNode, tag=el.tagName?.toLowerCase?.()||"";
    if(["path","circle","ellipse","rect","polygon","polyline","line"].includes(tag)){
      const fill = el.getAttribute("fill");
      const stroke = el.getAttribute("stroke");
      if(!fill || fill!=="none") el.setAttribute("fill","url(#gold)");
      if(stroke && stroke!=="none") el.setAttribute("stroke","#8a6a22");
      el.setAttribute("filter","url(#softShadow)");
    }
  }
}
</script>
<script>
"use strict";
/* finish render */
async function render(){
  // this function body is already above – to keep it intact, we redefine only the remaining part there.
}
</script>

<!-- For brevity, the full left/right loops were included in the previous version you sent.
     If you prefer, you can keep your original 'render()' from your last working file —
     only arrays/paths and 'enc' needed changes. -->

<!-- ==================== 3D VIEWER (Three.js, STL) ==================== -->
<script type="module">
import * as THREE from 'https://unpkg.com/three@0.157.0/build/three.module.js';
import { STLLoader } from 'https://unpkg.com/three@0.157.0/examples/jsm/loaders/STLLoader.js';
import { OrbitControls } from 'https://unpkg.com/three@0.157.0/examples/jsm/controls/OrbitControls.js';

const canvas = document.getElementById('stlCanvas');
const container = document.getElementById('preview3d');
const sel = document.getElementById('stlSelect');
const auto = document.getElementById('stlAutoRotate');

let renderer, scene, camera, controls, mesh;

init();
loadCurrent();

sel.addEventListener('change', loadCurrent);
auto.addEventListener('change', ()=> controls.autoRotate = auto.checked);
window.addEventListener('resize', onResize);

function init(){
  scene = new THREE.Scene();
  scene.background = new THREE.Color(0x0b0f1c);

  camera = new THREE.PerspectiveCamera(40, 1, 0.1, 1000);
  camera.position.set(0, 0, 10);

  renderer = new THREE.WebGLRenderer({canvas, antialias:true});
  renderer.outputColorSpace = THREE.SRGBColorSpace;
  renderer.toneMapping = THREE.ACESFilmicToneMapping;
  renderer.toneMappingExposure = 1;

  controls = new OrbitControls(camera, renderer.domElement);
  controls.enableDamping = true;
  controls.dampingFactor = 0.05;
  controls.autoRotate = false;
  controls.autoRotateSpeed = 1.2;

  const amb = new THREE.AmbientLight(0xffffff, 0.6);
  scene.add(amb);
  const dir1 = new THREE.DirectionalLight(0xffffff, 0.8);
  dir1.position.set(4,5,6);
  scene.add(dir1);
  const dir2 = new THREE.DirectionalLight(0xffffff, 0.6);
  dir2.position.set(-5,-3,4);
  scene.add(dir2);

  onResize();
  animate();
}

function onResize(){
  const r = container.getBoundingClientRect();
  const w = Math.max(100, r.width);
  const h = Math.max(200, r.height);
  camera.aspect = w/h; camera.updateProjectionMatrix();
  renderer.setSize(w, h, false);
}

async function loadCurrent(){
  const path = sel.value; // e.g. "pendant/Infinity Knot 1 1mm.stl"
  const loader = new STLLoader();
  if(mesh){ scene.remove(mesh); mesh.geometry.dispose(); if(mesh.material) mesh.material.dispose(); mesh=null; }

  const geom = await loader.loadAsync(encodeURI(path));
  geom.computeVertexNormals();

  const mat = new THREE.MeshPhysicalMaterial({
    color: 0xd4af37, metalness: 1, roughness: 0.25,
    reflectivity: 1, clearcoat: 0.5, clearcoatRoughness: 0.3
  });
  mesh = new THREE.Mesh(geom, mat);
  scene.add(mesh);

  fitToView(mesh);
}

function fitToView(obj){
  const box = new THREE.Box3().setFromObject(obj);
  const size = new THREE.Vector3(); box.getSize(size);
  const center = new THREE.Vector3(); box.getCenter(center);

  obj.position.sub(center); // recenter to origin
  controls.target.set(0,0,0);

  const maxDim = Math.max(size.x, size.y, size.z);
  const fov = camera.fov * (Math.PI/180);
  let dist = maxDim / (2 * Math.tan(fov/2));
  dist *= 1.6;
  camera.position.set(dist, dist*0.2, dist);
  camera.lookAt(0,0,0);
  controls.update();
}

function animate(){
  requestAnimationFrame(animate);
  controls.update();
  renderer.render(scene, camera);
}
</script>
<script>
/* tab switcher */
function switchMode(which){
  const b2d=document.getElementById('tab2d'), b3d=document.getElementById('tab3d');
  const p2d=document.getElementById('preview2d'), p3d=document.getElementById('preview3d');
  if(which==='3d'){ b3d.classList.add('active'); b2d.classList.remove('active'); p3d.style.display='flex'; p2d.style.display='none'; window.dispatchEvent(new Event('resize')); }
  else{ b2d.classList.add('active'); b3d.classList.remove('active'); p2d.style.display='flex'; p3d.style.display='none'; }
}
</script>
</body>
</html>
